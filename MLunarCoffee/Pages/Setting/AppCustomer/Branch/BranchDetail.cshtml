@page
@model MLunarCoffee.Pages.Setting.AppCustomer.Branch.BranchDetailModel
@{
    Layout = null;
}

<script>js_require('/js/comon/initialize_setting.js');</script>
<script>js_require_notasync('/js/AppCustomer/FileUpload.js', true);</script>
<div class="container-fluid px-0 ">
    <div class="row">
        <div class="col-12">
            <div class="mb-3">
                <div class="p-3 pb-0">
                    <div class="d-lg-flex">
                        <div class="w-50 col-auto my-auto">
                            <div class="h-100">
                                <h6 class="mb-0">@Local["Chi tiết chi nhánh"]</h6>
                            </div>
                        </div>
                        <div class="ms-auto my-auto mt-1">
                            <div class="ms-auto my-auto mt-1">
                                <ul class="nav nav-pills nav-fill p-1 bg-transparent d-inline-flex branchdetail" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <a class="nav-link cursor-pointer" data-bs-toggle="pill" data-bs-target="#ABD_Tab_Info" role="tab">
                                            @Local["Thông tin"]
                                        </a>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <a class="nav-link cursor-pointer" data-bs-toggle="pill" data-bs-target="#ABD_Tab_Image" role="tab">
                                            @Local["Hình ảnh"]
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-3 pt-2">
                    <div class="row px-1 form3" id="ABD_Form">
                        <div class="tab-content">
                            <div class="tab-pane fade active show" id="ABD_Tab_Info" role="tabpanel">
                                <div class="row px-1">
                                    <div class="field col-12 col-sm-6 p-1">
                                        <label>@Local["Tên chi nhánh"]</label>
                                        <input id="ABD_Name" name="branch" type="text" placeholder="eg .name" class="form-control" />
                                    </div>
                                    <div class="field col-12 col-sm-6 p-1">
                                        <label>@Local["Thời gian mở cửa"]</label>
                                        <input id="ABD_TimeOpen" type="text" name="element" class="form-control" placeholder="00:00h - 21:00h" />
                                    </div>
                                    <div class="field col-12 col-sm-6 p-1">
                                        <label>Zalo</label>
                                        <input id="ABD_Zalo" name="element" type="text" class="form-control" placeholder="eg .zalo" />
                                    </div>
                                    <div class="field col-12 col-sm-6 p-1">
                                        <label>Facebook</label>
                                        <input id="ABD_Facebook" name="element" type="text" class="form-control" placeholder="eg .facebook" />
                                    </div>
                                    <div class="field col-12 col-sm-6 p-1">
                                        <label>Messenger</label>
                                        <input id="ABD_Messenger" name="element" type="text" class="form-control" placeholder="eg .messenger" />
                                    </div>
                                    <div class="field col-12 col-sm-6 p-1">
                                        <label>@Local["Chi nhánh phần mềm"]</label>
                                        <div class="ui fluid search selection dropdown form-control" id="ABD_BranchID">
                                            <input type="hidden" name="" />
                                            <i class="dropdown icon"></i>
                                            <input id="searchConsult1" class="search" autocomplete="off" tabindex="0" />
                                            <div class="default text">eg .@Local["Chi nhánh"]</div>
                                            <div id="ccbABD_BranchID" class="menu" tabindex="-1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field  col-12 col-sm-6 p-1">
                                        <label>@Local["Địa chỉ chi nhánh"]</label>
                                        <input id="ABD_Address" type="text" placeholder="eg .address" class="form-control" />
                                    </div>
                                    <div class="field col-12 col-sm-6 p-1">
                                        <label>@Local["Vị trí"]</label>
                                        <div class="input-group mb-0">
                                            <input id="ABD_Location" type="text" placeholder="eg .Location" disabled="disabled" class="form-control" />
                                            <div class="input-group-text cursor-pointer rounded-2 px-3 border-radius-bottom-start-0 border-radius-top-start-0" onclick="event.preventDefault(); return ABD_GetLocation();" data-bs-toggle="tooltip" title="Get Location"><i class="fas fa-map-marker-alt"></i></div>
                                        </div>
                                    </div>
                                    <div class="field col-12 col-sm-6 p-1">
                                        <label>Website</label>
                                        <input id="ABD_Website" type="text" placeholder="eg .website" class="form-control" />
                                    </div>
                                    <div class="field col-12 col-sm-6 p-1">
                                        <label>@Local["Mô tả"]</label>
                                        <textarea id="ABD_Description" type="text" placeholder="eg .description" class="form-control" rows="1"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="ABD_Tab_Image" role="tabpanel">
                                <div class="mt-2">
                                    <div class="row">
                                        <div class="col-12">
                                            <!--Master-->
                                            <div class="card-body p-3 pt-2">
                                                <p id="ABD_detail_header_sub" class="text-sm mb-0 mt-n5 pt-2 ms-n4 ps-2"></p>
                                                <div class="field col-12 col-md-12 col-lg-12 p-1">
                                                    <div class="d-lg-flex mt-3 ms-1">
                                                        <div class="col-12 col-sm-3 me-3 mb-3">
                                                            <div id="ABD_uploadButton" class="card-body d-flex flex-column justify-content-center text-center  border border-radius-md ">
                                                                <i class="fa fa-plus text-secondary mb-3" aria-hidden="true"></i>
                                                                <input class="position-absolute opacity-0 cursor-pointer imputaddImgNew" type="file" id="ABD_fileuploadImgNews" accept="image/*" name="files[]" multiple />
                                                                <span class=" text-secondary text-md" id="ABD_DescriptionImage">Picture (700x300 .png,.jpg )</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-12 col-sm-9">
                                                            <div class="row" id="ABD_lightgalleryTableEdit">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>


                    </div>
                </div>
            </div>
            <div class="fixed-botombutton">
                <div class="action_Save">
                    <div class="text-danger text-gradient text-sm font-weight-bold" id="textShowMessage"></div>
                    <div class="action_Save-Content">
                        <button class="btn btn-secondary" form="ABD_Form" onclick="event.preventDefault();return ABL_Close()">@Local["Đóng"]</button>
                        <button id="BranchBtnDetail" form="ABD_Form" type="button" class="btn bg-gradient-primary mt-2 me-2 _tab_control_" data-tab="edit_tab_customer" onclick="event.preventDefault();ABD_ExcuteDetail()">@Local["Lưu"]</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    let urlImage = "/Api/Upload/Upload?Type=ClientApp";
    let ser_BranchDetailID;
    let DataBranch;
    let AppTypeImage = 'branch'
    let ImageKeySlide = 'imageslide'
    let Lon = 106.681702;
    let Lat = 10.828746;
    let ImageJson = [];
    let ImageDelete = '';
    let ImageSlide = (ser_AcceptSettingApp["AppTypeImage"] != undefined && ser_AcceptSettingApp["AppTypeImage"]["ImageKeySlide"] != undefined)
        ? ser_AcceptSettingApp[AppTypeImage][ImageKeySlide]
        : {
            size: 5000,
            width: 110,
            height: 110,
            format: ['jpg', 'png']
        };
    let ImageLimit = (ser_AcceptSettingApp["AppTypeImage"] != undefined && ser_AcceptSettingApp["AppTypeImage"]["image"] != undefined)
        ? ser_AcceptSettingApp[AppTypeImage]['limitimage'].Limit
        : 4;
    //#region //LoadData
    $(document).ready(function () {
        ABD_Init();
        Checking_TabControl_Permission();
    });

    function ABD_Init() {
        ToolPopper();
        AjaxLoad(url = "/Setting/AppCustomer/Branch/BranchDetail/?handler=Init"
            , data = {}
            , async = true
            , error = function () { notiError_SW(); }
            , success = function (result) {
                if (result != '0') {
                    let data = JSON.parse(result);
                    if (data && data.length != 0) {
                        Load_Combo(data, 'ccbABD_BranchID', true);
                        $("#ABD_BranchID").dropdown("refresh");
                        $("#ABD_BranchID").dropdown("set selected", data[0].ID);
                        ABD_Setting()
                    }
                }
                else {
                    notiError_SW();
                }
            }
            , sender = null
            , before = function (e) {}
            , complete = function (e) {}
        );
    }

    function ABD_Setting() {
        $('.branchdetail a:first').tab('show');
        ser_BranchDetailID = @Model._ABranchDetailID;
        $('#ABD_Location').val((Lat + ' x ' + Lon));
        $('#ABD_detail_header_sub').html(`@Local["Số lượng hình ảnh upload tối đa"] ${ImageLimit} @Local["Hình"]`);
        let extension = (ImageSlide.format).reduce((previous, current) => {
            return "." + previous + ",." + current
        })
        $("#ABD_DescriptionImage").html(`Picture (${ImageSlide.width}x${ImageSlide.height} ${extension} )`);
        AjaxUpload(url = urlImage, inputid = 'ABD_fileuploadImgNews'
            , success = function (data) {
                if (data != "0") {
                    UploadImage_Validate({
                        src: data,
                        condition: ImageSlide,
                        success: function () {
                            if (ImageJson.length + 1 > ImageLimit) {
                                $("#ABD_fileuploadImgNews").val(null);
                                ImageDelete = ImageDelete + ',' + data;
                                notiWarning(`@Local["Chỉ được thêm tối đa"] ${ImageLimit} @Local["Hình"]"`);
                            }
                            else {
                                let imgLink = { "Image": data };
                                $("#ABD_fileuploadImgNews").val(null);
                                ImageJson.push(imgLink);
                                ABD_EditImageGallery();
                            }
                        },
                        error: function () {
                            $("#ABD_fileuploadImgNews").val(null);
                            ImageDelete = ImageDelete + ',' + data;
                        }
                    })

                } else {
                    notiError_SW();
                }
            }
            , error = function () { notiError_SW(); }
        );
        if (ser_BranchDetailID != "0") {
            ABD_LoadDataUpdate();
        }
    }

    function ABD_LoadDataUpdate() {
        AjaxLoad(url = "/Setting/AppCustomer/Branch/BranchDetail/?handler=Loadata"
            , data = { CurrentID: ser_BranchDetailID }, async = true, error = null
            , success = function (result) {
                DataBranch = JSON.parse(result)['Table'];
                ImageJson = JSON.parse(result)['Table1'];

                Lat = DataBranch[0].Lat;
                Lon = DataBranch[0].Lon;
                $('#ABD_Name').val((DataBranch[0].BranchName));
                $('#ABD_TimeOpen').val(DataBranch[0].TimeOpen);
                $('#ABD_Zalo').val((DataBranch[0].Zalo));
                $('#ABD_Facebook').val((DataBranch[0].Facebook));
                $('#ABD_Messenger').val((DataBranch[0].Mess));
                $('#ABD_Website').val((DataBranch[0].Website));
                $('#ABD_Address').val((DataBranch[0].Address));
                $('#ABD_Description').val((DataBranch[0].Description));
                $('#ABD_Location').val((DataBranch[0].Lat) + ' x ' + (DataBranch[0].Lon));
                $("#ABD_BranchID").dropdown("refresh");
                $("#ABD_BranchID").dropdown("set selected", DataBranch[0].BranchID);
                ABD_EditImageGallery();

            });
    }
    //#endregion
    //#regin //Excute Date
    function ABD_ExcuteDetail() {
        let data = new Object();
        data.Name = $('#ABD_Name').val() ? $('#ABD_Name').val() : "";
        data.TimeOpen = $('#ABD_TimeOpen').val() ? $('#ABD_TimeOpen').val() : "";
        data.Address = $('#ABD_Address').val() ? $('#ABD_Address').val() : "";
        data.Lat = Number(Lat);
        data.Lon = Number(Lon);
        data.Zalo = $('#ABD_Zalo').val() ? $('#ABD_Zalo').val() : "";
        data.Facebook = $('#ABD_Facebook').val() ? $('#ABD_Facebook').val() : "";
        data.ImgJson = JSON.stringify(ImageJson);
        data.Mess = $('#ABD_Messenger').val() ? $('#ABD_Messenger').val() : "";
        data.Website = $('#ABD_Website').val() ? $('#ABD_Website').val() : "";
        data.Description = $('#ABD_Description').val() ? $('#ABD_Description').val() : "";
        data.MainBranchID = Number($('#ABD_BranchID').dropdown('get value')) ? Number($('#ABD_BranchID').dropdown('get value')) : 0;

        $('#ABD_Form').form('validate form');
        if ($('#ABD_Form').form('is valid')) {
            console.log(ImageJson)
            if (ImageJson && ImageJson.length > 0) {
                AjaxLoad(url = "/Setting/AppCustomer/Branch/BranchDetail/?handler=ExcuteData"
                    , data = {
                        data: JSON.stringify(data)
                        , CurrentID: ser_BranchDetailID
                        , ImageDelete: ImageDelete
                    }, async = true, error = null
                    , success = function (result) {
                        if (result == "1") {
                            notiSuccess();
                            ABL_LoadList();
                            ABL_Close();
                            syslog_mob(ser_BranchDetailID == 0 ? "i" : "u", "@Local["Chi nhánh"]");
                        } else {
                            document.getElementById("textShowMessage").innerHTML = "@Local["Trùng mã chi nhánh"]";
                        }
                    })
            }
            else {
                notiWarning(`@Local["Vui lòng chọn hình ảnh"]`);
                return false;
            }
        }
        return false;
    }
    //#endregion
    //#region //Event

    function ABD_EditImageGallery() {
        ABD_Render_Image_Gallery(ImageJson, "ABD_lightgalleryTableEdit");
    }

    function ABD_Render_Image_Gallery(data, id) {
        let myNode = document.getElementById(id);
        if (myNode != null) {
            myNode.innerHTML = '';
            let stringContent = '';
            if (data && data.length > 0) {
                for (let i = 0; i < data.length; i++) {
                    let item = data[i];
                    let link = item.Image;
                    let tr = '<div class="col-12 col-sm-3 me-3 mb-3 rounded-2 addimgNew" style="background: url(' + link + ')" value="' + link + '">'
                        + '<div class="text-center">'
                        + '<div class="d-flex m-2 ps-2 ms-auto position-absolute">'
                        + '<button class="badge badge-secondary badge-circle border-dark justify-content-center d-flex align-items-center my-auto buttonDeleteClass" name = "checkImageDelete" value="' + link + '">'
                        + '<i title="Remove" class="remove icon ms-1" aria-hidden="true"></i>'
                        + '</button>'
                        + '</div>'
                        + '</div>'
                        + '</div>'
                    stringContent = stringContent + tr;
                }
            }
            document.getElementById(id).innerHTML = stringContent;
        }
        ABD_EventClickDeleteImg();
    }

    function ABD_EventClickDeleteImg() {
        $('.buttonDeleteClass').on('click', '.remove', function () {
            let value = $(this).closest('div')[0].childNodes[0].value;
            const promise = notiConfirm();
            promise.then(function () { ABD_SaveEditImg(value); }, function () { });

        });
    }

    function ABD_SaveEditImg(value) {
        if (value != '') {
            for (let k = 0; k < ImageJson.length; k++) {
                if (ImageJson[k].Image == value) {
                    ImageDelete = ImageDelete + ',' + value;
                    ImageJson.splice(k, 1);
                    break;
                }
            }
        }
        ABD_Render_Image_Gallery(ImageJson, "ABD_lightgalleryTableEdit");
       // lightGallery(document.getElementById('ABD_lightgalleryTableEdit'));
        lightGallery(document.getElementById('ABD_lightgalleryTableEdit'), {
            speed: 300,
            showZoomInOutIcons: true,
            actualSize: false,
            thumbnail: true,
            plugins: [lgZoom, lgAutoplay, lgFullscreen, lgRotate, lgShare, lgThumbnail],
            mode: 'lg-fade'
        });


    }

    function ABD_GetLocation() {
        try {
            navigator.geolocation.getCurrentPosition((position) => {
                Lat = position.coords.latitude;
                Lon = position.coords.longitude;
                $('#ABD_Location').val((Lat + ' x ' + Lon));
            })
        }
        catch (ex) {

        }

    }
    //#endregion
</script>

<script>js_require('/js/main.js');</script>
<script>js_require('/js/customjs/custom-validation.js');</script>
<style>

    .addimgNew {
        max-height: 300px;
        max-width: 100%;
        width: 230px;
        height: 100px;
        background-position: center !important;
        background-size: cover !important;
        object-fit: cover;
        overflow: hidden;
    }

</style>

