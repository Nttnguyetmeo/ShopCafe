@page
@model MLunarCoffee.Pages.Setting.CustomerGroupDetailModel
@{
    Layout = null;
}

<script>js_require('/js/comon/initialize_setting.js');</script>

<script>js_require('/assests/dist/UploadJS/js/vendor/jquery.ui.widget.js');</script>
<script>js_require('/assests/dist/UploadJS/js/jquery.iframe-transport.js');</script>
<script>js_require('/assests/dist/UploadJS/js/jquery.fileupload.js');</script>
<script>js_require_notasync('/js/AppCustomer/FileUpload.js', true);</script>


<div class="container-fluid px-0 ">
    <div class="row">
        <div class="col-12">
            <div class="card mb-3">
                <div class="card-header p-3 pb-0">
                    <div class="d-lg-flex">
                        <div class="w-50 col-auto my-auto">
                            <div class="h-100">
                                <h6 out_in_header"" class="mb-0">@Local["Nhóm khách hàng"]</h6>
                                <p class="text-sm mb-0">@Local["Chi tiết nhóm khách hàng"]</p>
                            </div>
                        </div>
                        <div class="ms-auto my-auto mt-1">
                            <ul class="nav nav-pills p-1 bg-transparent tabtreat" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link cursor-pointer" data-tab="info" data-bs-toggle="pill" data-bs-target="#idInfo" role="tab">@Local["Thông tin"]</a>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link cursor-pointer" data-tab="content" data-bs-toggle="pill" data-bs-target="#CG_idContent" role="tab">@Local["Nội dung"]</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body p-3 pt-2">
                    <div class="row px-1 tab-content form3" id="formCustomerGroup">
                        <div class="tab-pane" id="idInfo" data-tab="info" role="tabpanel">
                            <div class="row d-flex">
                                <div class="col-w-300 mt-2">
                                    <div class="">
                                        <div class="accordion">
                                            <div>
                                                <button class="accordion-button p-2 px-0 collapsed" type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#LaboDetail_CollapseNoteImg" aria-expanded="true" aria-controls="LaboDetail_CollapseNoteImg">
                                                    <h6 class="text-primary text-sm font-weight-bold mb-0">@Local["Hình ảnh"] - @Local["Nhóm khách hàng"]</h6>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="pe-2">
                                            <div id="LaboDetail_CollapseNoteImg" class="collapse hide collapsesticky">
                                                <p class="text-dark text-sm fw-bold mb-1">
                                                    @Local["Hướng dẫn"]:
                                                    <span class="text-dark text-sm text-normal ms-2"> @Local["Vui lòng upload hình ảnh đúng kích thước"]</span>
                                                </p>
                                                <p class="text-dark text-sm fw-bold mt-2 mb-1">
                                                    @Local["Kích thước"]:
                                                    <span class="text-dark text-sm text-normal ms-2">110px x 110px</span>
                                                </p>
                                                <p class="text-dark text-sm fw-bold mt-2 mb-2">
                                                    @Local["Hình minh họa"]:
                                                </p>
                                                <div class="d-flex justify-content-center">
                                                    <div class="d-block avatar avatar-xxl position-relative mb-2">
                                                        <a href="/Image/Illustration/nhom-khach-hang.png" target="_blank">
                                                            <img src="/Image/Illustration/nhom-khach-hang.png" class="border-0" alt="team-2" onerror="Master_OnLoad_Error_Image(this)" style="height: 110px; width: 110px;">
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-1">
                                                <div class="row m-0 d-flex justify-content-center">
                                                    <div class="col-auto px-0 position-relative">
                                                        <img id="CG_DetailImage" class="border border-radius-md" alt="team-2" src="/default.png" onload="Master_Onload_SuccessPic(this,110,110)" onerror="Master_OnLoad_Error_Image(this)">
                                                        <div class="upload-container" id="">
                                                            <i class="fas fa-camera fs-3"></i>
                                                            <input class="position-absolute opacity-0  w-100 h-100 cursor-pointer top-0 d-flex align-items-center justify-content-center" id="CG_Fileup_LoadImage" accept="image/*" type="file" name="files[]" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div> 
                                </div>
                                <div class="field col-md-12 col-xl-8 pt-md-2 ps-xl-0 flex-grow-1">
                                    <div class="field col-12 p-1">
                                        <label>@Local["Tên nhóm khách hàng"]</label>
                                        <input id="CG_GroupName" name="name" type="text" class="form-control" />
                                    </div>
                                    <div class="field col-12 p-1">
                                        <label>@Local["Ghi chú"]</label>
                                        <textarea id="CG_Note" rows="1" name="content" class="form-control"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="CG_idContent" data-tab="content" role="tabpanel">
                            <div class="pb-0">
                                <div class="d-lg-flex">
                                    <div class="w-50 col-auto my-auto">
                                        <div class="h-100">
                                            <h6 out_in_header"" class="mb-0 text-uppercase">@Local["Chính sách"]</h6>
                                            <p class="text-sm mb-0">@Local["Tùy chọn áp dụng: Cho tất cả dịch vụ - Theo nhóm dịch vụ - Theo dịch vụ"]</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="my-auto mt-1">
                                    <ul class="nav nav-pills p-1 bg-transparent detailcus" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <a class="nav-link cursor-pointer" data-tab="discount_all" data-bs-toggle="pill" data-bs-target="#CG_id_discount_all" role="tab">@Local["Tất cả dịch vụ/sản phẩm"]</a>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <a class="nav-link cursor-pointer" data-tab="discount_service_type" data-bs-toggle="pill" data-bs-target="#CG_id_product_service_type" role="tab">@Local["Nhóm dịch vụ/sản phẩm"]</a>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <a class="nav-link cursor-pointer" data-tab="discount_service" data-bs-toggle="pill" data-bs-target="#CG_id_product_service" role="tab">@Local["Dịch vụ/sản phẩm"]</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="tab-content ps-2">
                                <div class="tab-pane" id="CG_id_discount_all" data-tab="discount_all" role="tabpanel">
                                    <div class="row px-1 form3" id="formCustomerGroup">
                                        <div class="field col-12 col-sm-6 p-1">
                                            <div class="form-check">
                                                <input id="ckb_choose_all" onchange="CG_changeEventChooseTypeDiscount(0)" type="checkbox" class="form-check-input pr-2">
                                                <label class="custom-control-label" for="">@Local["Áp dụng cho tất cả dịch vụ/sản phẩm"]</label>
                                            </div>
                                        </div>
                                        <div class="field col-12 col-sm-6 p-1">
                                            <label>@Local["Chiết khấu"]</label>
                                            <div class="position-relative">
                                                <input id="txtDiscount_All" class="border-right-0 form-control" type="text" placeholder="@Local["Chiết khấu"]" onchange="event.preventDefault();CustomerGroup_ChangeEventDiscountPrice();">
                                                <div class="ui fluid search selection dropdown form-control position-absolute end-0 top-0 w-auto ps-2 pe-5" id="DiscountAmountPer_All" onchange="event.preventDefault();return CustomerGroup_ChangeEventDiscountPrice();">
                                                    <i class="dropdown icon"></i>
                                                    <input type="hidden" name="" />
                                                    <div class="default text"></div>
                                                    <div id="cbbPerformanceDiscounted" class="menu transition hidden" tabindex="-1">
                                                        <div class="item" data-value="1">%</div>
                                                        <div class="item" data-value="2">VND</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="CG_id_product_service_type" data-tab="discount_service_type" role="tabpanel">
                                    <div class="row px-1 form3" id="formCustomerGroup">
                                        <div class="field col-12 p-1">
                                            <div class="form-check">
                                                <input id="ckb_choose_service_type" onchange="CG_changeEventChooseTypeDiscount(2)" type="checkbox" name="public" class="form-check-input pr-2">
                                                <label class="custom-control-label" for="">@Local["Áp dụng theo nhóm dịch vụ/sản phẩm"]</label>
                                            </div>
                                            @*<div class="d-none">
                                            <label  >Chiết khấu</label>
                                            <div class="position-relative">
                                            <input id="txtDiscount_ServiceType" class="border-right-0 form-control" name="discountOther" type="text" placeholder="Chiết khấu" onchange="event.preventDefault();CustomerGroup_ChangeEventDiscountPrice();">
                                            <div class="ui fluid search selection dropdown form-control position-absolute end-0 top-0 w-auto ps-2 pe-5" id="DiscountAmountPer_ServiceType" onchange="event.preventDefault();return CustomerGroup_ChangeEventDiscountPrice();">
                                            <input type="hidden" name="" />
                                            <i class="dropdown icon"></i>
                                            <input class="search" autocomplete="off" tabindex="0" />
                                            <div class="default text"></div>
                                            <div class="menu transition hidden" tabindex="-1">
                                            <div class="item" data-value="1">%</div>
                                            <div class="item" data-value="2">VND</div>
                                            </div>
                                            </div>
                                            </div>
                                            </div>*@
                                        </div>
                                        <div class="row d-flex p-1 d-none" id="list_service_type_discount">
                                            <div class="field col-md-12 col-xl-6 mt-2 flex-grow-1">
                                                <div class="field col-12">
                                                    <input class="form-control" placeholder="@Local["Tìm kiếm"]" id="filterSetting_ServiceType" type="text">
                                                </div>
                                                <div class="field col-12 pt-2">
                                                    <div class="m-0 my-3 mobile-responsive">
                                                        <table class="table vt-table mb-0" id="dtContentDiscountByServiceType_ListLeft">
                                                            <thead>
                                                                <tr role="row">
                                                                    <th>@Local["Nhóm dịch vụ/sản phẩm"]</th>
                                                                    <th></th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="dtContentDiscountByServiceType_ListLeftBody">
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="field col-md-12 col-xl-6 pt-md-2 ps-xl-0 flex-grow-1 mt-5">
                                                <div class="my-3 mobile-responsive" style="min-height:195px">
                                                    <table class="table vt-table mb-0" id="dtContentDiscountByServiceType_ListRight">
                                                        <thead>
                                                            <tr role="row">
                                                                <th>@Local["Dịch vụ/sản phẩm"]</th>
                                                                <th>@Local["Chiết khấu"]</th>
                                                                <th></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="dtContentDiscountByServiceType_ListRightBody">
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" role="tabpanel" id="CG_id_product_service" data-tab="discount_service">
                                    <div class="row px-1 form3" id="formCustomerGroup">
                                        <div class="field col-12 p-1">
                                            <div class="form-check">
                                                <input name="public" id="ckb_choose_service" onchange="CG_changeEventChooseTypeDiscount(1)" type="checkbox" class="form-check-input pr-2">
                                                <label class="custom-control-label" for="">@Local["Áp dụng theo dịch vụ/sản phẩm"]</label>
                                            </div>
                                        </div>
                                        @*<div class="d-none">
                                        <label >Chiết khấu</label>
                                        <div class="position-relative">
                                        <input id="txtDiscount_Service" class="border-right-0 form-control" type="text" placeholder="Chiết khấu" onchange="event.preventDefault();CustomerGroup_ChangeEventDiscountPrice();">
                                        <div class="ui fluid search selection dropdown form-control position-absolute end-0 top-0 w-auto ps-2 pe-5" id="DiscountAmountPer_Service" onchange="event.preventDefault();return CustomerGroup_ChangeEventDiscountPrice();">
                                        <input type="hidden" name="" />
                                        <i class="dropdown icon"></i>
                                        <input class="search" autocomplete="off" tabindex="0" />
                                        <div class="default text"></div>
                                        <div class="menu transition hidden" tabindex="-1">
                                        <div class="item" data-value="1">%</div>
                                        <div class="item" data-value="2">VND</div>
                                        </div>
                                        </div>
                                        </div>
                                        </div>*@
                                        <div class="row d-flex d-none p-1" id="list_service_discount">
                                            <div class="field col-md-12 col-xl-6 mt-2 flex-grow-1">
                                                <div class="field col-12">
                                                    <input class="form-control" placeholder="@Local["Tìm kiếm"]" id="filterSetting_Service" type="text">
                                                </div>
                                                <div class="field col-12 pt-2">
                                                    <div class="m-0 my-3 mobile-responsive">
                                                        <table id="dtContentDiscountByService_ListLeft" class="table vt-table mb-0" role="grid" aria-describedby="data_table_info">
                                                            <thead>
                                                                <tr role="row">
                                                                </tr>
                                                            </thead>
                                                            <tbody id="dtContentDiscountByService_ListLeftBody">
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="field col-md-12 col-xl-6 pt-md-2 ps-xl-0 flex-grow-1 mt-5">
                                                <div class="my-3 mobile-responsive" style="min-height:195px">
                                                    <table class="table vt-table mb-0" id="dtContentDiscountByService_ListRight">
                                                        <thead>
                                                            <tr role="row">
                                                                <th>@Local["Dịch vụ/sản phẩm"]</th>
                                                                <th style="min-width:200px">@Local["Chiết khấu"]</th>
                                                                <th></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="dtContentDiscountByService_ListRightBody">
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="fixed-botombutton">
                <div class="action_Save">
                    <div class="text-danger text-gradient text-sm font-weight-bold" id="textShowMessage"></div>
                    <div class="action_Save-Content">
                        <button class="btn btn-secondary" form="formCustomerGroup" onclick="event.preventDefault(); return CloseModal()">@Local["Đóng"]</button>
                        <button form="formCustomerGroup" type="button" class="btn bg-gradient-primary mt-2 me-2 _tab_control_ setting_projectclosure" data-tab="edit_tab_customer" onclick="event.preventDefault();return CustomerGroup_Excute()">@Local["Lưu"]</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var ser_CustomerGroupID = @Model._CustomerGroupID;
    var urlImage = "/Api/Upload/Upload?Type=SystemImage";
    var CG_ImageString = Master_Default_Pic;
    var dataAllServiceType = {};
    var dataAllService = {};
    var dataRuleDiscount = [];
    let CG_Sys_Image;
    $(document).ready(function () {
        initNavs();
        $('.tabtreat a:first').tab('show');
        CG_Sys_Image = {
            size: 102400,
            width: 110,
            height: 110,
            format: ['jpg', 'png', 'jpeg']
        }
        $('#CG_LimitImageNote').html(`${CG_Sys_Image.width} x ${CG_Sys_Image.height} px, ${(CG_Sys_Image.size / 1024)}KB`);
        CG_Event();
        // khoi tao rule discount
        dataRuleDiscount = [{ "type": "all", "active": 0, "percent": 0, "amount": 0, "value": [] }, { "type": "servicetype", "active": 0, "percent": 0, "amount": 0, "value": [] }, { "type": "service", "active": 0, "percent": 0, "amount": 0, "value": [] }]

        initNavs();
        $('.detailcus a:first').tab('show');
        $('#txtDiscount_All').attr('disabled', true);
        $('#txtDiscount_All').divide();
        $("#DiscountAmountPer_All").dropdown("set selected", 1);
        CG_filterServiceTypeDiscount();
        CG_filterServiceDiscount();
        CustomerGroupLoadInitiliaze();
        eventRowDiscount_ServiceType();
        Checking_TabControl_Permission();
        CheckPermissionControlInPage(sys_PerControl, '@Model.CurrentPath');
        CheckPermissionControlInPage(sys_PerControlMH, '@Model.CurrentPath');
        $('.tabtreat a:first').addClass('active');
        $('.tabtreat a:first').trigger('click');
        $('.detailcus a:first').addClass('active');
        $('.detailcus a:first').trigger('click');
        if ($('#ckb_choose_all').is(':checked')) {
            $('#txtDiscount_All').attr('disabled', false);
            $('#DiscountAmountPer_All').removeClass("bg-light");
            $('#txtDiscount_All').removeClass("bg-light");
        }
        else {
            $('#txtDiscount_All').attr('disabled', true);
            $('#txtDiscount_All').val(0);
            $('#DiscountAmountPer_All').addClass("bg-light");
            $('#txtDiscount_All').addClass("bg-light");
        }
    });

    function CustomerGroupLoadInitiliaze() {
        AjaxLoad(url = "/Setting/CustomerGroupDetail/?handler=LoadInitialize"
            , data = {
                CurrentID: ser_CustomerGroupID
            }, async = true, error = null
            , success = function (result) {
                if (result != "0") {
                    let data = JSON.parse(result);
                    CustomerGroup_ParseKeyValue(data.ServiceType, dataAllServiceType);
                    CustomerGroup_ParseKeyValue(data.Service, dataAllService);
                    CustomerGroup_LoadUpdate(data.dataDetail);

                } else {
                    notiError_SW();
                }
            });
    }

    //#region //Render and Fill Data
    function CustomerGroupRenderLeft(data, id, type) {
        var myNode = document.getElementById(id);
        if (myNode != null) {
            myNode.innerHTML = '';
            let stringContent = '';
            for ([key, value] of Object.entries(data)) {
                if (value.Choose == "0") {
                    let tr =
                        '<td class="d-none">' + key + '</td>'
                        + '<td class="list_service_discount">' + value.Name + '</td>'
                        + '<td>' + Render_Button_Grid(['<button class="' + ((type == 1) ? 'btnChooseService' : 'btnChooseServiceType') + ' buttonGrid"><i class="imgGrid vtt-icon vttech-icon-add"></i></button>']) + '</td>'
                    stringContent = stringContent + '<tr role="row">' + tr + '</tr>';
                }
            }
            document.getElementById(id).innerHTML = stringContent;
        }
    }
    function CustomerGroup_RenderRight(data, id, type) {
        var myNode = document.getElementById(id);
        if (myNode != null) {
            myNode.innerHTML = '';
            let stringContent = '';
            for ([key, value] of Object.entries(data)) {
                if (value.Choose == "1") {
                    let tr = "";
                    if (type == 1) {
                        tr = ' <td class="d-none">' + key + '</td>'
                            + ' <td>' + value.Name + '</td>'
                            //----------------------------------------
                            + ' <td>'
                            + '<div class="position-relative" >'
                            + '<input id="Discount_Service_Detail_' + key + '" class="border-right-0 form-control" name="discountOther" type="text" placeholder="eg .@Local["Tiền chiết khấu"]" onchange="event.preventDefault();CustomerGroup_Onchange_DiscountItem(' + key + ',1);" />'
                            + '<div class="ui fluid search selection dropdown form-control position-absolute end-0 top-0 w-auto ps-2 pe-5" id="DiscountAmountPer_Service_' + key + '" onchange="event.preventDefault();return CustomerGroup_Onchange_DiscountItem(' + key + ',1);">'
                            + '<i class="dropdown icon"></i>'
                            + '<input type="hidden" name="name" />'
                            + '<div class="default text"></div>'
                            + '<div id="cbbPerformanceDiscounted" class="menu transition hidden" tabindex="-1">'
                            + '<div class="item" data-value="1">%</div>'
                            + '<div class="item" data-value="2">VND</div>'
                            + '</div>'
                            + '</div>'
                            + '</div>'
                            + '</td>'
                            //-----------------------------------------
                            + ' <td>' + Render_Button_Grid(['<button class="btnRemoveService buttonGrid"><i class="imgGrid vtt-icon vttech-icon-delete"></i></button>']) + '</td>'
                    }
                    if (type == 2) {
                        tr = '<td class="d-none">' + key + '</td>'
                            + ' <td>' + value.Name + '</td>'
                            //----------------------------------------
                            + '<td>'
                            + '<div class="position-relative">'
                            + '<input id="Discount_ServiceType_Detail' + key + '" class="border-right-0 form-control" name="discountOther" type="text" placeholder="eg .@Local["Tiền chiết khấu"]" onchange="event.preventDefault();CustomerGroup_Onchange_DiscountItem(' + key + ',2);" />'
                            + '<div class="ui fluid search selection dropdown form-control position-absolute end-0 top-0 w-auto ps-2 pe-5" id="DiscountAmountPer_ServiceType_' + key + '" onchange="event.preventDefault();return CustomerGroup_Onchange_DiscountItem(' + key + ',2);">'
                            + '<i class="dropdown icon"></i>'
                            + '<input type="hidden" name="name" />'
                            + '<div class="default text"></div>'
                            + '<div id="cbbPerformanceDiscounted" class="menu transition hidden" tabindex="-1">'
                            + '<div class="item" data-value="1">%</div>'
                            + '<div class="item" data-value="2">VND</div>'
                            + '</div>'
                            + '</div>'
                            + '</div>'
                            + '</td>'
                            //-----------------------------------------
                            + ' <td>' + Render_Button_Grid(['<button class="btnRemoveServiceType buttonGrid"><i class="imgGrid vtt-icon vttech-icon-delete"></i></button>']) + '</td>'
                    }
                    stringContent = stringContent + '<tr role="row">' + tr + '</tr>';
                }
            }
            
            myNode.innerHTML = stringContent;
            $(".ui.dropdown").dropdown();
            CustomerGroup_EventFill(data, type);
        }
    }
    function CustomerGroup_EventFill(data, type) {
        let dataArray = Object.entries(data).filter(([key, value]) => value.Choose == "1");
        if (dataArray.length > 0) {
            data = CustomerGroup_ParseArrayToKeyValue(dataArray);
            if (type === 1) {
                for ([key, value] of Object.entries(data)) {
                    let discount_Percent = Number(value.Percent);
                    let discount_Amount = Number(value.Amount);
                    if (discount_Percent > discount_Amount) {
                        $("#Discount_Service_Detail_" + key).val(discount_Percent);
                        $("#DiscountAmountPer_Service_" + key).dropdown("set selected", 1);
                    }
                    else {
                        $("#Discount_Service_Detail_" + key).val(discount_Amount);
                        $("#DiscountAmountPer_Service_" + key).dropdown("set selected", 2);
                    }
                }
            }
            else {
                for ([key, value] of Object.entries(data)) {
                    let discount_Percent = Number(value.Percent);
                    let discount_Amount = Number(value.Amount);
                    if (discount_Percent > discount_Amount) {
                        $("#Discount_ServiceType_Detail" + key).val(discount_Percent);
                        $("#DiscountAmountPer_ServiceType_" + key).dropdown("set selected", 1);
                    }
                    else {
                        $("#Discount_ServiceType_Detail" + key).val(discount_Amount);
                        $("#DiscountAmountPer_ServiceType_" + key).dropdown("set selected", 2);
                    }
                }
            }
        }

    }
    //#endregion

    //#region //Event Change (add, remove,value ,Choose Type Discount)
    function eventRowDiscount_ServiceType() {
        $('#dtContentDiscountByServiceType_ListLeft tbody').on('click', '.btnChooseServiceType', function () {
            event.preventDefault();
            let ID = Number($(this).closest('tr')[0].childNodes[0].innerHTML);
            if (ID != undefined && ID != 0) CustomerGroup_AddItem(ID, 2);
        });
        $('#dtContentDiscountByServiceType_ListRight tbody').on('click', '.btnRemoveServiceType', function () {
            event.preventDefault();
            let ID = Number($(this).closest('tr')[0].children[0].innerHTML);
            if (ID != undefined && ID != 0) CustomerGroup_RemoveItem(ID, 2);
        });

        $('#dtContentDiscountByService_ListLeft tbody').on('click', '.btnChooseService', function () {
            event.preventDefault();
            let ID = Number($(this).closest('tr')[0].childNodes[0].innerHTML);
            if (ID != undefined && ID != 0) CustomerGroup_AddItem(ID, 1);
        });
        $('#dtContentDiscountByService_ListRight tbody').on('click', '.btnRemoveService', function () {
            event.preventDefault();
            let ID = Number($(this).closest('tr')[0].children[0].innerHTML);
            if (ID != undefined && ID != 0) CustomerGroup_RemoveItem(ID, 1);
        });
    }
    function CustomerGroup_AddItem(id, TypeDiscount) {
        if (TypeDiscount === 2) {
            dataAllServiceType[id].Choose = "1";
            CustomerGroupRenderLeft(dataAllServiceType, "dtContentDiscountByServiceType_ListLeftBody", 2);
            CustomerGroup_RenderRight(dataAllServiceType, "dtContentDiscountByServiceType_ListRightBody", 2);
        }
        if (TypeDiscount === 1) {
            dataAllService[id].Choose = "1";
            CustomerGroupRenderLeft(dataAllService, "dtContentDiscountByService_ListLeftBody", 1);
            CustomerGroup_RenderRight(dataAllService, "dtContentDiscountByService_ListRightBody", 1);
        }
    }
    function CustomerGroup_RemoveItem(id, TypeDiscount) {
        if (TypeDiscount === 2) {
            dataAllServiceType[id].Choose = "0";
            CustomerGroupRenderLeft(dataAllServiceType, "dtContentDiscountByServiceType_ListLeftBody", 2);
            CustomerGroup_RenderRight(dataAllServiceType, "dtContentDiscountByServiceType_ListRightBody", 2);
        }
        if (TypeDiscount === 1) {
            dataAllService[id].Choose = "0";
            CustomerGroupRenderLeft(dataAllService, "dtContentDiscountByService_ListLeftBody", 1);
            CustomerGroup_RenderRight(dataAllService, "dtContentDiscountByService_ListRightBody", 1);
        }
    }
    function CustomerGroup_Onchange_DiscountItem(id, TypeDiscount) {
        if (TypeDiscount === 2) {
            if ($('#ckb_choose_service_type').is(':checked')) {
                let _type_discount = Number($("#DiscountAmountPer_ServiceType_" + id).dropdown("get value")) ? Number($("#DiscountAmountPer_ServiceType_" + id).dropdown("get value")) : 0;
                let _value_discount = Number($("#Discount_ServiceType_Detail" + id).val()) ? Number($("#Discount_ServiceType_Detail" + id).val()) : 0;
                if (_type_discount == 1) {
                    if (_value_discount < 0 || _value_discount > 100) {
                        $("#Discount_ServiceType_Detail" + id).css("background-color", "rgb(255 216 216)")
                    }
                    else {
                        $("#Discount_ServiceType_Detail" + id).css("background-color", "white")
                    }
                } else {
                    if (_value_discount < 0) {
                        $("#Discount_ServiceType_Detail" + id).css("background-color", "rgb(255 216 216)")
                    }
                    else {
                        $("#Discount_ServiceType_Detail" + id).css("background-color", "white");
                    }
                }
                if (_type_discount == 1) {
                    dataAllServiceType[id].Percent = _value_discount
                    dataAllServiceType[id].Amount = 0;
                }
                else {
                    dataAllServiceType[id].Percent = 0
                    dataAllServiceType[id].Amount = _value_discount;
                }
            }
        }
        if (TypeDiscount === 1) {
            if ($('#ckb_choose_service').is(':checked')) {
                let _type_discount = Number($("#DiscountAmountPer_Service_" + id).dropdown("get value")) ? Number($("#DiscountAmountPer_Service_" + id).dropdown("get value")) : 0;
                let _value_discount = Number($("#Discount_Service_Detail_" + id).val()) ? Number($("#Discount_Service_Detail_" + id).val()) : 0;
                if (_type_discount == 1) {
                    if (_value_discount < 0 || _value_discount > 100) {
                        $("#Discount_Service_Detail_" + id).css("background-color", "rgb(255 216 216)")
                    }
                    else {
                        $("#Discount_Service_Detail_" + id).css("background-color", "white")
                    }
                }
                else {
                    if (_value_discount < 0) {
                        $("#Discount_Service_Detail_" + id).css("background-color", "rgb(255 216 216)")
                    }
                    else {
                        $("#Discount_Service_Detail_" + id).css("background-color", "white");
                    }
                }
                if (_type_discount == 1) {
                    dataAllService[id].Percent = _value_discount
                    dataAllService[id].Amount = 0;
                }
                else {
                    dataAllService[id].Percent = 0
                    dataAllService[id].Amount = _value_discount;
                }
            }
        }
    }
    function CG_changeEventChooseTypeDiscount(type) {
        // giam theo nhom dich vu
        if (type == 2) {
            if ($('#ckb_choose_service_type').is(':checked')) {
                $('#list_service_type_discount').removeClass('d-none');
                /*  $('#txtDiscount_ServiceType').attr('disabled', false);*/
                CG_LoadInitializeByServiceType();
            }
            else {
                $('#list_service_type_discount').addClass('d-none');
                //$('#txtDiscount_ServiceType').attr('disabled', true);
                //$('#txtDiscount_ServiceType').val(0);
            }
        }

        // giam theo dich vu
        if (type == 1) {
            if ($('#ckb_choose_service').is(':checked')) {
                $('#list_service_discount').removeClass('d-none');
                $('#txtDiscount_Service').attr('disabled', false);
                CG_LoadInitializeByService();
            }
            else {
                $('#list_service_discount').addClass('d-none');
                //$('#txtDiscount_Service').attr('disabled', true);
                //$('#txtDiscount_Service').val(0);
            }
        }
        // ap dung cho tat ca sp, dv
        if (type == 0) {
            if ($('#ckb_choose_all').is(':checked')) {
                $('#txtDiscount_All').attr('disabled', false);
                $('#DiscountAmountPer_All').removeClass("bg-light");
                $('#txtDiscount_All').removeClass("bg-light");
            }
            else {
                $('#txtDiscount_All').attr('disabled', true);
                $('#txtDiscount_All').val(0);
                $('#DiscountAmountPer_All').addClass("bg-light");
                $('#txtDiscount_All').addClass("bg-light");
            }
        }
    }
    //#endregion
    //#region //Parse Key Value
    function CustomerGroup_ParseKeyValue(data, dataResult) {
        for (let i = 0; i < data.length; i++) {
            let element = {};
            element.ID = data[i].ID;
            element.Name = data[i].Name;
            element.Choose = data[i].Choose;
            element.Percent = data[i].Percent;
            element.Amount = data[i].Amount;
            dataResult[data[i].ID] = element;
        }
    }
    function CustomerGroup_ParseArrayToKeyValue(data) {
        let dataResult = {};
        for (let i = 0; i < data.length; i++) {
            let items = data[i];
            let item = items[1];
            let element = {};
            element.ID = item.ID;
            element.Name = item.Name;
            element.Choose = item.Choose;
            element.Percent = item.Percent;
            element.Amount = item.Amount;
            dataResult[item.ID] = element;
        }
        return dataResult;
    }
    //#endregion
    //#region //Filter Service and Service Type
    function CG_filterServiceTypeDiscount() {
        if (document.getElementById("filterSetting_ServiceType")) {
            let datafilter = {};
            var filter = document.getElementById("filterSetting_ServiceType");
            filter.addEventListener("keyup", function (event) {
                let textsearch = $('#filterSetting_ServiceType').val().trim();
                event.preventDefault();
                let search = xoa_dau(textsearch.toLowerCase());
                if (search == "") {
                    datafilter = dataAllServiceType;
                }
                else {
                    let dataArray = Object.entries(dataAllServiceType).filter(([key, value]) => xoa_dau(value.Name).toLowerCase().includes(search));
                    if (dataArray.length > 0) {
                        datafilter = CustomerGroup_ParseArrayToKeyValue(dataArray);
                    }
                }
                CustomerGroupRenderLeft(datafilter, "dtContentDiscountByServiceType_ListLeftBody", 2);
                ColorSearchFilterText(search, "list_service_discount");
            });
        }
    }
    function CG_filterServiceDiscount() {
        if (document.getElementById("filterSetting_Service")) {
            let data = {};
            var filter = document.getElementById("filterSetting_Service");
            filter.addEventListener("keyup", function (event) {
                let textsearch = $('#filterSetting_Service').val().trim();
                event.preventDefault();
                let search = xoa_dau(textsearch.toLowerCase());
                if (search == "") {
                    data = dataAllService;
                }
                else {
                    let dataArray = Object.entries(dataAllService).filter(([key, value]) => xoa_dau(value.Name).toLowerCase().includes(search));
                    if (dataArray.length > 0) {
                        data = CustomerGroup_ParseArrayToKeyValue(dataArray);
                    }
                }
                CustomerGroupRenderLeft(data, "dtContentDiscountByService_ListLeftBody", 1);
                ColorSearchFilterText(search, "list_service_discount");
            });
        }
    }
    //#endregion
    async function CustomerGroup_Excute() {
        document.getElementById("textShowMessage").innerHTML = "";
        if (document.getElementById('ckb_choose_all')) {
            CustomerGroup_ChangeEventDiscountPrice();
        }
        if (document.getElementById("textShowMessage").innerHTML == "") {
            let ruleService = [];
            let ruleServiceType = [];
            // danh sach nhom dich vu va dich vu co giam gia
            if (dataAllServiceType != undefined && dataAllServiceType != "") {
                let data = Object.entries(dataAllServiceType).filter(([key, value]) => value.Choose == "1");
                for (let i = 0; i < data.length; i++) {
                    let items = data[i];
                    let item = items[1];
                    let servicetype = {};
                    servicetype.id = item.ID;
                    servicetype.percent = item.Percent;
                    servicetype.amount = item.Amount;
                    ruleServiceType.push(servicetype);
                }
            }
            if (dataAllService != undefined && dataAllService != "") {
                let data = Object.entries(dataAllService).filter(([key, value]) => value.Choose == "1");
                for (let i = 0; i < data.length; i++) {
                    let items = data[i];
                    let item = items[1];
                    let service = {};
                    service.id = item.ID;
                    service.percent = item.Percent;
                    service.amount = item.Amount;
                    ruleService.push(service);
                }
            }
            if (document.getElementById("ckb_choose_all")) {
                for (let i = 0; i < dataRuleDiscount.length; i++) {
                    if (dataRuleDiscount[i].type == 'service') {
                        if ($('#ckb_choose_service').is(':checked')) {
                            dataRuleDiscount[i].active = 1;
                            let PerTreat = Number($('#DiscountAmountPer_Service').dropdown('get value')) ? Number($('#DiscountAmountPer_Service').dropdown('get value')) : 0;
                            if (PerTreat == 1) {
                                dataRuleDiscount[i].percent = Number($('#txtDiscount_Service').val() ? $('#txtDiscount_Service').val() : 0);
                                dataRuleDiscount[i].amount = 0;
                            }
                            else {
                                dataRuleDiscount[i].amount = Number($('#txtDiscount_Service').val() ? $('#txtDiscount_Service').val() : 0);
                                dataRuleDiscount[i].percent = 0;
                            }
                            dataRuleDiscount[i].value = ruleService;
                        }
                        else {
                            dataRuleDiscount[i].active = 0;
                            dataRuleDiscount[i].percent = 0;
                            dataRuleDiscount[i].amount = 0;
                            dataRuleDiscount[i].value = [];
                        }

                    }
                    else if (dataRuleDiscount[i].type == 'servicetype') {
                        if ($('#ckb_choose_service_type').is(':checked')) {
                            dataRuleDiscount[i].active = 1;
                            let PerTreat = Number($('#DiscountAmountPer_ServiceType').dropdown('get value')) ? Number($('#DiscountAmountPer_ServiceType').dropdown('get value')) : 0;
                            if (PerTreat == 1) {
                                dataRuleDiscount[i].percent = Number($('#txtDiscount_ServiceType').val() ? $('#txtDiscount_ServiceType').val() : 0);
                                dataRuleDiscount[i].amount = 0;
                            }
                            else {
                                dataRuleDiscount[i].amount = Number($('#txtDiscount_ServiceType').val() ? $('#txtDiscount_ServiceType').val() : 0);
                                dataRuleDiscount[i].percent = 0;
                            }
                            dataRuleDiscount[i].value = ruleServiceType;
                        }
                        else {
                            dataRuleDiscount[i].active = 0;
                            dataRuleDiscount[i].percent = 0;
                            dataRuleDiscount[i].amount = 0;
                            dataRuleDiscount[i].value = [];
                        }

                    }
                    else if (dataRuleDiscount[i].type == 'all') {
                        if ($('#ckb_choose_all').is(':checked')) {
                            dataRuleDiscount[i].active = 1;
                            let PerTreat = Number($('#DiscountAmountPer_All').dropdown('get value')) ? Number($('#DiscountAmountPer_All').dropdown('get value')) : 0;
                            if (PerTreat == 1) {
                                dataRuleDiscount[i].percent = Number($('#txtDiscount_All').val() ? $('#txtDiscount_All').val() : 0);
                                dataRuleDiscount[i].amount = 0;
                            }
                            else {
                                dataRuleDiscount[i].amount = Number($('#txtDiscount_All').val() ? $('#txtDiscount_All').val() : 0);
                                dataRuleDiscount[i].percent = 0;
                            }
                            dataRuleDiscount[i].value = [];
                        }
                        else {
                            dataRuleDiscount[i].active = 0;
                            dataRuleDiscount[i].percent = 0;
                            dataRuleDiscount[i].amount = 0;
                            dataRuleDiscount[i].value = [];
                        }

                    }
                }
            }
            var data = new Object();
            let Image = $("#CG_Fileup_LoadImage")[0].files.length != 0 ? await AjaxUpload_Image(urlImage, 'CG_Fileup_LoadImage') : CG_ImageString;
            data.Name = $('#CG_GroupName').val() ? $('#CG_GroupName').val() : "";
            data.Note = $('#CG_Note').val() ? $('#CG_Note').val() : "";
            data.Image = Image;
            data.DataRule = JSON.stringify(dataRuleDiscount);
            $('#formCustomerGroup').form('validate form');
            if ($('#formCustomerGroup').form('is valid')) {
                AjaxLoad(url = "/Setting/CustomerGroupDetail/?handler=ExcuteData"
                    , data = {
                        data: JSON.stringify(data),
                        CurrentID: ser_CustomerGroupID
                    }, async = true, error = null
                    , success = function (result) {
                        if (result == "1") {
                            notiSuccess();
                            CustomerGroupLoad();
                            CloseModal();
                        } else if (result == "-1") {
                            $('#textShowMessage').html('@Local["Trùng dữ liệu"]');
                        } else {
                            notiError_SW();
                        }
                    });
            }
        }
        return false;
    }
    function CustomerGroup_LoadUpdate(dataCustomerGroup) {
        if (dataCustomerGroup && dataCustomerGroup.length > 0) {
            $('#CG_GroupName').val((dataCustomerGroup[0].Name));
            $('#CG_Note').val((dataCustomerGroup[0].Note));
            CG_ImageString = dataCustomerGroup[0].Image ?? Master_Default_Pic;
            $('#CG_DetailImage').attr('src', CG_ImageString)
            // update Rule discount
            let DataRule = JSON.parse(dataCustomerGroup[0].DataRule);
            if (document.getElementById('ckb_choose_all') && DataRule && DataRule.length > 0) {
                dataRuleDiscount = DataRule;
                for (let i = 0; i < dataRuleDiscount.length; i++) {
                    var item = dataRuleDiscount[i];
                    if (item.type == "all" && item.active == 1) {
                        $('#ckb_choose_all')[0].checked = true;
                        CG_changeEventChooseTypeDiscount(0);
                        if (item.percent != 0) {
                            $("#DiscountAmountPer_All").dropdown("set selected", 1);
                            $('#txtDiscount_All').val(item.percent);
                        }
                        else {
                            $("#DiscountAmountPer_All").dropdown("set selected", 2);
                            $('#txtDiscount_All').val(item.amount);
                        }
                    }
                    else if (item.type == "servicetype" && item.active == 1) {
                        $('#ckb_choose_service_type')[0].checked = true;
                        CG_changeEventChooseTypeDiscount(2);
                        if (item.percent != 0) {
                            /*   $("#DiscountAmountPer_ServiceType").dropdown("set selected", 1);*/
                            $('#txtDiscount_ServiceType').val(item.percent);
                        }
                        else {
                                 /*   $("#DiscountAmountPer_ServiceType").dropdown("set selected", 2)*/;
                            $('#txtDiscount_ServiceType').val(item.amount);
                        }
                        let arrtype = item.value;
                        if (arrtype.length != 0) {
                            for (let a = 0; a < arrtype.length; a++) {
                                let id = arrtype[a].id;
                                let percent = arrtype[a].percent;
                                let amount = arrtype[a].amount;
                                if (id != "") {
                                    if (dataAllServiceType[id] != null && dataAllServiceType[id] != undefined) {
                                        dataAllServiceType[id].Choose = "1";
                                        dataAllServiceType[id].Percent = percent;
                                        dataAllServiceType[id].Amount = amount;
                                    }
                                }
                            }
                        }
                        CG_LoadInitializeByServiceType();
                    }
                    else if (item.type == "service" && item.active == 1) {
                        $('#ckb_choose_service')[0].checked = true;
                        CG_changeEventChooseTypeDiscount(1);
                        if (item.percent != 0) {
                            /*      $("#DiscountAmountPer_Service").dropdown("set selected", 1);*/
                            $('#txtDiscount_Service').val(item.percent);
                        }
                        else {
                            /*   $("#DiscountAmountPer_Service").dropdown("set selected", 2);*/
                            $('#txtDiscount_Service').val(item.amount);
                        }
                        let arrtype = item.value;
                        if (arrtype.length != 0) {
                            for (let t = 0; t < arrtype.length; t++) {
                                let id = arrtype[t].id;
                                let percent = arrtype[t].percent;
                                let amount = arrtype[t].amount;
                                if (id != "") {
                                    if (dataAllService[id] != null && dataAllService[id] != undefined) {
                                        dataAllService[id].Choose = "1";
                                        dataAllService[id].Percent = percent;
                                        dataAllService[id].Amount = amount;
                                    }
                                }
                            }
                        }
                        CG_LoadInitializeByService();
                    }
                }
            }
        }
    }
    function CG_LoadInitializeByServiceType() {
        CustomerGroupRenderLeft(dataAllServiceType, "dtContentDiscountByServiceType_ListLeftBody", 2);
        CustomerGroup_RenderRight(dataAllServiceType, "dtContentDiscountByServiceType_ListRightBody", 2);
    }
    function CG_LoadInitializeByService() {
        CustomerGroupRenderLeft(dataAllService, "dtContentDiscountByService_ListLeftBody", 1);
        CustomerGroup_RenderRight(dataAllService, "dtContentDiscountByService_ListRightBody", 1);
    }
    // EVENT CHANGE DISCOUNT
    function CustomerGroup_ChangeEventDiscountPrice() {
        $('#textShowMessage').html('');
        let typeDiscountPer_All = Number($('#DiscountAmountPer_All').dropdown('get value')) ? Number($('#DiscountAmountPer_All').dropdown('get value')) : 0;
        if (!isNaN($('#txtDiscount_All').val()) || $('#txtDiscount_All').val() == '') {
            let valueDiscountPer_All = Number($('#txtDiscount_All').val() ? $('#txtDiscount_All').val() : 0);
            if (typeDiscountPer_All == 1 && valueDiscountPer_All <= 100 && valueDiscountPer_All >= 0) {
                $('#txtDiscount_All').css('background-color', 'white');
            }
            else if (typeDiscountPer_All == 2 && valueDiscountPer_All >= 0) {
                $('#txtDiscount_All').css('background-color', 'white');
            }
            else {
                // sai dinh dang
                $('#textShowMessage').html('@Local["Sai định dạng"]');
                $('#txtDiscount_All').css('background-color', 'rgb(255 216 216)');
            }
        }
        else {
            //sai dinh dang
            $('#textShowMessage').html('@Local["Sai định dạng"]');
            $('#txtDiscount_All').css('background-color', 'rgb(255 216 216)');
        }
        //Chiết Khấu cho từng dịch vụ và nhóm dịch vụ
        if ($('#ckb_choose_service').is(':checked')) {
            CustomerGroup_ValidateDiscountValue(dataAllService, 1);
        }
        if ($('#ckb_choose_service_type').is(':checked')) {
            CustomerGroup_ValidateDiscountValue(dataAllServiceType, 2);
        }
    }
    function CustomerGroup_ValidateDiscountValue(data, type) {
        let dataArray = Object.entries(data).filter(([key, value]) => value.Choose == "1");
        let AttributeID = "";
        if (type == 1) AttributeID = "Discount_Service_Detail_"
        else AttributeID = "Discount_ServiceType_Detail";
        if (dataArray.length > 0) {
            data = CustomerGroup_ParseArrayToKeyValue(dataArray);
            for ([key, value] of Object.entries(data)) {
                let discount_Percent = Number(value.Percent);
                let discount_Amount = Number(value.Amount);
                if (discount_Percent < 0 || discount_Amount < 0 || discount_Percent > 100 || (discount_Percent == 0 && discount_Amount == 0)) {
                    $("#" + AttributeID + key).css('background-color', 'rgb(255 216 216)');
                    $('#textShowMessage').html('@Local["Sai định dạng"]');
                }
            }
        }
    }
    function CG_Event() {
        UploadImage({
            inputFile: 'CG_Fileup_LoadImage'
            , btnInput: ''
            , avatar: 'CG_DetailImage'
            , condition: CG_Sys_Image
            , success: (data) => {

            }
            , error: (err) => {

            }
        })
    }
</script>
<script>js_require('/js/comon/initialize_setting.js');</script>
<script>js_require('/js/main.js');</script>
<script>js_require('/js/customjs/custom-validation.js');</script>
