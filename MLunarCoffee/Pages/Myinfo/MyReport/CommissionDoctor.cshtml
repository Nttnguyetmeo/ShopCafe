@page
@model MLunarCoffee.Pages.Myinfo.MyReport.CommissionDoctorModel
@{
    Layout = null;
}
<script>js_require_notasync('/js/Commission/Doctor.js');</script>
<div class="row form3" id="dataDetail">

    <div class="field col-12  px-1" id="Detail_Div">
        <div class="vtcardheader card-header p-3 pb-0">
            <div class="left">
                <p id="RevenueNameDetail" class="text-md text-primary fw-bold  mb-0 ">@Local["Tên nhân viên"]</p>
                <p id="error_max_dates_show" style="display:none;" class="text-sm text-danger mb-0">
                    <span>@Local["Số ngày được xem tối đa"]</span>
                    <span class="ps-2" id="report_max_dates_show"></span>
                </p>
            </div>
            <div class="right">
                <button id="loaderList_Detail" class="btn btn-primary btn-sm ml-2 mb-2  " type="button" disabled style="display:none;">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span class="text-normal fw-bold ps-2">@Local["Đang tải dữ liệu. vui lòng chờ"]...</span>
                </button>
                <div id="RevenueNumber" class="text-primary fw-bold text-nowrap">
                    <span id="Reve_currentdata">0</span>
                    <span class="mx-2">/</span>
                    <span id="Reve_totaldata">0</span>
                    <span class="text-md fw-bold mb-0">@Local["Tổng"]:</span>
                    <span id="RevenueTotal" class="text-md fw-bold">0</span>
                </div>
                <div class="icon-hover mx-1"
                     data-bs-toggle="tooltip" data-bs-placement="top"
                     data-bs-original-title="@Local["Xuất excel"]">
                    <i class="vtt-icon  vttech-icon-export-ex text-lg text-primary cursor-pointer _tab_control_" data-tab="export_excel"
                       onclick="event.preventDefault(); return exportData_RevenueDetail()"></i>
                </div>
                <button class="btn btn-dark btn-sm mb-0 position-relative dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#colLists">
                    @Local["Xem thêm"]
                </button>
            </div>
            <div class="toggle">
                <div class="collapse position-absolute z-index-3 end-1 top-100 mt-2" id="colLists" style="min-width:250px;">
                    <ul class="card card-body text-dark text-capitalize opacity-10">
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="CustPhone" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Số điện thoại"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="CustCodeOld" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Mã khách hàng cũ"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="CustAge" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Tuổi"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="CustGender" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Giới tính"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="CustAddress" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Địa chỉ"]</p>
                        </li>

                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="CustDistrict" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Quận huyện"]</p>
                        </li>
                            
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="CustCommu" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Phường xã"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="CustCity" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Thành phố"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="SerCode" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Mã dịch vụ"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="Source" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Nguồn"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="DocCode" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Mã hồ sơ"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="ServiceType" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Loại dịch vụ"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="SalesCode" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Mã lên đơn"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="PercentOfService" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Tổng hoàn thành"]%</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="PercentNew" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Hoàn thành"]%</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="EmpName" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Tên"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="EmpCode" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Mã nhân viên"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="PriceSer" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Giá dịch vụ"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="Date" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Ngày"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="BranchName" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Chi nhánh"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="ContentTreat" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Nội dung điều trị"]</p>
                        </li>
                        <li class="d-flex">
                            <div class="form-check form-switch">
                                <input class="shtoogle form-check-input" data-name="Manual" type="checkbox">
                            </div>
                            <p class="text-sm">@Local["Chi thủ công"]</p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-body p-3 pt-0">
            <div class="m-0 my-3 mobile-responsive mb-0 vt-header-sticky" style="max-height: 66vh;">
                <table data-name="dtContentReport" class="table vt-table mb-0" id="dtContentReport">
                    <thead>
                        <tr>
                            <th class="no-sort" style="min-width: 25px;">#</th>
                            <th class="no-sort" style="min-width: 100px;">@Local["Mã khách hàng"]</th>
                            <th class="no-sort" style="min-width: 150px;">@Local["Khách hàng"]</th>
                            <th class="no-sort" style="min-width: 150px;" data-name="Source">@Local["Nguồn"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="DocCode">@Local["Mã hồ sơ"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="CustPhone">@Local["Số điện thoại"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="CustCodeOld">@Local["Mã khách hàng cũ"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="CustAge">@Local["Tuổi"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="CustGender">@Local["Giới tính"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="CustAddress">@Local["Địa chỉ"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="CustCommu">@Local["Phường xã"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="CustDistrict">@Local["Quận huyện"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="CustCity">@Local["Thành phố"]</th>
                            <th class="no-sort" style="min-width: 120px;" data-name="SerCode">@Local["Mã dịch vụ"]</th>
                            <th class="no-sort" style="min-width: 120px;">@Local["Dịch vụ"]</th>
                            <th class="no-sort" style="min-width: 120px;" data-name="ServiceType">@Local["Loại dịch vụ"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="SalesCode">@Local["Mã lên đơn"]</th>
                            <th class="no-sort" style="min-width: 100px;">@Local["Số lượng"]</th>
                            <th class="no-sort" style="min-width: 120px;" data-name="PriceSer">@Local["Giá dịch vụ"]</th>
                            <th class="no-sort" style="min-width: 120px;">@Local["Chi tiết"]</th>
                            <th class="no-sort" style="min-width: 120px;" data-name="PercentNew">@Local["Hoành thành"] %</th>
                            <th class="no-sort" style="min-width: 120px;" data-name="PercentOfService">@Local["Tổng hoàn thành"]%</th>
                            <th class="no-sort" style="min-width: 120px;" data-name="EmpName">@Local["Tên"]</th>
                            <th class="no-sort" style="min-width: 120px;" data-name="EmpCode">@Local["Mã nhân viên"]</th>
                            <th class="no-sort">@Local["Hoa hồng"]</th>
                            <th class="no-sort">@Local["Phần trăm doanh thu"]</th>
                            <th class="no-sort">@Local["Doanh thu"]</th>
                            <th class="no-sort" style="min-width: 100px;">@Local["Thu trong kỳ"]</th>
                            <th class="no-sort" style="min-width: 100px;">@Local["Tiền thu"] @Local["Dịch vụ"]</th>
                            <th class="no-sort" style="min-width: 100px;">@Local["Ghi chú hoa hồng"]</th>
                            <th style="min-width: 100px;" data-name="Date">@Local["Ngày"]</th>
                            <th class="no-sort" style="min-width: 200px;" data-name="ContentTreat">@Local["Nội dung điều trị"]</th>
                            <th class="no-sort" style="min-width: 100px;" data-name="BranchName">@Local["Chi nhánh"]</th>
                            <th class="no-sort" style="min-width: 70px;" data-name="Manual">@Local["Chi thủ công"]</th>
                        </tr>
                    </thead>
                    <tbody id="dtContentReportBody">
                    </tbody>
                </table>
            </div>
            <button id="btndetailmore" class="btn btn-secondary w-100 p-1 mt-2 position-relative mb-0" onclick="RevenueDetail_ViewMore()">
                @Local["Xem thêm"]
            </button>
        </div>
    </div>
</div>
<script>js_require('/js/comon/initialize_setting.js');</script>
<script type="text/javascript">

    //#region  // Var, contructor and Initialize
    var CurrentNameMaster = '';
    var CurrentMaster;

    let Redata_loaded = [];
    let Redata_spilited;
    let ReblockIndex = 0;
    let Renum_rendered = 0;

    let RevDataObject;
    let myLoad = 1;
    let _dateFrom = "@Model._dateFrom";
    let _dateTo = "@Model._dateTo";
    let _branchID = "@Model._branchID";

    $(document).ready(function () {
        $("#dtContentReport").tablesort();
        shtable = $("#dtContentReport").TableExpandColumn({
            shtoogle: $('.shtoogle')
        });
        RevDataObject = new RevenueDoctor({
            DateFrom: _dateFrom,
            DateTo: _dateTo,
            BranchID: _branchID,
            MyLoad: myLoad,

            fnSetting_Before: function () {
                $("#dataDetail").hide();
                $("#loaderList").show();
            },
            fnSetting_Complete: function (result) {
                $("#dataDetail").show();
                $("#loaderList").hide();
                MyCms_load();
            },

            fnDetail_Before: function () {
                $("#RevenueNumber").hide();
            },
            fnDetail_Complete: function (result) {
                $("#RevenueNumber").show();
                if (result == "0") {
                    $("#error_max_dates_show").show();
                    document.getElementById("report_max_dates_show").innerHTML = ":" + ser_maxDates;
                }
                else {
                    $("#error_max_dates_show").hide();
                }
            },
            fnDetail_CountComplete: function (result) {
                Renum_rendered = 0;
                ReblockIndex = 0;
                Redata_loaded = JSON.parse(JSON.stringify(result));
                $('#Reve_totaldata').html(formatNumber(Redata_loaded.length));
                Redata_spilited = sliceIntoChunks(JSON.parse(JSON.stringify(Redata_loaded)), 500);
                RevenueDetail_ViewMore();
            }
        });
        RevDataObject.Init();

       // LoadData_Prepare_Report(_dateFrom, _dateTo, _branchID, myLoad); //Load from file Doctor.js
        Checking_TabControl_Permission();
    });

    //#endregion

    //#region // DETAIL

    function RevenueDetail_ViewMore() {
        var p = fnRenderArray(data = Redata_spilited
            , id = "dtContentReportBody"
            , index = ReblockIndex
            , fnrender = RevenueDetail_Render
            , fnsuccess = function () { }
            , fnbegin = function () { });

        p.then(function (v) {
            ReblockIndex = v;
            if (ReblockIndex <= Redata_spilited.length) {
                $('#btndetailmore').show();
                Renum_rendered = Renum_rendered + Redata_spilited[ReblockIndex - 1].length;
                Renum_rendered = Renum_rendered > Redata_loaded.length ? Redata_loaded.length : Renum_rendered;
                $('#Reve_currentdata').html(formatNumber(Renum_rendered));
            }
            else $('#btndetailmore').hide();
        });
    }

    function RevenueDetail_Render(data, id) {
        var myNode = document.getElementById(id);
        if (myNode != null) {
            let tr = '';
            let RevenueTotal = 0;
            if (data && data.length > 0) {
                for (var i = 0; i < data.length; i++) {
                    let item = data[i];
                    tr = tr + RevenueDetail_RenderEach(item);
                    RevenueTotal += item.RealAmount;
                }
                myNode.innerHTML = myNode.innerHTML + tr;
                shtable.Refresh();
                Checking_TabControl_Permission();
            }
            if ($('#RevenueTotal').length != 0) {
                $('#RevenueTotal').html(formatNumber(RevenueTotal));
            }

        }
    }

    function RevenueDetail_RenderEach(item) {
        let tr =
            '<td class="vt-number-order"></td>'
            + '<td><a target="_blank" href="/Customer/MainCustomer?CustomerID=' + item.CustID + '">' + item.CustCode + '</a></td>'
            + '<td>' + item.CustName + '</td>'
            + '<td data-name="Source">' + Fun_GetName_ByID(RP_DataCustomerSource, item.SourceID) + '</td>'
            + '<td data-name="DocCode">' + item.DocCode + '</td>'
            + '<td data-name="CustPhone" data-name="CustPhone" class="_tab_control_" data-tab="phone_customer">' + item.CustPhone + '</td>'
            + '<td data-name="CustCodeOld">' + item.CustCodeOld + '</td>'
            + '<td data-name="CustAge">' + item.CustAge + '</td>'
            + '<td data-name="CustGender">' + `${item.CustGender == '60' ? "@Local["Nam"]" : "@Local["Nữ"]"}` + '</td>'
            + '<td data-name="CustAddress" class="_tab_control_" data-tab="address_customer"><span class="content_line_clamp">' + `${item.CustAddress}` + '</span></td>'
            + '<td data-name="CustCommu" class="_tab_control_" data-tab="address_customer">' + `${Fun_GetName_ByID(RP_DataCommune, item.CustCommuneID)}` + '</td>'
            + '<td data-name="CustDistrict" class="_tab_control_" data-tab="address_customer">' + `${Fun_GetName_ByID(RP_DataDistrict, item.CustDistrictID)}` + '</td>'
            + '<td data-name="CustCity" class="_tab_control_" data-tab="address_customer">' + `${Fun_GetName_ByID(RP_DataCity, item.CustCityID)}` + '</td>'
            + '<td data-name="SerCode">' + item.Service_Code + '</td>'
            + '<td>'
            + Fun_GetName_ByID(RP_DataService, item.ServiceID)
            + '</td>'
            + '<td data-name="ServiceType">'
            + item.ServiceType
            + '</td>'
            + '<td data-name="SalesCode">'
            + item.SalesCode
            + '</td>'
            + '<td>'
            + item.Quantity
            + '</td>'
            + '<td>'
            + formatNumber(item.Price)
            + '</td>'
            + '<td>'
            + ((Number(sys_dencos_Main) == 1)
                ? ('<span class="statustreat_row">'
                    + `${(item.TeethChoosing != '') ? Fun_GetTeeth_ByToken(DataTeeth, item.TeethChoosing, item.TeethType) : ''}`
                    + '</span>')
                : ('<span class="statustreat_row">' + (Outlang['Lan_dieu_tri'] + ' : ' + item.TimeTreatIndex + ' | ' + item.TimeTreat) + '</span>')
            )
            + '</td>'
            + '<td data-name="PercentNew">'
            + ((Number(sys_dencos_Main) == 1)
                ? ('<span>'
                    + item.NewPer
                    + '</span>')
                : ('<span>' + (Number(item.TimeTreat) != 0 ? ((Number(item.TimeTreatIndex) / Number(item.TimeTreat)) * 100).toFixed(2) : 0) + '</span>')
            )
            + '</td>'
            + '<td data-name="PercentOfService">'
            + formatNumber(item.PercentOfService)
            + '</td>'
            
            + '<td data-name="EmpName">'
            + item.Empname
            + '</td>'
            + '<td data-name="EmpCode">'
            + item.Empcode
            + '</td>'
            + '<td>'
            + (item.Commission != 0 ? formatNumber((item.Commission)) : '')
            + '</td>'
            + '<td>'
            + (item.RePercent != 0 ? item.RePercent : 100)
            + '</td>'
            + '<td>'
            + (item.RealAmount != 0 ? formatNumber((item.RealAmount)) : '')
            + '</td>'
            + '<td>' + formatNumber(item.PaymentPeriod) + '</td>'
            + '<td>' + formatNumber(item.PaymentService) + '</td>'
            + '<td>' + (item.Manual_Revenue == 1 ? `<span class="content_line_clamp">${item.Note}</span>` : '') + '</td>'
            + '<td data-name="Date">' + ConvertDateTimeUTC_DMY(item.Date) + '</td>'
            + '<td data-name="ContentTreat"><span class="content_line_clamp">' + item.Content_Follow + '</span></td>'
            + '<td data-name="BranchName">' + item.BranchName + '</td>'
                       
            
            
            + '<td data-name="Manual">'
            + (item.Manual_Revenue == 1 ? '<i class="imgGrid vtt-icon vttech-icon-check"></i>' : '')
            + '</td>'


        return '<tr class="vt-number" role="row">' + tr + '</tr>';
    }

        //#endregion

    //#region // Load affter init
    function MyCms_load() {
        CurrentNameMaster = "@Local["Hoa hồng bác sĩ của tôi"]";
        CurrentMaster = sys_employeeID_Main;
        $('#RevenueNameDetail').html(CurrentNameMaster);
        $('#dtContentReportBody').html('');
        $('#dtContentReport').removeClass('showall');
        RevDataObject.RevenueDetail_Load(sys_employeeID_Main);
        //RevenueDetail_Load(_dateFrom, _dateTo, _branchID, ser_limit, xhrRevenue);
    }
    //#endregion

    async function exportData_RevenueDetail() {
        let fileName = Outlang["Doanh_thu"] + '(' + CurrentNameMaster + ')';
        if(typeof RevDataObject.ExportDetail === 'function')
            RevDataObject.ExportDetail(fileName);
        else
            exportToExcel('dtContentReport', fileName);
    }

</script>

<style>
    #dtContentReport.showall .exact {
        display: none !important;
    }

    #dtContentReport.showall .all {
        display: table-cell !important;
    }

    #dtContentReport .all {
        display: none;
    }
</style>