@page
@model MLunarCoffee.Pages.Customer.Service.TreatmentPlan.TreatmentPlanInfoModel
@{
    Layout = null;
}

<script>js_require_notasync('/assests/js/fabric.js');</script>
<script>js_require_notasync('/js/comon/ExecuteCanvasDentalChart.js');</script>


<div class="container-fluid px-0" id="print_content">
    <div class="h-100 text-center">
        <h6 class="mb-0">@Local["Thông tin kế hoạch"]</h6>
        <p class="text-sm mb-0">@Local["Chi tiết kế hoạch"]</p>
    </div>
    <div class="multisteps-form__progress mt-4">
        <button class="prcustomer multisteps-form__progress-btn text-dark" type="button">
            <a href="#pr_generalinfo">@Local["Thông tin chung"]</a>
        </button>
        <button class="prcustomer multisteps-form__progress-btn text-dark" type="button">
            <a href="#pr_lock">@Local["Dịch vụ chốt"]</a>
        </button>
        <button class="prcustomer multisteps-form__progress-btn text-dark" type="button">
            <a href="#pr_nonlock">@Local["Dịch vụ chưa chốt"]</a>
        </button>
        <button class="prcustomer multisteps-form__progress-btn text-dark" type="button">
            <a href="#pr_image">@Local["Hình ảnh"]</a>
        </button>
    </div>
    <div class="d-lg-flex px-4" id="pr_generalinfo">
        <div class="col-w-400 mx-auto me-2 pb-2 flex-grow-1">
            <div class="card h-100">
                <div class="p-3 pb-0">
                    <div class="d-flex p-2">
                        <div class="avatar avatar-sm mt-2 shadow">
                            <img id="treatplan_cust_avatar" alt="Image placeholder" src="/default.png">
                        </div>
                        <div class="ms-2 my-auto">
                            <h6 id="treatplan_cust_name" class="mb-0"></h6>
                            <h6 id="treatplan_cust_code" class="text-xs mb-0"></h6>
                        </div>
                    </div>
                    <ul class="list-unstyled mx-auto mt-3 ps-2 mb-2">
                        <li class="d-flex">
                            <p class="_tab_control_ mb-0 text-dark text-sm" data-tab="phone_customer">
                                <span>@Local["Số điện thoại"]</span>&nbsp;:
                                <span id="treatplan_cust_phone" class="font-weight-bold ps-3"></span>
                            </p>
                        </li>
                        <li><hr class="horizontal dark my-2"></li>
                        <li class="d-flex">
                            <p class="mb-0 text-dark text-sm">
                                <span>@Local["Ngày sinh"]</span>&nbsp;:
                                <span id="treatplan_cust_birthday" class="font-weight-bold ps-3"></span>
                            </p>
                        </li>
                        <li><hr class="horizontal dark my-2"></li>
                        <li class="d-flex">
                            <p class="mb-0 text-dark text-sm">
                                <span>@Local["Giới tính"]</span>&nbsp;:
                                <span id="treatplan_cust_gender" class="font-weight-bold ps-3"></span>
                            </p>
                        </li>
                        <li><hr class="horizontal dark my-2"></li>
                        <li class="d-flex">
                            <p class="mb-0 text-dark text-sm">
                                <span>@Local["Địa chỉ"]</span>&nbsp;:
                                <span id="treatplan_cust_address" class="font-weight-bold ps-3"></span>
                            </p>
                        </li>


                    </ul>
                </div>
                <div class="card-body pt-0">
                    <div class="row px-1 form3" id="form1">
                        <div class="field col-12 px-1 mt-2">
                            <label>@Local["Kế hoạch"]</label>
                            <input id="Treatment_Plan_Name" class="form-control" name="name" type="text" />
                        </div>
                        <div class="field col-6 px-1 mt-2">
                            <label>@Local["Ngày bắt đầu"]</label>
                            <input id="Treatment_DateBegin" class="flatpickr form-control" type="text" placeholder="eg .date begin" />
                        </div>
                        <div class="field col-6 px-1 mt-2">
                            <label>@Local["Ngày kết thúc"]</label>
                            <input id="Treatment_DateEnd" class="flatpickr form-control" type="text" placeholder="eg .date end" />
                        </div>
                        <div class="field col-12 px-1 mt-2">
                            <label>@Local["Ghi chú"]</label>
                            <textarea id="Treatment_Plan_Note" class="form-control" type="text" rows="4"></textarea>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <div id="permisionChartTeeth" class="flex-grow-1 pb-2 overflow-auto" style="display: none;">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <div class="d-lg-flex">
                        <div class="h-100">
                            <h6 class="mb-0">@Local["Sơ đồ răng"]</h6>
                            <p class="text-sm mb-0">@Local["Chi tiết sơ đồ răng"]</p>
                        </div>
                    </div>
                </div>
                <div class="card-body pt-2">
                    <div id="chartDetail">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row" id="pr_detailteeth"  style="display: none;">
        <div class="col-12 mb-2">
            <div class="card mx-4 my-1">
                <div class="card-header pb-0">
                    <div class="d-lg-flex">
                        <div class="w-20 col-auto my-auto">
                            <div class="h-100">
                                <h6 class="mb-0">@Local["Tình trạng răng"]</h6>
                                <p class="text-sm mb-0">@Local["Chi tiết tình trạng răng"]</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body pt-2 ">
                    <table class="table vt-table mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th style="text-align: center; width: 70px;">@Local["Răng"]</th>
                                <th style="text-align: center; width: 250px;">@Local["Tình trạng"]</th>
                                <th style="text-align: center;width: 250px;">@Local["Điều trị"]</th>
                                <th style="text-align: center;width: 70px;">@Local["Loại"]</th>
                                <th style="text-align: center">@Local["Nội dung"]</th>
                            </tr>
                        </thead>
                        <tbody id="dentist_chart_detail_body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row" id="pr_lock">
        <div class="col-12 mb-2">
            <div class="card mx-4 my-1">
                <div class="card-header pb-0">
                    <div class="d-lg-flex">
                        <div class="w-20 col-auto my-auto">
                            <div class="h-100">
                                <h6 class="mb-0">@Local["Chi phí điều trị"]</h6>
                                <p class="text-sm mb-0">@Local["Chi phí điều trị khách hàng đã chốt"]</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body pt-2 ">
                    <table class="table vt-table mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th style="text-align: center; width: 70px;">@Local["Răng"]</th>
                                <th style="text-align: center; width: 250px;">@Local["Dịch vụ"]</th>
                                <th style="text-align: center">@Local["Đơn giá"]</th>
                                <th style="text-align: center">@Local["Số lượng"]</th>
                                <th style="text-align: center">@Local["Giảm"]</th>
                                <th style="text-align: center">@Local["Thành tiền"]</th>
                            </tr>
                        </thead>
                        <tbody id="tab_choose_list_plan_body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row" id="pr_nonlock">
        <div class="col-12 mb-2">
            <div class="card mx-4 my-1">
                <div class="card-header pb-0">
                    <div class="d-lg-flex">
                        <div class="w-20 col-auto my-auto">
                            <div class="h-100">
                                <h6 class="mb-0">@Local["Chi phí chưa chốt"]</h6>
                                <p class="text-sm mb-0">@Local["Chi phí dịch vụ chưa chốt"]</p>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="card-body pt-2 ">
                    <table class="table vt-table mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th style="text-align: center; width: 70px;">@Local["Răng"]</th>
                                <th style="text-align: center; width: 250px;">@Local["Dịch vụ"]</th>
                                <th style="text-align: center">@Local["Đơn giá"]</th>
                                <th style="text-align: center">@Local["Số lượng"]</th>
                                <th style="text-align: center">@Local["Giảm"]</th>
                                <th style="text-align: center">@Local["Thành tiền"]</th>
                            </tr>
                        </thead>
                        <tbody id="tab_list_plan_body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="pr_image">
        <div class="col-12 mb-2">
            <div class="card mx-4 my-1">
                <div class="card-header pb-0">
                    <div class="d-lg-flex">
                        <div class="w-20 col-auto my-auto">
                            <div class="h-100">
                                <h6 class="mb-0">@Local["Hình ảnh"]</h6>
                                <p class="text-sm mb-0">@Local["Chi tiết hình ảnh"]</p>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="card-body pt-2 ">
                    <div id="image_list_plan">

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-footer fixed-botombutton">
        <div class="action_Save mt-2">
            <div class="action_Save-Content">
                <button class="btn btn-secondary" onclick="Tab_List_Service_Close_Detail()">@Local["Đóng"]</button>
                <button id="treat_plan_info_edit" type="button" class="btn bg-gradient-primary mt-2 me-2" onclick="Execute_Treat_Update()">@Local["Lưu"]</button>
            </div>
        </div>
    </div>
</div>


<script>js_require('/js/comon/initialize_setting.js');</script>

<script type="text/javascript">

    let _TreatmentPlanID ='@Model._TreatmentPlanID' ;
    let _PatientRecordID = '@Model._PatientRecordID';
    let _CustomeID ='@Model._CustomerID';
    var CurrentStatusTeethID = 0;
    var DataTeeth;

    $(document).ready(function () {
        if (((ser_sys_Treatment_Plan == 0 && ser_sys_Patient_Record == 0) || ser_sys_Patient_Record == 0) || sys_dencos_Main == 0) {
            $("#permisionChartTeeth, #pr_detailteeth").hide();
        }
        else $("#permisionChartTeeth, #pr_detailteeth").show();

        Master_IndexDB_Reads(_Session_Data, [_Session_Teeth]
            , function (data) {
                DataTeeth = data[0];
                LoadataInfoTreatmentPlan();
            });

        Checking_TabControl_Permission();
    });

    function LoadDentistChartTeeth(StatusTeethID, Type) {
        $('#chartDetail').empty();
        let url = '/Customer/DentistChart/DentistChartDetail_';
        CurrentStatusTeethID = StatusTeethID;
        if (Number(Type) == 1) {
            url += "TeethChart";
        }
        else {
            url += "TeethChart_Child";
        }
        $("#chartDetail").load(url + "?ver=" + versionofWebApplication);
        Load_Chart_Teeth_Detail(StatusTeethID);

    }
    function Load_Chart_Teeth_Detail (CurrentID) {
        AjaxLoad(url = "/Customer/Service/TreatmentPlan/TreatmentPlanInfo/?handler=Load_Chart_Teeth_Detail"
            , data = { "CurrentID": CurrentID }
            , async = true
            , error = function () { notiError_SW() }
            , success = function (result) {
                if (result != "[]") {
                    let data = JSON.parse(result);
                    let dataDentist = data.Table;
                    let dataClassification = data.Table1;
                    if (dataDentist.length > 0) {
                        Render_Teeth_Detail(dataDentist, 'dentist_chart_detail_body');
                        $('#dentist_chart_detail').show();
                    }
                    else
                        $('#dentist_chart_detail').hide();
                }
            }
        );
        return false;
    }

    function Execute_Treat_Update() {
        let name = $('#Treatment_Plan_Name').val();
        let dateBegin = $('#Treatment_DateBegin').val();
        let dateEnd = $('#Treatment_DateEnd').val();
        let note = $('#Treatment_Plan_Note').val();
        if ($('#form1').form('is valid')) {
            AjaxLoad(url = "/Customer/Service/TreatmentPlan/TreatmentPlanInfo/?handler=ExcuteData"
                , data = {
                    'CurrentID': _TreatmentPlanID
                    , 'name': name
                    , 'dateBegin': dateBegin
                    , 'dateEnd': dateEnd
                    , 'note': note}
                , async = true
                , error = function () { notiError_SW() }
                , success = function (result) {
                    if (result == "1") {
                        notiSuccess();
                        if (typeof Tab_List_Customer_Treatment_Plant_Load !== 'undefined' && $.isFunction(Tab_List_Customer_Treatment_Plant_Load))
                            Tab_List_Customer_Treatment_Plant_Load(ser_current_patient_record);
                        Tab_List_Load_InitializeData();
                    } else {
                        notiError_SW();
                    }
                }
            );
            Tab_List_Service_Close_Detail();
            return false;
        }
    }

    function LoadataInfoTreatmentPlan() {
        AjaxLoad(url = "/Customer/Service/TreatmentPlan/TreatmentPlanInfo/?handler=Loadata"
            , data = {
                "TreatmentPlanID": _TreatmentPlanID
                , "PatientRecordID": _PatientRecordID
                , "CustomeID": _CustomeID
            }
            , async = true
            , error = function () { notiError_SW() }
            , success = function (result) {
                if (result != "") {
                    let data = JSON.parse(result);
                    let dataTreatPlan = data.Table;
                    let dataCustInfo = data.Table1[0];
                    let dataTabService = data.Table2;
                    let dataFolder = data.Table3;
                    let dataImage = data.Table4;
                    let currDate = new Date();
                    $('#Treatment_Plan_Name').val(dataTreatPlan[0].TreatPlanName)

                    let T_DateBegin = flatpickr('#Treatment_DateBegin', {
                        showAlways: false,
                        altInput: true,
                        altFormat: 'd-m-Y',
                        minDate: new Date(),
                        maxDate: $('#Treatment_DateEnd').attr('value'),
                        onClose: function (selectedDates, dateStr, instance) {
                            let startDate = ConvertString_YMD_To_DateTime(dateStr);
                            let endDate = ConvertString_YMD_To_DateTime(T_DateEnd.input.value);
                            T_DateEnd.set('minDate', dateStr);
                            if (startDate > endDate) {
                                T_DateEnd.setDate(startDate);
                            }
                        },
                    });
                    T_DateBegin.setDate(dataTreatPlan[0].TreatPlanDateBegin);
                    let T_DateEnd = flatpickr('#Treatment_DateEnd', {
                        showAlways: false,
                        altInput: true,
                        altFormat: 'd-m-Y',
                        minDate: $('#Treatment_DateBegin').attr('value'),
                        defaultDate: new Date(currDate.setMonth(currDate.getMonth() + 1)),
                        onClose: function (selectedDates, dateStr, instance) {
                            T_DateBegin.set('maxDate', dateStr);
                        },
                    });
                    T_DateEnd.setDate(dataTreatPlan[0].TreatPlanDateEnd);

                    $('#Treatment_Plan_Note').val(dataTreatPlan[0].TreatPlanNote)
                    if (dataTreatPlan[0].IsEdit == 0) {
                        $('#Treatment_Plan_Name').prop("disabled", true);
                        $('#Treatment_Plan_Note').prop("disabled", true);
                        $('#treat_plan_info_edit').remove();
                    }
                    $('#treatplan_cust_code').html(dataCustInfo.CustCode);
                    $('#treatplan_cust_name').html(dataCustInfo.Cust_Name);
                    $('#treatplan_cust_phone').html(dataCustInfo.Cust_Phone);
                    $('#treatplan_cust_avatar').attr('src', dataCustInfo.Cust_Avatar != "" ? dataCustInfo.Cust_Avatar : Master_Default_Pic);
                    $('#treatplan_cust_birthday').html(dataCustInfo.Cust_Birthday);
                    $('#treatplan_cust_gender').html(dataCustInfo.Cust_Gender);
                    $('#treatplan_cust_address').html(dataCustInfo.Cust_Address);

                    let dataTabChoose = dataTabService.filter(a => a.IsChoose == 1);
                    let dataTabUnChoose = dataTabService.filter(a => a.IsChoose == 0);

                    if (dataTabChoose.length > 0)
                        RenderTreatmentPlanTabService(dataTabChoose, 'tab_choose_list_plan_body');

                    if (dataTabUnChoose.length > 0)
                        RenderTreatmentPlanTabService(dataTabUnChoose, 'tab_list_plan_body');
                    if (dataTreatPlan[0].StatusTeethID != 0)
                        LoadDentistChartTeeth(dataTreatPlan[0].StatusTeethID, dataTreatPlan[0].StatusTeethType)
                    Render_Folder_Image_List(dataFolder, dataImage, 'image_list_plan');
                }
            }
        );
        return false;
    }
    function RenderTreatmentPlanTabService(data, id) {
        var myNode = document.getElementById(id);
        if (myNode != null) {
            myNode.innerHTML = '';
            let stringContent = '';
            if (data && data.length > 0) {
                for (var i = 0; i < data.length; i++) {
                    let item = data[i];
                    let tr ='<td class="vt-number-order"></td>'
                        +'<td class="center">' + Fun_GetTeeth_ByToken(DataTeeth, item.TeethChoosing, item.TeethType) + '</td>'
                        + '<td class="center">' + item.ServiceName + '</td>'
                        + '<td class="center">' + formatNumber(item.UnitPrice) + '</td>'
                        + '<td class="center">' + item.Quantity + '</td>'
                        + '<td class="center">' + formatNumber(item.Price_Discounted - item.PriceRoot) + '</td>'
                        + '<td class="center">' + formatNumber(item.Price_Discounted) + '</td>'

                    stringContent = stringContent + '<tr class="vt-number" role="row">' + tr + '</tr>';
                }
            }
            $('#' + id).html(stringContent);
        }
    }
    function Render_Teeth_Detail(data, id) {
        var myNode = document.getElementById(id);
        if (myNode != null) {
            myNode.innerHTML = '';
            let stringContent = '';
            if (data && data.length > 0) {
                for (var i = 0; i < data.length; i++) {
                    let item = data[i];
                    let teethname = item.teethname + ((item.typecircle != '') ? (' ( ' + item.typecircle.toUpperCase() + ' )') : (''));
                    let tr ='<td class="vt-number-order"></td>'
                        +'<td>' + teethname + '</td>'
                        + '<td>' + item.diseasename + '</td>'
                        + '<td>' + item.proposedtreat + '</td>'
                        + '<td>' + item.classification + '</td>'
                        + '<td>' + item.note + '</td>'


                    stringContent = stringContent + '<tr class="vt-number" role="row">' + tr + '</tr>';
                }
            }
            $('#' + id).html(stringContent);
        }
    }
    function Render_Folder_Image_List(dataFolder, dataImage, id) {
        var myNode = document.getElementById(id);
        if (myNode != null) {
            myNode.innerHTML = '';
            let stringContent = '';
            if (dataFolder && dataFolder.length > 0) {
                for (var i = 0; i < dataFolder.length; i++) {
                    let item = dataFolder[i];
                    let tr = '<div class="treatment_plan_image" style="margin:0 4rem;">'
                        + '<div class="text-center p-3">' + item.FolderName + '</div>'
                    let ImageByFolder = dataImage.filter(a => a.FolderID == item.ID);
                    for (var j = 0; j < ImageByFolder.length; j++) {
                        tr += '<div class="ui card">'
                            + '<div class="image">'
                            + '<img style="width: 100%;height: 100%;object-fit: cover;" src="' + ImageByFolder[j].link + '">'
                            + '</div>'
                            + '</div>'
                    }

                    stringContent += tr + '</div>';
                }
            }
            $('#' + id).html(stringContent);
        }
    }
</script>
<script src="/js/main.js"></script>
<script src="/js/customjs/custom-validation.js"></script>


