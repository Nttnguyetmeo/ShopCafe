@page
@model MLunarCoffee.Pages.CustomerCare.CustomerCare_AfterTreatmentModel
@{
    if (@Model.layout == "none") Layout = null;
}
@Html.AntiForgeryToken()
<script>js_require('/js/comon/initialize_setting.js');</script>
<script>js_require('/js/main.js');</script>
<div class="row">
    <div class="col-12 p-0">
        <div class="card card-plain">
            <div class="vtcardheader card-header pb-0">
                <div class="left">
                    <ul class="nav nav-pills p-0 bg-transparent permissionlist" role="tablist">
                        <li class="nav-item me-3" role="presentation">
                            <a class="nav-link cursor-pointer active" data-bs-toggle="collapse" href="#CustCareAreaFill">
                                <i class="text-gradient text-primary fas fa-filter"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <h6 class="mb-0 mt-1">@Local["Chăm sóc khách hàng sau điều trị"]</h6>
                            <p class="text-sm mb-0">@Local["Danh sách khách hàng"]</p>
                        </li>
                    </ul>
                </div>
                <div class="right">
                    <div class="wrap">
                        <div class="wrapblock pb-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input type_show" type="radio" name="inlineRadioOptions" value="0" onchange="event.preventDefault();return CustCare_Filter();" checked="">
                                <label class="mb-0 form-check-label">@Local["Tất cả"]</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input type_show" type="radio" name="inlineRadioOptions" value="1" onchange="event.preventDefault();return CustCare_Filter();">
                                <label class="mb-0 form-check-label">@Local["Chưa xử lý"]</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input type_show" type="radio" name="inlineRadioOptions" value="2" onchange="event.preventDefault();return CustCare_Filter();">
                                <label class="mb-0 form-check-label">@Local["Đã xử lý"]</label>
                            </div>
                        </div>
                        <div class="wrapblock pb-2">
                            <div class="form-group mb-0">
                                <div class="input-group mb-0">
                                    <span class="input-group-text fw-bold text-primary ">@Local["Tổng"]</span>
                                    <span class="form-control fw-bolder text-dark ps-2" style="width:100px;max-width:100px;" id="lbTotalCustCare">0</span>
                                </div>
                            </div>
                            <button class="btn w-100 btn-dark m-0" onclick="event.preventDefault();return CustCare_Export();">@Local["Xuất"]</button>                            
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body pt-0">
                <div class="vtcondition">
                    <div class="row collapsesticky z-index-sticky collapse" id="CustCareAreaFill">
                        <div class="col-12 col-md-12 col-xl-4 p-1">
                            <div class="input-group">
                                <div class="input-group-text input-group-text px-2">
                                    <i class="fas fa-search" aria-hidden="true"></i>
                                    <div class="spinner-border spinner-border-sm d-none"></div>
                                </div>
                                <input id="CustCareSearchInput" type="text" class="form-control" placeholder="eg .@Local["Tìm kiếm khách hàng"]" autocomplete="off">
                                <div class="input-group-text"><i class="btn_clear fas fa-minus-circle opacity-1"></i></div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-xl-2 p-1">
                            <div class="ui fluid search selection dropdown form-control" id="CustCareStaffID">
                                <input type="hidden" name="employee" />
                                <input class="search" autocomplete="off" tabindex="0" />
                                <div class="text"></div>
                                <div id="cbbCustCareStaffID" class="menu" tabindex="-1">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-xl-2 p-1">
                            <div class="ui fluid search selection dropdown form-control" id="CustCareCCStaff">
                                <input type="hidden" name="sertype" />
                                <input class="search" autocomplete="off" tabindex="0" />
                                <div class="text"></div>
                                <div id="cbbCustCareCCStaff" class="menu" tabindex="-1">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-xl-2 p-1">
                            <div class="ui fluid search selection dropdown form-control" id="CustCareBranchID">
                                <input type="hidden" name="branch" />
                                <input class="search" autocomplete="off" tabindex="0" />
                                <div class="text"></div>
                                <div id="cbbCustomerCareBranch" class="menu" tabindex="-1">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-xl-2 p-1">
                            <div class="ui fluid search selection dropdown form-control" id="CustCareSerTypeID">
                                <input type="hidden" name="sertype" />
                                <input class="search" autocomplete="off" tabindex="0" />
                                <div class="text"></div>
                                <div id="cbbCustCareSerType" class="menu" tabindex="-1">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-xl-4 p-1">
                            <div class="input-group mb-0 flex-nowrap">
                                <div class="ui fluid search selection dropdown" id="CustCareTypeDate" style="width:30%;">
                                    <input type="hidden" name="employee" />
                                    <input class="search" autocomplete="off" tabindex="0" />
                                    <div class="default text"></div>
                                    <div id="CustCareCbbTypeDate" class="menu" tabindex="-1">
                                    </div>
                                </div>
                                <input id="CustCareDate" class="form-control flatpickr" type="text" placeholder="eg .@Local["Ngày"]" />
                                <div class="input-group-text p-0 pe-2">
                                    <div class="position-relative d-inline">
                                        <a class="cursor-pointer px-2" data-bs-toggle="collapse" role="tab" data-bs-target="#DivSearchDate">
                                            <i class="text-gradient text-primary fas fa-filter"></i>
                                        </a>
                                        <div class="collapse collapsesticky position-absolute z-index-3 end-1 top-100 mt-1" id="DivSearchDate" style="min-width:285px;">
                                            <div class="card card-body text-dark text-capitalize opacity-10">
                                                <div class="field col-12 mt-2">
                                                    <div class="input-group w-100">
                                                        <div class="input-group-text border-start border-end position-relative cursor-pointer custcare_defaultyesterday px-1 w-60" data-value="1">
                                                            <div class="fw-bold px-2">@Local["Một ngày trước"]</div>
                                                        </div>
                                                        <div class="input-group-text border-end position-relative cursor-pointer _tab_control_ custcare_defaultyesterday px-1 w-40" data-value="0">
                                                            <div class="fw-bold px-2">@Local["Hôm nay"]</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-xl-2 p-1">
                            <div class="ui fluid search selection dropdown form-control" id="CustCareCallID">
                                <input type="hidden" name="sertype" />
                                <input class="search" autocomplete="off" tabindex="0" />
                                <div class="text"></div>
                                <div id="cbbCustCareCallID" class="menu" tabindex="-1">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-xl-2 p-1">
                            <div class="ui fluid search selection dropdown form-control" id="CustCareStatusID">
                                <input type="hidden" name="sertype" />
                                <input class="search" autocomplete="off" tabindex="0" />
                                <div class="text"></div>
                                <div id="CbbCustCareStatusID" class="menu" tabindex="-1">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-xl-2 p-1">
                            <div class="ui fluid search selection dropdown form-control" id="CustCareStatusCallID">
                                <input type="hidden" name="sertype" />
                                <input class="search" autocomplete="off" tabindex="0" />
                                <div class="text"></div>
                                <div id="CbbCustCareStatusCallID" class="menu" tabindex="-1">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-xl-2 p-1">
                            <button class="btn bg-gradient-primary m-0" onclick="event.preventDefault();return CustCare_LoadData();">@Local["OK"]</button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="m-0 mt-1 position-relative">
                        <div id="CustomerCare_waiting" class="waitingdiv text-center position-absolute top-0 start-50 translate-middle-x z-index-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">@Local["Đang tải"]...</span>
                            </div>
                        </div>
                        <div class="row px-2 h-100">
                            <div class="col-12 col-sm-6 col-md-4 col-xl-3 p-1">
                                <div class="overflow-auto stickytable" style="max-height:calc(100vh - 289px);">
                                    <ul id="dtContentCustCareBody" class="list-group block-horizontal ShowHasHandle ShowNoHandle ShowTreat ShowCons">
                                    </ul>
                                </div>
                                <button class="btn btn-secondary btnsysmore w-100 p-1 mt-2 mb-0 d-none" id="CustCare_BtnLoadMore" onclick="CustCare_LoadData('0', 1)">@Local["Xem thêm"]</button>
                            </div>
                            <div class="col-12 col-sm-6 col-md-8 col-xl-9 p-1">
                                <div id="CustomerCare_Empty" class="mx-auto text-center">
                                    <h5 class="mb-0">@Local["Chăm sóc khách hàng sau điều trị"]</h5>
                                    <p>@Local["Chọn khách hàng để tiến hành chăm sóc"]</p>
                                </div>
                                <div id="CustomerCare_Area" class="card h-100 d-none">
                                    <div class="card-header  p-2">
                                        <div class="d-lg-flex">
                                            <div class=" col-auto my-auto">
                                                <div class="text-dark ms-2  text-sm">
                                                    <div>
                                                        <a id="cc_custcode" target="_blank" href="#" class="border-1 border-primary border-bottom cursor-pointer"></a>
                                                        <i class="text-sm text-dark vtt-icon vttech-icon-call-action"></i>
                                                        <a id="cc_custphone" onclick="CCAction_Call(this);" class="text-dark cursor-pointer">
                                                            <span class="_tab_control_" data-tab="phone_customer" id="cc_Phone"></span>
                                                        </a>
                                                        <i class="fas fa-sms text-md text-md text-dark ms-2"></i>
                                                        <a class="ms-1 cursor-pointer text-dark text-sm" onclick="CCAction_SendSMS();">
                                                            SMS
                                                        </a>
                                                    </div>

                                                    <div class="d-block text-sm fw-bold mt-1">
                                                        <span id="cc_custname" class="mb-0 mt-2"></span> - 
                                                        <span id="cc_custgender" class="mb-0 mt-2"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="ms-auto my-auto mt-1 d-flex">
                                                <div id="cc_groupname" class="p-1" data-bs-toggle="tooltip" title="" data-bs-original-title="">
                                                    <img class="cursor-pointer icon icon-shape icon-sm me-2 shadow text-center" id="cc_groupimg" src="/default.png" alt="label-image" onerror="Master_OnLoad_Error_Image(this)">
                                                </div>
                                                <button class="btn bg-gradient-primary btn-sm ms-2 my-1" onclick="CCAction_New()">@Local["Thêm mới"]</button>

                                            </div>
                                        </div>
                                        <hr class="horizontal dark mt-3 mb-2">
                                    </div>

                                    <div id="cc_detailarea" class=" card-body overflow-auto overflow-x-hidden" style="height:calc(100vh - 330px);">
                                    </div>
                                    <button id="cc_btnloadmore" class="btn btnsysmore btn-secondary w-100 p-1 mt-1 mb-0 position-absolute bottom-0" onclick="event.preventDefault(); return CustCare_RenderMore();">
                                        @Local["Xem thêm"]
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let TypeCustomerCare = 5;
    //#region // Declare && Initialization
    let sysUserID = @Model.sys_UserID;
    let sysPermissionTele = @Model.sys_Permission_Tele;
    let DtCustCare = [];
    let CustCareExport = [];
    let CustCareDataBranch = {};
    let CustCareTypeCare = {};
    let CustCareDataTeeth = '';
    let CustCareType = TypeCustomerCare;
    let CustCareLimit = 200;
    let CustCareBeginID = 0;
    let xhrRequestCustCare;
    let CustCareTreatid = 0;
    let AfterTreatDataEmployee;
   // let CustCareAfterTreatid = 0;
    let CustCareCustid = 0;
    let CustCareDate = 0;
    let DataMainSlice;
    let IndexTable = 0;
    let CustCareTypeDate = [
        {"ID" : 1 , "Name": "@Local["Ngày tạo"]"}
        , {"ID" : 2 , "Name": "@Local["Ngày xử lý"]"}
        , {"ID" : 3 , "Name": "@Local["Ngày gọi lại"]"}
    ];
    //#endregion
    //#region // Load Data
    $(document).ready(function () {
        CustCare_EventHandle();
        $("#CustCareDate").flatpickr({
            mode: "range",
            dateFormat: 'd-m-Y',
            enableTime: false,
            onClose: function (selectedDates, dateStr, instance) {
                if (selectedDates.length == 1) {
                    instance.setDate([selectedDates[0], selectedDates[0]], true);
                }
                if (selectedDates.length != 1) {
                    var diffDays = Math.abs(selectedDates[1] - selectedDates[0]) / (1000 * 60 * 60 * 24);
                    if (diffDays > 31) {
                        instance.setDate([selectedDates[0], selectedDates[0]], true);
                    }
                }
            }
        });
        let dateYes = 0;
        let dataDefaultDate = localstorage_get('CustCare_DefaultYesterday');
        if (dataDefaultDate != '') {
            dateYes = Number(JSON.parse(dataDefaultDate).data);
            $('.custcare_defaultyesterday[data-value="' + dateYes + '"]').trigger('click');
        } else {
            $('.custcare_defaultyesterday[data-value="0"]').trigger('click');
        }



        Master_IndexDB_Reads(_Session_Data, [_Session_Teeth, _Session_Employee]
            , function (data) {
                CustCareDataTeeth = data[0];
                AfterTreatDataEmployee = data[1];
                CustCare_Initialization();
            }
        );

    })
    $(document).mouseup(function (e) {
        let DivFillDate = $('#DivSearchDate');
        if (!DivFillDate.is(e.target ) && DivFillDate.has(e.target).length === 0){
            $('#DivSearchDate').collapse('hide');
        }
    })
    function CustCare_Initialization() {
        AjaxLoad(url = "/CustomerCare/CustomerCare_AfterTreatment/?handler=Initialization"
            , data = {}
            , async = true
            , error = null
            , success = function (result) {
                if (result != '[]') {
                    let data = JSON.parse(result);
                    let DtStatus = data?.TypeCare.filter(item => item["ParentID"] == 0);
                    let DtStatusDetail = data?.TypeCare.filter(item => item["ParentID"] != 0);
                    CustCareTypeCare = (data?.TypeCare).reduce((pre, acc) => {pre[acc.ID] = acc; return pre;}, {});
                    CustCareDataBranch = (data.Branch).reduce((pre, acc) => { pre[acc.ID] = acc; return pre; }, {})
                    Load_Combo(data.Branch, "cbbCustomerCareBranch", true, '@Local["Chi nhánh"]');
                    Load_Combo(data.Tele, "cbbCustCareStaffID", true, '@Local["Tele phụ trách"]');
                    Load_Combo(data.SerType, "cbbCustCareSerType", true, '@Local["Nhóm dịch vụ"]');
                    Load_Combo(data.ParaCall, "cbbCustCareCallID", true, '@Local["Trạng thái gọi"]');
                    Load_Combo(data.TeleCare, "cbbCustCareCCStaff", true, '@Local["Nhân viên chăm sóc"]');
                    Load_Combo(CustCareTypeDate, "CustCareCbbTypeDate", true, '@Local["Ngày"]');
                    Load_Combo(DtStatus, "CbbCustCareStatusID", true, '@Local["Trạng thái"]');
                    Load_Combo(DtStatusDetail, "CbbCustCareStatusCallID", true, '@Local["Trạng thái chi tiết"]');

                    $("#CustCareBranchID").dropdown("refresh");
                    $("#CustCareBranchID").dropdown("set selected", "0");

                    $("#CustCareStaffID").dropdown("refresh");
                    $("#CustCareStaffID").dropdown("set selected", (Number(sysPermissionTele) == 0 ? "0" : sysUserID));

                    $("#CustCareSerTypeID").dropdown("refresh");
                    $("#CustCareSerTypeID").dropdown("set selected", "0");

                    $("#CustCareCallID").dropdown("refresh");
                    $("#CustCareCallID").dropdown("set selected", "0");

                    $("#CustCareCCStaff").dropdown("refresh");
                    $("#CustCareCCStaff").dropdown("set selected", "0");

                    $("#CustCareTypeDate").dropdown("refresh");
                    $("#CustCareTypeDate").dropdown("set selected", "0");

                    $("#CustCareStatusID").dropdown("refresh");
                    $("#CustCareStatusID").dropdown("set selected", "0");

                    $("#CustCareStatusCallID").dropdown("refresh");
                    $("#CustCareStatusCallID").dropdown("set selected", "0");
                    CustCare_LoadData();
                }
            }
        );
    }
    async function CustCare_LoadData (currentID = "0", isLoadMore = 0) {
        return new Promise((resolve, reject) => {
            if (xhrRequestCustCare && xhrRequestCustCare.readyState != 4) xhrRequestCustCare.abort();
            if (currentID == "0" && isLoadMore == 0) {
                CustCareBeginID = 0;
                $('#dtContentCustCareBody').html('');
                DtCustCare = [];
                CustCareExport= [];
            }
            if (currentID != "0") CustCareBeginID = 0;

            let data = new Object();
            let branchid = $('#CustCareBranchID').dropdown('get value') ? $('#CustCareBranchID').dropdown('get value') : "0";
            let SearchText = $("#CustCareSearchInput").val() ? $("#CustCareSearchInput").val() : "";
            let branchToken = branchid == 0 ? Object.values(CustCareDataBranch).map(e => e.ID).join(',') : '';
            data.BranchID = branchid;
            data.BranchToken = branchToken;
            data.StaffID = Number($('#CustCareStaffID').dropdown('get value')) ? Number($('#CustCareStaffID').dropdown('get value')) : "0";
            data.CCStaffID = Number($('#CustCareCCStaff').dropdown('get value')) ? Number($('#CustCareCCStaff').dropdown('get value')) : "0";
            data.SerTypeID = Number($('#CustCareSerTypeID').dropdown('get value')) ? Number($('#CustCareSerTypeID').dropdown('get value')) : "0";
            data.CallID = $('#CustCareCallID').dropdown('get value') ? Number($('#CustCareCallID').dropdown('get value')) : "0";
            data.TypeDate = $('#CustCareTypeDate').dropdown('get value') ? Number($('#CustCareTypeDate').dropdown('get value')) : "0";
            data.SearchText = xoa_dau(SearchText).toLowerCase().trim().replace(/[^a-zA-Z0-9 ]/g, '');
            data.statusCallID = $('#CustCareStatusCallID').dropdown('get value') ? Number($('#CustCareStatusCallID').dropdown('get value')) : "0";
            data.statusID = $('#CustCareStatusID').dropdown('get value') ? Number($('#CustCareStatusID').dropdown('get value')) : "0";


            let date = $("#CustCareDate").val() ? $("#CustCareDate").val() : new Date();
            let dateFrom;
            let dateTo;

            if (date.includes(" to ")) {
                date = date.replace(" to ", "#");
                dateFrom = date.split('#')[0];
                dateTo = date.split('#')[1];
            }
            else {
                dateFrom = date;
                dateTo = date;
            }

            xhrRequestCustCare = AjaxLoad(url = "/CustomerCare/CustomerCare_AfterTreatment/?handler=LoadData"
                , data = {
                    'data': JSON.stringify(data)
                    , 'DateFrom': dateFrom
                    , 'DateTo': dateTo
                    , 'currentID': currentID
                    , 'BeginID': CustCareBeginID
                    , 'Limit': CustCareLimit
                }
                , async = true
                , error = function () { notiError_SW() }
                , success = function (result) {
                    let data = JSON.parse(result);
                    if (data != undefined) {
                        if (data.length != 0) {
                            $("#CustCare_BtnLoadMore").removeClass("d-none");
                            let stringContent = '';
                            if (currentID == "0") {
                                fnRenderBlock(data, "dtContentCustCareBody"
                                    , blocknum = 30
                                    , fnrender = CustCare_RenderData
                                    , fnsuccess = null
                                );
                                DtCustCare = DtCustCare.concat(data);
                            }
                            else {
                                let _id = $('#CustCareRow_' + currentID);
                                if (_id != undefined && _id.length != 0) {
                                    for (let i = 0; i < DtCustCare.length; i++) {
                                        if (DtCustCare[i].TreatID == currentID) {
                                            DtCustCare[i] = data[0];
                                        }
                                    }
                                    stringContent = CustCare_RenderEach(data[0]);
                                    _id.replaceWith(stringContent);
                                    $("input[name=inlineRadioOptions]").trigger("change");
                                    $('#CustCareRow_' + currentID).trigger('click');
                                }
                                ToolPopper();
                            }
                        }
                        else {
                            if (currentID != "0") {
                                DtCustCare = DtCustCare.filter((item) => {return (item.TreatID != currentID)})
                                let _id = 'CustCareRow_' + currentID;
                                $("#" + _id).remove();
                                $("input[name=inlineRadioOptions]").trigger("change");
                            }
                            else {
                                if (isLoadMore == 0) {
                                    $('#dtContentCustCare').hide();
                                }
                            }
                            if (DtCustCare && DtCustCare.length == 0 && $('#CustomerCare_Empty').hasClass('d-none')){
                                $('#CustomerCare_Area').addClass('d-none');
                                $('#CustomerCare_Empty').removeClass('d-none');
                                $("#CustCare_BtnLoadMore").addClass("d-none");
                            }
                        }
                        CustCareBeginID = (DtCustCare && DtCustCare.length > 0) ? DtCustCare[DtCustCare.length - 1].TreatID : 0;
                        $("#lbTotalCustCare").html(formatNumber($(".CustCareRow:visible").length))
                    }
                }
                , sender = null
                , before = function (e) {
                    $('#CustomerCare_waiting').show();
                }
                , complete = function (e) {
                    $('#CustomerCare_waiting').hide();
                }
            );

        });
    }
    async function CustCare_RenderData(data, id) {
        new Promise((resolve, reject) => {
            setTimeout(() => {
                var myNode = document.getElementById(id);
                if (myNode != null) {
                    if (data && data.length > 0) {
                        for (var i = 0; i < data.length; i++) {
                            let item = data[i];
                            let tr = CustCare_RenderEach(item);
                            myNode.insertAdjacentHTML("beforeend", tr);
                            Checking_TabControl_Permission();
                        }
                    }
                }
                $("input[name=inlineRadioOptions]").trigger("change");
                $('#dtContentCustCareBody').find('.CustCareRow:visible:first').trigger("click");
                ToolPopper();
                resolve();
            }, 10)
        });
    }
    function CustCare_RenderEach(item) {
        let isexecuted = 'checklist-item-secondary', iscallback = '';
        if (item.IsTakeCare == 1) isexecuted = 'checklist-item-success';
        if (item.IsCallback == 1){
            iscallback = `
            <div class="ms-3">
                            <p class="text-xs mb-0 text-secondary font-weight-bold">@Local["Ngày gọi lại"]</p>
                        <span class="text-sm text-dark">${GetDateTime_String_DMY(item.CallBackTime)}</span>
                     </div>
                     `
        }
        let tr = `
            <li id="CustCareRow_${item.TreatID}" data-treatid="${item.TreatID}"  data-date="${item.NumTreat}" data-custid="${item.CustID}" class="CustCareRow checklist-item ${item.IsTakeCare == 0 ? `checknone` : `CheckHas`} ${isexecuted} list-group-item border-0 flex-column align-items-start py-0 mt-2 py-2 border-radius-lg cursor-pointer">
                <div class="d-flex align-items-center">
                    <a class="border-bottom border-primary code col-auto fw-bold mb-0 mt-0 my-auto text-primary text-sm" target="_blank" href="/Customer/MainCustomer?CustomerID=${item.CustID}">${item.CustCode}</a> <span class="text-sm ms-2 text-dark"> - ${item.CustName} </span>
                </div>
                <div class="d-flex align-items-center mt-1">
                    <div>
                    <p class="text-xs mb-0 text-secondary font-weight-bold">${item.TreatID != 0 ? `@Local["Ngày điều trị"]` : `@Local["Ngày tư vấn"]`}</p>
                    <span class="text-sm text-dark">${item.TreatID != 0 ? ConvertYMDInt_ToDate(item.NumTreat) : ConvertYMDInt_ToDate(item.NumDateFrom)}</span>
                    <span data-name="phone" class="_tab_control_ cursor-pointer d-none" data-tab="phone_customer" data-checkper="1">*******999</span>
                    </div>
                        ${iscallback}
                </div>

            </li>
        `
        return tr;
    }
    //#endregion


    //#region // Load data Detail
    async function CustCare_LoadDetail(cus, numcreated) {
        return new Promise((resolve, reject) => {
            if (xhrRequestCustCare && xhrRequestCustCare.readyState != 4) xhrRequestCustCare.abort();
            IndexTable = 0;
            xhrRequestCustCare = AjaxLoad(url = "/CustomerCare/CustomerCare_AfterTreatment/?handler=LoadDetail"
                , data = {
                    'cus': cus
                    , 'numcreated': numcreated
                }
                , async = true
                , error = function () { notiError_SW() }
                , success = function (result) {
                    let datas = JSON.parse(result);
                    if (datas != undefined) {
                        CustCare_FillInfo(datas.Table);
                        let detailData = [...datas.Table1];
                        DataMainSlice = sliceIntoChunks(detailData, 500);


                        $("#cc_detailarea").empty();
                        $('#cc_btnloadmore').removeClass('d-none');


                        if (DataMainSlice && DataMainSlice.length != 0) {
                            //fnRenderBlock(DataMainSlice[IndexTable], "cc_detailarea"
                            //    , blocknum = 100
                            //    , fnrender = CustCare_RenderDetail
                            //    , fnsuccess = null
                            //);
                            CustCare_RenderDetail(DataMainSlice[IndexTable], "cc_detailarea");
                        }
                    }
                }
                , sender = null
                , before = function (e) {
                    $('#CustomerCare_waiting').show();
                }
                , complete = function (e) {
                    $('#CustomerCare_waiting').hide();
                }
            );

        });
    }

    function CustCare_RenderMore() {
        IndexTable += 1;
        if (DataMainSlice && DataMainSlice[IndexTable]) {
            //fnRenderBlock(DataMainSlice[IndexTable], "cc_detailarea"
            //    , blocknum = 100
            //    , fnrender = CustCare_RenderDetail
            //    , fnsuccess = null
            //);
            CustCare_RenderDetail(DataMainSlice[IndexTable], "cc_detailarea");
        }
        if (!$('#cc_btnloadmore').hasClass('d-none') && IndexTable >= DataMainSlice.length - 1) {
            $('#cc_btnloadmore').addClass('d-none');
        }
    }

    async function CustCare_FillInfo(dataInfo) {
        new Promise((resolve, reject) => {
            let item = dataInfo[0];
            if (item != undefined) {
                let birth = '';
                let _age = Distance_Year_2Date(new Date(item.Birthday), new Date());
                let groupname = (item.GroupName != '') ? item.GroupName : 'no group';
                if (_age > 0 && _age < 100) {
                    birth = ' [ ' + _age + ' @Local["Tuổi"] ] ';
                    $('#actionticket_birthday').html(birth);
                }
                $('#cc_custgender').html(item.GenderName + (birth != '' ? birth : ''));

                $('#cc_custphone').attr('data-info', (item.Phone.length > 0 ? encrypt_phone(item.Phone.replace(" ", "")) : ""));
                $('#cc_custphone').html('<span class="_tab_control_ cursor-pointer" data-tab="phone_customer" > ' + item.Phone + '</span>');

                $('#cc_custname').html(item.Name);
                $('#cc_custcode').html(item.CustomerCode + ((item.DocCode != '') ? (' [ ' + item.DocCode + ' ] ') : '') + ((item.Cust_Code_Old != '') ? (' [' + item.Cust_Code_Old + ']') : ''));
                $('#cc_custcode').attr('href', '/Customer/MainCustomer?CustomerID=' + item.CustomerID);

                $('#cc_groupimg').attr('src', ((item.ImageGroup != '') ? item.ImageGroup : Master_Default_Pic));
                $('#cc_groupname').prop("title", groupname)
                $('#cc_groupname').attr('data-bs-original-title', groupname);
            }
            Checking_TabControl_Permission();
            resolve();
        });
    }
    async function CustCare_RenderDetail(data, id) {
        new Promise((resolve, reject) => {
            setTimeout(() => {
                var myNode = document.getElementById(id);
                if (myNode != null) {
                    if (data && data.length > 0) {
                        for (var i = 0; i < data.length; i++) {
                            let item = data[i];
                            let classname = '';
                            let classchilname = '';
                            let creator = '';
                            let servicename = '';
                            let timeCallRepeat = !item.time_repeat_call.includes("1900") ? GetDateTime_String_DMY(item.time_repeat_call) : '';
                            if (item.ServiceID == 0) {
                                classname = 'justify-content-end text-right';
                                creator = `<div class="align-items-center text-sm">
                                                    <div><span class="mt-1 text-sm">@Local["Xử lý"]:</span><span class="text-dark ms-1">${item.CreatedName} ${GetDateTime_String_DMY(item.Created)}</span></div>
                                                    ${(timeCallRepeat != '') ? `<div><span class="mt-1 text-sm">@Local["Gọi lại"]:</span><span class="text-dark ms-1">${timeCallRepeat}</span></div>` : ""}
                                                </div>`;
                                classchilname = 'card shadow-none bg-gray-100';
                            }
                            else {
                                servicename = `<span class="text-dark fw-bold me-2">${item.ServiceName}</span>`;
                                classname = 'justify-content-start';
                                classname = 'justify-content-start';
                                creator = `<div class="align-items-center text-sm">
                                                ${item.DocName != '' ? `<div><span class="mt-1 text-sm">BS:</span><span class="text-dark ms-1">${item.DocName}</span></div>` : ''}
                                                ${item.AssName != '' ? `<div><span class="mt-1 text-sm">PT:</span><span class="text-dark ms-1">${item.AssName}</span></div>` : ''}
                                                <div><span class="text-dark">${GetDateTime_String_DMY(item.Created)}</span></div>
                                            </div>`;
                                classchilname = 'rounded-3 bg-gray-200';
                            }
                            let tr = `
                                    <div class="row ${classname} mb-4">
                                        <div class="col-auto">
                                            <div class="${classchilname}">
                                                <div class="card-body py-2 px-3">
                                                    <p class="text-dark mb-0">
                                                        ${servicename}
                                                        ${item.Content}
                                                    </p>
                                                    ${creator}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `
                            myNode.insertAdjacentHTML("beforeend", tr);
                        }
                    }
                }
                resolve();
            }, 10)
        });
    }
    //#endregion

    //#region // Event
    function CustCare_Filter () {
        let IdStatus = Number($("input[name=inlineRadioOptions]:checked").val());
        let y = document.getElementsByClassName("CustCareRow");

        for (let i = 0; i < y.length; i++) {
            $(y[i]).show();
            let className = $(y[i]).attr('class');
            if (IdStatus == 2 && className.includes("checknone")) {
                $(y[i]).hide();
            } else if (IdStatus == 1 && className.includes("CheckHas")) {
                $(y[i]).hide();
            }
        }
        if (IdStatus == 1){
            CustCareExport = DtCustCare.filter((item) => {return item["IsTakeCare"] == 0});
        } else if (IdStatus == 2){
            CustCareExport = DtCustCare.filter((item) => {return item["IsTakeCare"] == 1});
        } else {
            CustCareExport = DtCustCare;
        }
        $("#lbTotalCustCare").html(formatNumber($(".CustCareRow:visible").length))
    }


    function CustCare_EventHandle() {
        $('#dtContentCustCareBody').on('click', '.CustCareRow', function () {
            let numcreated = $(this).attr("data-date");
            let cus = $(this).attr("data-custid");
            let treat = $(this).attr("data-treatid");
            //let IDAfterTreat = Number($(this).attr("data-index"));
            $('#CustomerCare_Area').removeClass('d-none');
            $('#CustomerCare_Empty').addClass('d-none');
            $('.CustCareRow').removeClass('active');
            $(this).addClass('active');
            CustCareCustid = cus;
            CustCareTreatid = treat;
            CustCareDate = numcreated;
            //CustCareAfterTreatid = IDAfterTreat;
            CustCare_LoadDetail(cus, numcreated);
        });

        $(".custcare_defaultyesterday").unbind("click").on("click", function () {
            let days = 0;
            $(".custcare_defaultyesterday").removeClass("CustCare_Active");
            let datadays = Number($(this).attr('data-value'));
            if (!isNaN(datadays)) {
                days=datadays;
                let dateNow = new Date();
                dateNow.setDate(dateNow.getDate() - days);
                $("#CustCareDate").val(formatDateClient(dateNow) + ' to ' + formatDateClient(dateNow));
            }
            localstorage_set('CustCare_DefaultYesterday', days);
            $(this).addClass("CustCare_Active");
        })
    }
    function CCAction_New () {
        $("#DetailModal_Content").html('');
        $("#DetailModal_Content").load("/Marketing/CallDetailInput?MasterID=" + 0
            + "&CustomerID=" + CustCareCustid
            + "&Type=" + 5
            + "&AppID=" + 0
            + "&TreatID=" + CustCareTreatid
            + "&TreatmentDate=" + CustCareDate
            //+ "&IDAfterTreat=" + CustCareAfterTreatid
            + "&ver=" + versionofWebApplication);
        $('#DetailModal').modal('show');
        return false;
    }

    function CCAction_SendSMS() {
        $("#DetailModal_Content").html('');
        $("#DetailModal_Content").load("/SMS/SmsDetail?CustomerID=" + CustCareCustid + "&TicketID=" + 0 + "&Type=" + 'SMSContentGeneral' + "&TypeCare=" + 5 + "&AppID=" + 0 + "&TreatID=" + CustCareTreatid + "&ver=" + versionofWebApplication);
        $('#DetailModal').modal('show');
        return false;
    }
    function CCAction_Call(e) {
        if (typeof CCF_OutcomCall !== 'undefined' && $.isFunction(CCF_OutcomCall)) {
            let phone = $(e).attr("data-info");
            CCF_OutcomCall(phone, CustCareCustid, 0, 0);
        }

    }
    function CustCare_CloseCollap () {
        $('#CustCareColLists').collapse('hide');
    }
        //#endregion
    function CustCare_Export () {
        try {
            if (CustCareExport && CustCareExport.length != 0) {
                var dataHeader = {
                    "#": ["@Local["#"]", (value, { }, index) => {return index + 1;}]
                    , "CustName": "@Local["Tên"]"
                    , "DocCode": "@Local["Mã hồ sơ"]"
                    , "BranchName": "@Local["Chi nhánh"]"
                    , "Phone": {
                        dataNamePer: 'phone',
                        data: ["@Local["Số điện thoại"]"]
                    }
                    , "IsTakeCare": ["@Local["Tình trạng"]", (v) => {return v == 1 ? decodeHtml("@Local["Đã chăm sóc"]") : decodeHtml("@Local["Chưa chăm sóc"]")}]
                    , "CallBackTime": ["@Local["Ngày gọi lại"]", (v) => {return !GetDateTime_String_DMY(v).includes("1900") ? GetDateTime_String_DMY(v) : ""}]
                    , "Content": "@Local["Nội dung gần nhất"]"
                    , "EmpCare": ["@Local["Nhân viên chăm sóc"]", (v) => {return Fun_GetObject_ByID(AfterTreatDataEmployee, v).Name != "unknown" ? Fun_GetObject_ByID(AfterTreatDataEmployee, v).Name : ""}]
                    , "statusID": ["@Local["Trạng thái"]", (v) => {return Fun_GetName_ByID(CustCareTypeCare, v)}]
                    , "StatusCallID": ["@Local["Trạng thái chi tiết"]", (v) => {return Fun_GetName_ByID(CustCareTypeCare, v)}]
                }
                dataHeader = Checking_TabControl_System_RebuildHeader(dataHeader, tableBodyId = 'dtContentCustCareBody', PermissionTable_TabControl);
                exportJsonToExcel(Outlang["Sys_sau_dieu_tri"], CustCareExport, dataHeader);
            }
            else { notiWarning('@Local["Không xuất được file"]'); }
        }

        catch (ex) {
            notiWarning('@Local["Không xuất được file"]');
        }
    }
</script>
<style>
    .CustCare_Active {
        background-image: linear-gradient(310deg, rgb(var(--bs-primary-from)) 0%, rgb(var(--bs-primary-to)) 100%);
        color: white;
    }
</style>