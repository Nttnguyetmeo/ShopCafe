@page
@model MLunarCoffee.Pages.Discount.DiscountVoucherDetailModel
@{
    Layout = null;
}
<script>js_require('/js/main.js');</script>
<script>js_require('/js/comon/initialize_setting.js');</script>
<script>js_require('/js/customjs/custom-validation.js');</script>

<div class="container-fluid px-0">
    <div class="row">
        <div class="col-12">
            <!--Master-->
            <div class="card mb-2">
                <div class="card-header p-3 pb-0">
                    <!-- #region header -->
                    <h6 class="mb-0">@Local["Voucher"]</h6>
                    <p class="text-sm mb-0">@Local["Voucher được áp dụng khi lên dịch vụ cho khách hàng"]</p>
                    <!-- #endregion -->
                </div>

                <div class="card-body p-3 pt-2">
                    <!-- #region control execute-->
                    <div class="row px-2 form3" id="form3">
                        <div class="field col-12 col-md-3 p-1 flex-grow-1">
                            <label>@Local["Từ ngày"]</label>
                            <input id="dateFromdetail" class="flatpickr form-control" type="text" placeholder="@Local["Từ ngày"] .." />
                        </div>
                        <div class="field col-12 col-md-3 p-1 flex-grow-1">
                            <label>@Local["Đến ngày"]</label>
                            <input id="dateTodetail" class="flatpickr form-control" type="text" placeholder="@Local["Đến ngày"] .." />
                        </div>                        
                        <div class="col-12 col-md-6" id="VCD_Issuearea">
                            <div class="row">
                                <div class="field col-12 col-md-6 p-1">
                                    <div class="form-check text-lg d-inline-flex p-2 ps-0 py-0">
                                        <input type="checkbox" class="form-check-input m-0" id="IssueQtyCheck" onclick="ChooseIssueQty();">
                                        <label for="IssueQtyCheck" class="mt-1">@Local["Số lượng phát hành"]</label>
                                    </div>
                                    <input id="IssueQty" class="form-control Issue" disabled type="text">
                                </div>
                                <div class="field col-12 col-md-6 p-1">
                                    <label for="TimesUsedCheck" class="mt-1">@Local["Số lần sử dụng"] [1 - 20]</label>
                                    <input id="TimesUsed" class="form-control Issue" disabled type="text">
                                </div>
                            </div>
                        </div>
                        <div class="row m-0 px-0">
                            <div class="field col-12 col-md-6 p-1">
                                <label>@Local["Tên chương trình"]</label>
                                <input id="txtNameVoucherDetail" class="form-control" name="name" type="text">
                            </div>
                            <div class="field col-12 col-md-6 p-1">
                                <label>@Local["Mã chương trình"]</label>
                                <input id="txtCodeVoucherDetail" class="form-control" type="text">
                            </div>
                            <div class="field col-12 p-1">
                                <div class="form-check text-lg d-inline-flex p-2 ps-0 py-0">
                                    <input type="checkbox" class="form-check-input m-0" id="choose-all-branch" onclick="CheckAllBranch();">
                                    <label for="choose-all-branch" class="mt-1">@Local["Áp dụng tất cả chi nhánh"]</label>
                                </div>
                                <div class="ui fluid search multiple selection dropdown form-control" id="tokenBranch">
                                    <input id="inputtokenBranch" type="hidden" />
                                    <input id="inputtokenBranch2" class="search" autocomplete="off" tabindex="0" />
                                    <div class="default text">eg. @Local["Chi nhánh"]</div>
                                    <div id="ccbVoucherBranch" class="menu" tabindex="-1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- #endregion -->
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header p-3 pb-0">
                    <div class="d-lg-flex">
                        <div class="w-50 col-auto my-auto">
                            <div class="h-100">
                                <!-- #region header -->
                                <h6 class="mb-0">@Local["Áp dụng voucher"]</h6>
                                <p class="text-sm mb-0">@Local["Tùy chọn áp dụng: Cho tất cả dịch vụ - Theo nhóm dịch vụ - Theo dịch vụ"]</p>
                                <!-- #endregion -->
                            </div>
                        </div>
                        <div class="ms-auto my-auto mt-1">
                            <!-- #region navigation -->
                            <ul class="nav nav-pills nav-fill p-1 bg-transparent detaildiscount" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link cursor-pointer" data-bs-toggle="pill" data-bs-target="#discount_all" role="tab">@Local["Tất cả"]</a>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link cursor-pointer" data-bs-toggle="pill" data-bs-target="#discount_service_type" role="tab">@Local["Nhóm dịch vụ/sản phẩm"]</a>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link cursor-pointer" data-bs-toggle="pill" data-bs-target="#discount_service" role="tab">@Local["Dịch vụ/sản phẩm"]</a>
                                </li>
                            </ul>
                            <!-- #endregion -->
                        </div>
                    </div>
                </div>
                <div class="card-body p-3 pt-2">
                    <div class="nav-wrapper position-relative end-0">
                        <div class="tab-content">
                            <div class="tab-pane fade" id="discount_all" role="tabpanel">
                                <div class="row px-2">
                                    <div class="col-12 p-1" style="height: 500px;">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="ckb_choose_all" onchange="changeEventChooseTypeDiscount(0)">
                                            <label class="form-check-label" for="ckb_choose_all">@Local["Áp dụng tất cả"] @Local["Dịch vụ/sản phẩm"]</label>
                                        </div>

                                        <div class="position-relative">
                                            <input id="txtDiscount_All" class="border-right-0 form-control money" type="text" placeholder="eg .@Local["Khuyến mãi"]">
                                            <div class="ui fluid search selection dropdown form-control position-absolute end-0 top-0 w-auto ps-2 pe-5" id="DiscountAmountPer_All">
                                                <i class="dropdown icon"></i>
                                                <input type="hidden" name="name" />
                                                <div class="default text"></div>
                                                <div id="cbbPerformanceDiscounted" class="menu transition hidden" tabindex="-1">
                                                    <div class="item" data-value="1">%</div>
                                                    <div class="item" data-value="2">VND</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="discount_service_type" role="tabpanel" style="min-height: 600px;">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="ckb_choose_service_type" onchange="changeEventChooseTypeDiscount(2)">
                                    <label class="form-check-label" for="ckb_choose_service_type">@Local["Áp dụng theo nhóm dịch vụ/sản phẩm"]</label>
                                </div>
                                <div id="list_service_type_discount" style="display: none;">
                                    <div class="input-group" id="SearchService">
                                        <div class="input-group-text"><span class="fa fa-search form-control-feedback" aria-hidden="true"></span></div>
                                        <input id="filterSetting_ServiceType" type="text" class="form-control" placeholder="@Local["Tìm kiếm"]...">
                                    </div>
                                    <div class="row px-2">
                                        <div class="col-12 col-sm-5 p-1">
                                            <!-- #region table-->
                                            <div class="m-0 my-3 table-responsive" style="height: 500px;">
                                                <table class="table vt-table mb-0" id="dtServiceType_ListLeft">
                                                    <thead>
                                                        <tr>
                                                            <th class="d-none">ID</th>
                                                            <th>@Local["Nhóm dịch vụ/sản phẩm"]</th>
                                                            <th></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="dtServiceType_ListLeftBody">
                                                    </tbody>
                                                </table>
                                            </div>
                                            <!-- #endregion -->
                                        </div>
                                        <div class="col-12 col-sm-7 p-1">
                                            <!-- #region table-->
                                            <div class="m-0 my-3 table-responsive" style="height: 500px;">
                                                <table class="table vt-table mb-0" id="dtServiceType_ListRight">
                                                    <thead>
                                                        <tr>
                                                            <th>@Local["Nhóm dịch vụ/sản phẩm"]</th>
                                                            <th>@Local["Chiết khấu"]</th>
                                                            <th></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="dtServiceType_ListRightBody">
                                                    </tbody>
                                                </table>
                                            </div>
                                            <!-- #endregion -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="discount_service" role="tabpanel" style="min-height: 600px;">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="ckb_choose_service" onchange="changeEventChooseTypeDiscount(1)">
                                    <label class="form-check-label" for="ckb_choose_service">@Local["Áp dụng theo dịch vụ/sản phẩm"]</label>
                                </div>
                                <div id="list_service_discount" style="display: none;">
                                    <div class="input-group">
                                        <div class="input-group-text"><span class="fa fa-search form-control-feedback" aria-hidden="true"></span></div>
                                        <input id="filterSetting_Service" type="text" class="form-control" placeholder="@Local["Tìm kiếm"]...">
                                    </div>
                                    <div class="row px-2">
                                        <div class="col-12 col-sm-5 p-1">
                                            <!-- #region table-->
                                            <div class="m-0 my-3 table-responsive" style="height: 500px;">
                                                <table class="table vt-table mb-0" id="dtService_ListLeft">
                                                    <thead>
                                                        <tr>
                                                            <th class="d-none">ID</th>
                                                            <th>@Local["Dịch vụ/sản phẩm"]</th>
                                                            <th></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="dtService_ListLeftBody">
                                                    </tbody>
                                                </table>
                                            </div>
                                            <!-- #endregion -->
                                        </div>
                                        <div class="col-12 col-sm-7 p-1">
                                            <!-- #region table-->
                                            <div class="m-0 my-3 table-responsive" style="height: 500px;">
                                                <table class="table vt-table mb-0" id="dtService_ListRight">
                                                    <thead>
                                                        <tr>
                                                            <th>@Local["Dịch vụ/sản phẩm"]</th>
                                                            <th>@Local["Chiết khấu"]</th>
                                                            <th></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="dtService_ListRightBody">
                                                    </tbody>
                                                </table>
                                            </div>
                                            <!-- #endregion -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- #region button save and text show message-->
            <div class="fixed-botombutton">
                <div class="action_Save">
                    <div class="text-danger text-gradient text-sm font-weight-bold" id="textShowMessage"></div>
                    <div class="action_Save-Content">
                        <button class="btn btn-secondary" form="form3" onclick="event.preventDefault();CloseVoucherDetail()">@Local["Đóng"]</button>
                        <button id="VoucherDetail_btnSave" form="form3" type="button" class="btn bg-gradient-primary mt-2 me-2" onclick="event.preventDefault();return ExcuteData()">@Local["Lưu"]</button>
                    </div>
                </div>
            </div>
            <!-- #endregion -->
        </div>
    </div>
</div>

<script type="text/javascript">
    var ser_CurrentVoucherID = ("@Model._DataDetailID");
    var dataAllServiceType = {};
    var dataAllService = {};
    var dataRuleDiscount = [];
    var changingFlag = 1;

    $(document).ready(function () {
        // time from
        $("#dateFromdetail").flatpickr({
            dateFormat: 'd-m-Y',
            enableTime: false,
            defaultDate: new Date(),
            onChange: function (selectedDates, dateStr, instance) {
                let timeto = $("#dateTodetail").val();
                let arrtimeto = timeto.split("-");
                let timetonum = Number(arrtimeto[2] + arrtimeto[1] + arrtimeto[0]);
                let timefrom = dateStr;
                let arrtimefrom = timefrom.split("-");
                let timefromnum = Number(arrtimefrom[2] + arrtimefrom[1] + arrtimefrom[0]);

                if (timetonum < timefromnum) {
                    instance.setDate(timeto, true);
                };
            }
        });

        // time to
        $("#dateTodetail").flatpickr({
            dateFormat: 'd-m-Y',
            enableTime: false,
            defaultDate: new Date(),
            onChange: function (selectedDates, dateStr, instance) {

                let timeto = dateStr;
                let arrtimeto = timeto.split("-");
                let timetonum = Number(arrtimeto[2] + arrtimeto[1] + arrtimeto[0]);

                let timefrom = $("#dateFromdetail").val();
                let arrtimefrom = timefrom.split("-");
                let timefromnum = Number(arrtimefrom[2] + arrtimefrom[1] + arrtimefrom[0]);

                if (timetonum < timefromnum) {
                    instance.setDate(timefrom, true);
                };
            }
        });
        if(Ser_IsRelease == 0) $('#VCD_Issuearea').addClass('d-none');        
        else $('#VCD_Issuearea').removeClass('d-none');                    

        // khoi tao rule discount
        dataRuleDiscount = [{ "type": "all", "active": 0, "percent": 0, "amount": 0, "value": [] }, { "type": "servicetype", "active": 0, "percent": 0, "amount": 0, "value": [] }, { "type": "service", "active": 0, "percent": 0, "amount": 0, "value": [] }]

        $('.detaildiscount a:first').tab('show');

        $('#txtDiscount_All').attr('disabled', true);

        $('#txtDiscount_All').divide();

        $("#DiscountAmountPer_ServiceType").dropdown("set selected", 1);
        $("#DiscountAmountPer_Service").dropdown("set selected", 1);
        $("#DiscountAmountPer_All").dropdown("set selected", 1);
        
        filterServiceTypeDiscount();
        filterServiceDiscount();
        eventRowDiscount_Service_ServiceType();
        $("#IssueQty").divide();
        $("#TimesUsed").divide();
        Load_Initiliaze_VoucherDetail();
        CheckPermissionControlInPage(sys_PerControl, '@Model._dtPermissionCurrentPage');
        CheckPermissionControlInPage(sys_PerControlMH, '@Model._dtPermissionCurrentPage');        
        
    });   

    function Load_Initiliaze_VoucherDetail() {
        AjaxLoad(url = "/Discount/DiscountVoucherDetail/?handler=LoadInitialize"
            , data = {
                CurrentID: ser_CurrentVoucherID
            }, async = true, error = null
            , success = function (result) {
                if (result != "0") {
                    let data = JSON.parse(result);
                    Load_Combo(data.cbbBranch, "ccbVoucherBranch", true);
                    ParseKeyValue(data.ServiceType, dataAllServiceType);
                    ParseKeyValue(data.Service, dataAllService);
                    if(ser_CurrentVoucherID != "0") LoadDataUpdateVoucher(data.dataDetail);
                } else {
                    notiError_SW();
                }
            });
    }

    //#region //Render and Fill Data
    function RenderLeftData(data, id, type) {
        var myNode = document.getElementById(id);
        if (myNode != null) {
            myNode.innerHTML = '';
            let stringContent = '';
            for ([key, value] of Object.entries(data)) {
                if (value.Choose == "0") {
                    let tr =
                        '<td style="display:none">' + key + '</td>'
                        + '<td class="list_service_discount">' + value.Name + '</td>'
                        + '<td style="width: 40px"><button class="' + ((type == 1) ? 'btnChooseService' : 'btnChooseServiceType') + ' buttonGrid"><i class="imgGrid vtt-icon vttech-icon-add"></i></button></td>'
                    stringContent = stringContent + '<tr role="row">' + tr + '</tr>';
                }
            }
            document.getElementById(id).innerHTML = stringContent;
        }
    }
    function RenderRightData(data, id, type) {
        var myNode = document.getElementById(id);
        if (myNode != null) {
            myNode.innerHTML = '';
            let stringContent = '';
            for ([key, value] of Object.entries(data)) {
                if (value.Choose == "1") {
                    let tr = "";
                    if (type == 1) {
                        tr = ' <td class="d-none">' + key + '</td>'
                            + ' <td style="min-width: 150px;">' + value.Name + '</td>'
                            //----------------------------------------
                            + ' <td style="max-width:300px;min-width:200px;">'

                            + '<div class="position-relative">'
                            + ' <input id="Discount_Service_Detail_' + key + '" type="number" class="border-right-0 form-control money" placeholder="@Local["Giảm giá"]" onchange="event.preventDefault();OnchangeDiscountItem(' + key + ',1);">'
                            + ' <div class="ui fluid search selection dropdown form-control position-absolute end-0 top-0 w-auto ps-2 pe-5" id="DiscountAmountPer_Service_' + key + '" onchange="event.preventDefault();return OnchangeDiscountItem(' + key + ',1);">'
                            + ' <i class="dropdown icon"></i>'
                            + ' <input type="hidden" name="name" />'
                            + ' <div class="default text"></div>'
                            + ' <div id="cbbPerformanceDiscounted" class="menu transition hidden" tabindex="-1">'
                            + '    <div class="item" data-value="1">%</div>'
                            + '    <div class="item" data-value="2">VND</div>'
                            + ' </div>'
                            + ' </div>'
                            + ' </div></td>'
                            //-----------------------------------------
                            + ' <td style="width: 40px"><div class="btnRemoveService"><i class="imgGrid vtt-icon vttech-icon-delete"></i></div></td>'
                    }
                    if (type == 2) {
                        tr = ' <td class="d-none">' + key + '</td>'
                            + ' <td style="min-width: 150px;">' + value.Name + '</td>'
                            //----------------------------------------
                            + ' <td style="max-width:300px;min-width:200px;">'
                            + '<div class="position-relative">'
                            + ' <input id="Discount_ServiceType_Detail' + key + '" type="number"  class="border-right-0 form-control money" placeholder="@Local["Giảm giá"]" onchange="event.preventDefault();OnchangeDiscountItem(' + key + ',2);">'
                            + ' <div class="ui fluid search selection dropdown form-control position-absolute end-0 top-0 w-auto ps-2 pe-5" id="DiscountAmountPer_ServiceType_' + key + '" onchange="event.preventDefault();return OnchangeDiscountItem(' + key + ',2);">'
                            + ' <i class="dropdown icon"></i>'
                            + ' <input type="hidden" name="name" />'
                            + ' <div class="default text"></div>'
                            + ' <div id="cbbPerformanceDiscounted" class="menu transition hidden" tabindex="-1">'
                            + '    <div class="item" data-value="1">%</div>'
                            + '    <div class="item" data-value="2">VND</div>'
                            + ' </div>'
                            + ' </div>'
                            + ' </div></td>'
                            //-----------------------------------------
                            + ' <td style="width: 40px"><div class="btnRemoveServiceType" style="line-height: 1;"> <i class="imgGrid vtt-icon vttech-icon-delete"></i></div></td>'
                    }
                    stringContent = stringContent + '<tr role="row">' + tr + '</tr>';
                }
            }

            document.getElementById(id).innerHTML = stringContent;
            $(".ui.dropdown").dropdown();
            Event_Fill_Data(data, type);
        }
    }
    function Event_Fill_Data(data, type) {
        let dataArray = Object.entries(data).filter(([key, value]) => value.Choose == "1");
        if (dataArray.length > 0) {
            data = ParseArrayToKeyValue(dataArray);
            if (type === 1) {
                for ([key, value] of Object.entries(data)) {
                    let discount_Percent = Number(value.Percent);
                    let discount_Amount = Number(value.Amount);
                    if (discount_Percent > discount_Amount) {
                        $("#Discount_Service_Detail_" + key).val(discount_Percent);
                        $("#DiscountAmountPer_Service_" + key).dropdown("set selected", 1);
                    }
                    else {
                        $("#Discount_Service_Detail_" + key).val(discount_Amount);
                        $("#DiscountAmountPer_Service_" + key).dropdown("set selected", 2);
                    }
                }
            }
            else {
                for ([key, value] of Object.entries(data)) {
                    let discount_Percent = Number(value.Percent);
                    let discount_Amount = Number(value.Amount);
                    if (discount_Percent > discount_Amount) {
                        $("#Discount_ServiceType_Detail" + key).val(discount_Percent);
                        $("#DiscountAmountPer_ServiceType_" + key).dropdown("set selected", 1);
                    }
                    else {
                        $("#Discount_ServiceType_Detail" + key).val(discount_Amount);
                        $("#DiscountAmountPer_ServiceType_" + key).dropdown("set selected", 2);
                    }
                }
            }
        }

    }
    //#endregion

    //#region //Event Change (add, remove,value ,Choose Type Discount)
    function eventRowDiscount_Service_ServiceType() {
        $('#dtServiceType_ListLeft tbody').on('click', '.btnChooseServiceType', function () {
            event.preventDefault();
            let ID = Number($(this).closest('tr')[0].childNodes[0].innerHTML);
            if (ID != undefined && ID != 0) AddItem(ID, 2);
        });
        $('#dtServiceType_ListRight tbody').on('click', '.btnRemoveServiceType', function () {
            event.preventDefault();
            let ID = Number($(this).closest('tr')[0].children[0].innerHTML);
            if (ID != undefined && ID != 0) RemoveItem(ID, 2);
        });

        $('#dtService_ListLeft tbody').on('click', '.btnChooseService', function () {
            event.preventDefault();
            let ID = Number($(this).closest('tr')[0].childNodes[0].innerHTML);
            if (ID != undefined && ID != 0) AddItem(ID, 1);
        });
        $('#dtService_ListRight tbody').on('click', '.btnRemoveService', function () {
            event.preventDefault();
            let ID = Number($(this).closest('tr')[0].children[0].innerHTML);
            if (ID != undefined && ID != 0) RemoveItem(ID, 1);
        });

        $("#txtDiscount_All").on("change", function () {
            ChangeEventDiscountPrice();
        })
        $("#DiscountAmountPer_All").on("change", function () {
            ChangeEventDiscountPrice();
        })
    }
    function AddItem(id, TypeDiscount) {
        if (TypeDiscount === 2) {
            dataAllServiceType[id].Choose = "1";
            RenderLeftData(dataAllServiceType, "dtServiceType_ListLeftBody", 2);
            RenderRightData(dataAllServiceType, "dtServiceType_ListRightBody", 2);
        }
        if (TypeDiscount === 1) {
            dataAllService[id].Choose = "1";
            RenderLeftData(dataAllService, "dtService_ListLeftBody", 1);
            RenderRightData(dataAllService, "dtService_ListRightBody", 1);
        }
    }
    function RemoveItem(id, TypeDiscount) {
        if (TypeDiscount === 2) {
            dataAllServiceType[id].Choose = "0";
            RenderLeftData(dataAllServiceType, "dtServiceType_ListLeftBody", 2);
            RenderRightData(dataAllServiceType, "dtServiceType_ListRightBody", 2);
        }
        if (TypeDiscount === 1) {
            dataAllService[id].Choose = "0";
            RenderLeftData(dataAllService, "dtService_ListLeftBody", 1);
            RenderRightData(dataAllService, "dtService_ListRightBody", 1);
        }
    }
    function OnchangeDiscountItem(id, TypeDiscount) {
        if (TypeDiscount === 2) {
            if ($('#ckb_choose_service_type').is(':checked')) {
                let _type_discount = Number($("#DiscountAmountPer_ServiceType_" + id).dropdown("get value")) ? Number($("#DiscountAmountPer_ServiceType_" + id).dropdown("get value")) : 0;
                let _value_discount = Number($("#Discount_ServiceType_Detail" + id).val()) ? Number($("#Discount_ServiceType_Detail" + id).val()) : 0;
                if (_type_discount == 1) {
                    if (_value_discount < 0 || _value_discount > 100) {
                        $("#Discount_ServiceType_Detail" + id).css("background-color", "rgb(255 216 216)")
                    }
                    else {
                        $("#Discount_ServiceType_Detail" + id).css("background-color", "white")
                    }
                } else {
                    if (_value_discount < 0) {
                        $("#Discount_ServiceType_Detail" + id).css("background-color", "rgb(255 216 216)")
                    }
                    else {
                        $("#Discount_ServiceType_Detail" + id).css("background-color", "white");
                    }
                }
                if (_type_discount == 1) {
                    dataAllServiceType[id].Percent = _value_discount
                    dataAllServiceType[id].Amount = 0;
                }
                else {
                    dataAllServiceType[id].Percent = 0
                    dataAllServiceType[id].Amount = _value_discount;
                }
            }
        }
        if (TypeDiscount === 1) {
            if ($('#ckb_choose_service').is(':checked')) {
                let _type_discount = Number($("#DiscountAmountPer_Service_" + id).dropdown("get value")) ? Number($("#DiscountAmountPer_Service_" + id).dropdown("get value")) : 0;
                let _value_discount = Number($("#Discount_Service_Detail_" + id).val()) ? Number($("#Discount_Service_Detail_" + id).val()) : 0;
                if (_type_discount == 1) {
                    if (_value_discount < 0 || _value_discount > 100) {
                        $("#Discount_Service_Detail_" + id).css("background-color", "rgb(255 216 216)")
                    }
                    else {
                        $("#Discount_Service_Detail_" + id).css("background-color", "white")
                    }
                }
                else {
                    if (_value_discount < 0) {
                        $("#Discount_Service_Detail_" + id).css("background-color", "rgb(255 216 216)")
                    }
                    else {
                        $("#Discount_Service_Detail_" + id).css("background-color", "white");
                    }
                }
                if (_type_discount == 1) {
                    dataAllService[id].Percent = _value_discount
                    dataAllService[id].Amount = 0;
                }
                else {
                    dataAllService[id].Percent = 0
                    dataAllService[id].Amount = _value_discount;
                }
            }
        }
    }
    function changeEventChooseTypeDiscount(type) {
        // giam theo nhom dich vu
        if (type == 2) {
            if ($('#ckb_choose_service_type').is(':checked')) {
                $('#list_service_type_discount').show();
                LoadInitializeByServiceType();
            }
            else {
                $('#list_service_type_discount').hide();
            }
        }

        // giam theo dich vu
        if (type == 1) {
            if ($('#ckb_choose_service').is(':checked')) {
                $('#list_service_discount').show();
                LoadInitializeByService();
            }
            else {
                $('#list_service_discount').hide();
            }

        }

        // ap dung cho tat ca sp, dv
        if (type == 0) {
            if ($('#ckb_choose_all').is(':checked')) {
                $('#txtDiscount_All').attr('disabled', false);
            }
            else {
                $('#txtDiscount_All').attr('disabled', true);
                $('#txtDiscount_All').val(0);
            }
        }

    }
    //#endregion

    //#region //Parse Key Value
    function ParseKeyValue(data, dataResult) {
        for (let i = 0; i < data.length; i++) {
            let element = {};
            element.ID = data[i].ID;
            element.Name = data[i].Name;
            element.Choose = data[i].Choose;
            element.Percent = data[i].Percent;
            element.Amount = data[i].Amount;
            dataResult[data[i].ID] = element;
        }
    }
    function ParseArrayToKeyValue(data) {
        let dataResult = {};
        for (let i = 0; i < data.length; i++) {
            let items = data[i];
            let item = items[1];
            let element = {};
            element.ID = item.ID;
            element.Name = item.Name;
            element.Choose = item.Choose;
            element.Percent = item.Percent;
            element.Amount = item.Amount;
            dataResult[item.ID] = element;
        }
        return dataResult;
    }
    //#endregion

    //#region //Filter Service and Service Type
    function filterServiceTypeDiscount() {
        if (document.getElementById("filterSetting_ServiceType")) {
            let datafilter = {};
            var filter = document.getElementById("filterSetting_ServiceType");
            filter.addEventListener("keyup", function (event) {
                let textsearch = $('#filterSetting_ServiceType').val().trim();
                event.preventDefault();
                let search = xoa_dau(textsearch.toLowerCase());
                if (search == "") {
                    datafilter = dataAllServiceType;
                }
                else {
                    let dataArray = Object.entries(dataAllServiceType).filter(([key, value]) => xoa_dau(value.Name).toLowerCase().includes(search));
                    if (dataArray.length > 0) {
                        datafilter = ParseArrayToKeyValue(dataArray);
                    }
                }
                RenderLeftData(datafilter, "dtServiceType_ListLeftBody", 2);
                ColorSearchFilterText(search, "list_service_discount");
            });
        }
    }
    function filterServiceDiscount() {
        if (document.getElementById("filterSetting_Service")) {
            let data = {};
            var filter = document.getElementById("filterSetting_Service");
            filter.addEventListener("keyup", function (event) {
                let textsearch = $('#filterSetting_Service').val().trim();
                event.preventDefault();
                let search = xoa_dau(textsearch.toLowerCase());
                if (search == "") {
                    data = dataAllService;
                }
                else {
                    let dataArray = Object.entries(dataAllService).filter(([key, value]) => xoa_dau(value.Name).toLowerCase().includes(search));
                    if (dataArray.length > 0) {
                        data = ParseArrayToKeyValue(dataArray);
                    }
                }
                RenderLeftData(data, "dtService_ListLeftBody", 1);
                ColorSearchFilterText(search, "list_service_discount");
            });
        }
    }
    //#endregion

    function ExcuteData() {
        document.getElementById("textShowMessage").innerHTML = "";
        if (document.getElementById('ckb_choose_all')) {
            ChangeEventDiscountPrice();
        }
        if ($("#choose-all-branch").is(":checked") == false && $('#tokenBranch').dropdown('get value') == "") {
            $('#textShowMessage').html('@Local["Chưa chọn chi nhánh"]');
        }
        if ($("#IssueQtyCheck").is(":checked")) {
            let valueUsed = (!isNaN($('#TimesUsed').val().replaceAll(',',''))) ? ($('#TimesUsed').val() != '' ? $('#TimesUsed').val() : 0 ): 0;
            let valueIssue = (!isNaN($('#IssueQty').val().replaceAll(',', ''))) ? ($('#IssueQty').val() != '' ? $('#IssueQty').val() : 0) : 0;
            if((valueUsed < 1 || valueUsed >20) || (valueIssue <= 0) ){
                $('#textShowMessage').html('@Local["Kiểm tra dữ liệu"]');
                $(".Issue").parent().addClass('error');
            }else {
                $(".Issue").parent().removeClass('error');
            }
            ;
        }
        if (document.getElementById("textShowMessage").innerHTML == "") {
            let ruleService = [];
            let ruleServiceType = [];
            // danh sach nhom dich vu va dich vu co giam gia
            if (dataAllServiceType != undefined && dataAllServiceType != "") {
                let data = Object.entries(dataAllServiceType).filter(([key, value]) => value.Choose == "1");
                for (let i = 0; i < data.length; i++) {
                    let items = data[i];
                    let item = items[1];
                    let servicetype = {};
                    servicetype.id = item.ID;
                    servicetype.percent = item.Percent;
                    servicetype.amount = item.Amount;
                    ruleServiceType.push(servicetype);
                }
            }
            if (dataAllService != undefined && dataAllService != "") {
                let data = Object.entries(dataAllService).filter(([key, value]) => value.Choose == "1");
                for (let i = 0; i < data.length; i++) {
                    let items = data[i];
                    let item = items[1];
                    let service = {};
                    service.id = item.ID;
                    service.percent = item.Percent;
                    service.amount = item.Amount;
                    ruleService.push(service);
                }
            }
            if (document.getElementById("ckb_choose_all")) {
                for (var i = 0; i < dataRuleDiscount.length; i++) {
                    if (dataRuleDiscount[i].type == 'service') {
                        if ($('#ckb_choose_service').is(':checked')) {
                            dataRuleDiscount[i].active = 1;
                            dataRuleDiscount[i].percent = 0;
                            dataRuleDiscount[i].amount = 0;
                            dataRuleDiscount[i].value = ruleService;
                        }
                        else {
                            dataRuleDiscount[i].active = 0;
                            dataRuleDiscount[i].percent = 0;
                            dataRuleDiscount[i].amount = 0;
                            dataRuleDiscount[i].value = [];
                        }

                    }
                    else if (dataRuleDiscount[i].type == 'servicetype') {
                        if ($('#ckb_choose_service_type').is(':checked')) {
                            dataRuleDiscount[i].active = 1;
                            dataRuleDiscount[i].percent = 0;
                            dataRuleDiscount[i].amount = 0;
                            dataRuleDiscount[i].value = ruleServiceType;
                        }
                        else {
                            dataRuleDiscount[i].active = 0;
                            dataRuleDiscount[i].percent = 0;
                            dataRuleDiscount[i].amount = 0;
                            dataRuleDiscount[i].value = [];
                        }

                    }
                    else if (dataRuleDiscount[i].type == 'all') {
                        if ($('#ckb_choose_all').is(':checked')) {
                            dataRuleDiscount[i].active = 1;
                            let PerTreat = Number($('#DiscountAmountPer_All').dropdown('get value')) ? Number($('#DiscountAmountPer_All').dropdown('get value')) : 0;
                            if (PerTreat == 1) {
                                dataRuleDiscount[i].percent = Number($('#txtDiscount_All').val() ? $('#txtDiscount_All').val() : 0);
                                dataRuleDiscount[i].amount = 0;
                            }
                            else {
                                dataRuleDiscount[i].amount = Number($('#txtDiscount_All').val() ? $('#txtDiscount_All').val() : 0);
                                dataRuleDiscount[i].percent = 0;
                            }
                            dataRuleDiscount[i].value = [];
                        }
                        else {
                            dataRuleDiscount[i].active = 0;
                            dataRuleDiscount[i].percent = 0;
                            dataRuleDiscount[i].amount = 0;
                            dataRuleDiscount[i].value = [];
                        }

                    }
                }
            }

            var data = new Object();
            data.TimesUsed = (!isNaN($('#TimesUsed').val().replaceAll(',',''))) ? ($('#TimesUsed').val() != '' ? $('#TimesUsed').val() : 0 ): 0;
            data.IssueQty = (!isNaN($('#IssueQty').val().replaceAll(',', ''))) ? ($('#IssueQty').val() != '' ? $('#IssueQty').val() : 0) : 0;
            data.Name = $('#txtNameVoucherDetail').val() ? $('#txtNameVoucherDetail').val().trim() : "";
            data.Code = $('#txtCodeVoucherDetail').val() ? $('#txtCodeVoucherDetail').val().trim() : "";
            data.Rule = JSON.stringify(dataRuleDiscount);
            data.DateFrom = $('#dateFromdetail').val() ? $('#dateFromdetail').val() : new Date();
            data.DateTo = $('#dateTodetail').val() ? $('#dateTodetail').val() : new Date();
            data.Percent = 0;
            data.Amount = 0;
            if($("#ckb_choose_all").prop("checked")){
                let typeDis = Number($('#DiscountAmountPer_All').dropdown('get value')) ? Number($('#DiscountAmountPer_All').dropdown('get value')) : 0;
                if(typeDis == 1)
                    data.Percent = $('#txtDiscount_All').val() ? $('#txtDiscount_All').val() : 0;
                else
                    data.Amount = $('#txtDiscount_All').val() ? $('#txtDiscount_All').val() : 0;
            }
            if ($("#choose-all-branch").is(":checked")) {
                data.IsAllBranch = 1;
                data.TokenBranch = "";
            }
            else {
                data.IsAllBranch = 0;
                data.TokenBranch = $('#tokenBranch').dropdown('get value') ? $('#tokenBranch').dropdown('get value') : "";
            }
            $('#form3').form('validate form');
            if ($('#form3').form('is valid')) {
                AjaxLoad(url = "/Discount/DiscountVoucherDetail/?handler=ExcuteDataVoucher"
                    , data = {
                        data: JSON.stringify(data),
                        CurrentID: ser_CurrentVoucherID
                    }, async = true, error = null
                    , success = function (result) {
                        if (result == "0") {
                            notiSuccess();
                            LoadDiscountVoucherAjax();
                            CloseVoucherDetail();
                        }
                        else {
                            if (result == "1") {
                                $('#textShowMessage').html('Voucher @Local["Đã sử dụng"]');
                            } else {
                                notiError();
                            }
                        }
                    });
            }
        }
        return false;
    }


    function LoadDataUpdateVoucher(dataDetail) {
        changingFlag = 0;
        if (dataDetail && dataDetail.length > 0) {
            if (dataDetail[0].IssueQty != 0) {
                $("#IssueQtyCheck").click();
                $('#IssueQty').val(dataDetail[0].IssueQty);
                $('#TimesUsed').val(dataDetail[0].TimesUsed);
            }
            $('#dateFromdetail').val(dataDetail[0].Date_From);
            $('#dateTodetail').val(dataDetail[0].Date_To);
            $('#txtNameVoucherDetail').val(dataDetail[0].Name);
            $('#txtCodeVoucherDetail').val(dataDetail[0].Code);
            if (dataDetail[0].IsAllBranch != 0) {
                $("#choose-all-branch").prop("checked", true);
                CheckAllBranch();
            }
            else {
                if (dataDetail[0].Branch_Token != undefined
                    && dataDetail[0].Branch_Token != null
                    && dataDetail[0].Branch_Token != "") {
                    let dataTokenBranch = (dataDetail[0].Branch_Token).split(",");
                    $('#tokenBranch').dropdown('refresh')
                    $('#tokenBranch').dropdown('set selected', dataTokenBranch)
                }
            }

            // update Rule discount
            let DataRule = JSON.parse(dataDetail[0].Rule);
            if (document.getElementById('ckb_choose_all') && DataRule && DataRule.length > 0) {
                dataRuleDiscount = DataRule;
                for (var i = 0; i < dataRuleDiscount.length; i++) {
                    var item = dataRuleDiscount[i];
                    if (item.type == "all" && item.active == 1) {
                        $('#ckb_choose_all')[0].checked = true;
                        changeEventChooseTypeDiscount(0);
                        if (item.percent != 0) {
                            $("#DiscountAmountPer_All").dropdown("set selected", 1);
                            $('#txtDiscount_All').val(item.percent);
                        }
                        else {
                            $("#DiscountAmountPer_All").dropdown("set selected", 2);
                            $('#txtDiscount_All').val(item.amount);
                        }
                    }
                    else if (item.type == "servicetype" && item.active == 1) {
                        $('#ckb_choose_service_type')[0].checked = true;
                        changeEventChooseTypeDiscount(2);
                        if (item.percent != 0) {
                            $("#DiscountAmountPer_ServiceType").dropdown("set selected", 1);
                            $('#txtDiscount_ServiceType').val(item.percent);
                        }
                        else {
                            $("#DiscountAmountPer_ServiceType").dropdown("set selected", 2);
                            $('#txtDiscount_ServiceType').val(item.amount);
                        }
                        let arrtype = item.value;
                        if (arrtype.length != 0) {
                            for (var a = 0; a < arrtype.length; a++) {
                                let id = arrtype[a].id;
                                let percent = arrtype[a].percent;
                                let amount = arrtype[a].amount;
                                if (id != "") {
                                    dataAllServiceType[id].Choose = "1";
                                    dataAllServiceType[id].Percent = percent;
                                    dataAllServiceType[id].Amount = amount;
                                }
                            }
                        }
                        LoadInitializeByServiceType();
                    }
                    else if (item.type == "service" && item.active == 1) {
                        $('#ckb_choose_service')[0].checked = true;
                        changeEventChooseTypeDiscount(1);
                        if (item.percent != 0) {
                            $("#DiscountAmountPer_Service").dropdown("set selected", 1);
                            $('#txtDiscount_Service').val(item.percent);
                        }
                        else {
                            $("#DiscountAmountPer_Service").dropdown("set selected", 2);
                            $('#txtDiscount_Service').val(item.amount);
                        }
                        let arrtype = item.value;
                        if (arrtype.length != 0) {
                            for (var t = 0; t < arrtype.length; t++) {
                                let id = arrtype[t].id;
                                let percent = arrtype[t].percent;
                                let amount = arrtype[t].amount;
                                if (id != "") {
                                    dataAllService[id].Choose = "1";
                                    dataAllService[id].Percent = percent;
                                    dataAllService[id].Amount = amount;
                                }
                            }
                        }
                        LoadInitializeByService();
                    }
                }
            }
        }
        changingFlag = 1;
    }

    function LoadInitializeByServiceType() {
        RenderLeftData(dataAllServiceType, "dtServiceType_ListLeftBody", 2);
        RenderRightData(dataAllServiceType, "dtServiceType_ListRightBody", 2);
    }
    function LoadInitializeByService() {
        RenderLeftData(dataAllService, "dtService_ListLeftBody", 1);
        RenderRightData(dataAllService, "dtService_ListRightBody", 1);
    }

    // EVENT CHANGE DISCOUNT
    function ChangeEventDiscountPrice() {
        if (changingFlag == 1) {
            changingFlag = 0;
            $('#textShowMessage').html('');

            // chiết khấu cho tất cả dịch vụ
            let typeDiscountPer_All = Number($('#DiscountAmountPer_All').dropdown('get value')) ? Number($('#DiscountAmountPer_All').dropdown('get value')) : 0;
            let ChooseAll = $("#ckb_choose_all").prop("checked") ? 1 : 0;
            let ChooseSer = $("#ckb_choose_service").prop("checked") ? 1 : 0;
            let ChooseSerType = $("#ckb_choose_service_type").prop("checked") ? 1 : 0;


            if (ChooseAll == 1) {
                if (!isNaN($('#txtDiscount_All').val()) || $('#txtDiscount_All').val() == '') {
                    let valueDiscountPer_All = Number($('#txtDiscount_All').val() ? $('#txtDiscount_All').val() : 0);

                    if (typeDiscountPer_All == 1 && valueDiscountPer_All <= 100 && valueDiscountPer_All > 0) {
                        $('#txtDiscount_All').css('background-color', 'white');
                    }
                    else if (typeDiscountPer_All == 2 && valueDiscountPer_All > 0) {
                        $('#txtDiscount_All').css('background-color', 'white');
                    }
                    else {
                        // sai dinh dang
                        $('#textShowMessage').html('@Local["Sai định dạng"]');
                        $('#txtDiscount_All').css('background-color', 'rgb(255 216 216)');
                    }
                }
                else {
                    //sai dinh dang
                    $('#textShowMessage').html('@Local["Sai định dạng"]');
                    $('#txtDiscount_All').css('background-color', 'rgb(255 216 216)');
                }
            }

            //Chiết Khấu cho từng dịch vụ và nhóm dịch vụ
            if (ChooseSer == 1) {
                ValidateDiscountedValue(dataAllService, 1);
            }
            if (ChooseSerType == 1) {
                ValidateDiscountedValue(dataAllServiceType, 2);
            }

            if (ChooseAll == 0 && ChooseSer == 0 && ChooseSerType == 0) {
                $('#textShowMessage').html("@Local["Kiểm tra dữ liệu"]");
            }
            changingFlag = 1;
        }
    }
    function ValidateDiscountedValue(data, type) {
        let dataArray = Object.entries(data).filter(([key, value]) => value.Choose == "1");
        let AttributeID = "";
        if (type == 1) AttributeID = "Discount_Service_Detail_"
        else AttributeID = "Discount_ServiceType_Detail";

        if (dataArray.length > 0) {
            data = ParseArrayToKeyValue(dataArray);
            for ([key, value] of Object.entries(data)) {
                let discount_Percent = Number(value.Percent);
                let discount_Amount = Number(value.Amount);
                if (discount_Percent < 0 || discount_Amount < 0 || discount_Percent > 100 || (discount_Percent == 0 && discount_Amount == 0)) {
                    $("#" + AttributeID + key).css('background-color', 'rgb(255 216 216)');
                    $('#textShowMessage').html('@Local["Sai định dạng"]');
                }
            }
        }
    }
    function CheckAllBranch() {
        if ($("#choose-all-branch").is(":checked")) {
            $("#tokenBranch").addClass("disabled")
        }
        else {
            $("#tokenBranch").removeClass("disabled");
        }
    }
    function ChooseIssueQty(){
        $("#txtCodeVoucherDetail").val('');
        if (!$("#IssueQtyCheck").is(":checked")) {
            $(".Issue").attr("disabled",true);
            $(".Issue").val('');
            $("#txtCodeVoucherDetail").attr("disabled", false);
        }
        else {
            $(".Issue").attr("disabled", false);
            $("#txtCodeVoucherDetail").attr("disabled", true);
        }
    }
</script>

