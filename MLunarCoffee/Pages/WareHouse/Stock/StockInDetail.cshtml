@page
@model MLunarCoffee.Pages.WareHouse.Stock.StockInDetailModel
@{
    Layout = null;
}

<script>js_require_notasync('/js/comon/initialize_setting.js', true);</script>

<div class="row">
    <div id="StockInMain" class="col-12 opacity-0">
        <div id="DetailImport" class="card mb-4" style="display:none;">
            <div class="card-header pb-0">
                <div class="d-lg-flex">
                    <div class="col-auto my-auto">
                        <div id="wa_header_import" class="h-100 ">
                            <h6 class="mb-0">@Local["Chi tiết phiếu nhập"]</h6>
                            <p class="text-sm mb-0">@Local["Ngày giờ nhập không được nhỏ hơn ngày giờ chốt kho gần nhất hoặc lớn hơn ngày giờ hiện tại"].</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body pt-2">
                <div class="row px-2 form-3">
                    <div class="col-12 col-xl-4 col-md-5 p-1 position-relative">
                        <div class="d-flex">
                            <div class="input-group flex-nowrap" id="wareSearch">
                                <div class="input-group-text input-group-text px-2">
                                    <i class="fas fa-search" aria-hidden="true" style="display: block;"></i>
                                    <div class="spinner-border spinner-border-sm" style="display: none;"></div>
                                </div>
                                <input id="searchingProduct" type="text" class="form-control" placeholder="eg .@Local["Lọc dữ liệu"]" autocomplete="off">
                            </div>
                            <div id="StockIn_AddNewProduct" class="icon shadow border-radius-md bg-dark text-center d-flex align-items-center justify-content-center text-white cursor-pointer ms-2" style="height: 40px;min-width: 40px;" data-bs-toggle="tooltip" onclick="return WareHouse_NewProduct();">
                                <i class="fa fa-plus" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div id="TableProduct" class="m-0 my-3 mobile-responsive" style="height:500px;overflow-x:auto;">
                            <div id="WaitingProduct" class="waitingdiv text-center position-absolute translate-middle-x start-50" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                            <table class="table vt-table mb-0" id="dtContentProduct">
                                <thead>
                                    <tr>
                                        <th class="d-none">ID</th>
                                        <th style="width:40px;">@Local["#"]</th>
                                        <th style="min-width:120px;">@Local["Sản phẩm"]</th>
                                    </tr>
                                </thead>
                                <tbody id="dtContentProductBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-12 col-xl-8 col-md-7 p-1">
                        <div id="ProductItem" class="card border-1 border-dashed shadow-none rounded-2">
                            <div class="card-body pt-2">
                                <div class="row">
                                    <div class="field col-12 col-md-12 col-sm-12 col-lg-6 px-1 mt-2">
                                        <label>@Local["Sản phẩm"]</label>
                                        <div class="ui fluid search selection dropdown form-control" id="productDetail" onchange="event.preventDefault();return ItemDetail_DetectUnit();">
                                            <input type="hidden" />
                                            <i class="dropdown icon"></i>
                                            <input id="searchproduct" class="search" autocomplete="off" tabindex="0" />
                                            <div class="default text">eg .@Local["Sản phẩm"]</div>
                                            <div id="cbbproductDetail" class="menu" tabindex="-1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field col-12 col-md-12 col-sm-12 col-lg-3 px-1 mt-2 ">
                                        <label>@Local["Số lô"]</label>
                                        <input id="PackageNumber" class="form-control" type="text" maxlength="100" autocomplete="off" placeholder="eg .@Local["Số lô"]" onchange="return WareHouse_OnchangePackage()"/>
                                    </div>
                                    <div class="field col-12 col-md-12 col-sm-12 col-lg-3 px-1 mt-2 ">
                                        <label>@Local["Ngày hết hạn"]</label>
                                        <div class="input-group mb-0">
                                            <input id="ExpiredDay" class="flatpickr detail form-control" type="text" placeholder="dd-mm-yyyy" />
                                            <span class="input-group-text"><i id="btn-remove-exprireday" class="remove link icon text-danger cursor-pointer"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="field col-12 col-md-12 col-sm-12 col-lg-6 px-1 mt-2">
                                        <label>@Local["Nhà cung cấp"]</label>
                                        <div class="input-group flex-nowrap">
                                            <div class="ui fluid search selection dropdown form-control" id="supplierDetail">
                                                <input type="hidden" />
                                                <i class="dropdown icon"></i>
                                                <input id="searchsupplier" class="search" autocomplete="off" tabindex="0" />
                                                <div class="default text">eg .@Local["Nhà cung cấp"]</div>
                                                <div id="cbbsupplierDetail" class="menu" tabindex="-1">
                                                </div>
                                            </div>
                                            <span class="input-group-text cursor-pointer text-center" style="width:40px;min-width:40px;" onclick="return WareHouse_NewSupplier();">
                                                <i class="fa fa-plus"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="field col-12 col-md-12 col-lg-3 col-sm-12 px-1 mt-2">
                                        <label>@Local["Đơn vị"]</label>
                                        <div class="ui fluid search selection dropdown form-control" style="max-width:100% !important;" id="productUnit" onchange="event.preventDefault();return ItemDetail_OnChangeUnit();">
                                            <input type="hidden" />
                                            <i class="dropdown icon"></i>
                                            <div class="default text">eg .@Local["Đơn vị"]</div>
                                            <div id="cbbproductUnit" class="menu" tabindex="-1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field col-12 col-md-12 col-lg-3 col-sm-12 px-1 mt-2 ">
                                        <label>@Local["Số lượng"]</label>
                                        <input id="numberProduct" class="form-control" type="number" name="numberProduct" onchange="event.preventDefault();return ItemDetail_UpdateAmount();" placeholder="eg .@Local["Số lượng"]" />
                                    </div>
                                </div>
                                <div class="row ">
                                    <div class="field col-12 px-1 mt-2 col-md-6 col-lg-3">
                                        <label>@Local["Đơn giá"]</label>
                                        <input id="Pro_ItemAmount" class="form-control" type="text" onchange="event.preventDefault();return ItemDetail_UpdateAmount();" placeholder="eg .@Local["Đơn giá"]" />
                                    </div>
                                    <div class="field col-12 px-1 mt-2 col-md-6 col-lg-3">
                                        <label>@Local["Tổng tiền"]</label>
                                        <input id="Pro_IniAmount" class="form-control" type="text" readonly="readonly" disabled="disabled" />
                                    </div>
                                    <div class="field col-12 px-1 mt-2 col-md-12 col-lg-3">
                                        <label>@Local["Giảm giá"]</label>
                                        <div class="position-relative">
                                            <input id="Pro_Discount" class="border-right-0 form-control" placeholder="eg .@Local["Giảm giá"]" type="number" onchange="event.preventDefault();ItemDetail_OnChangeDiscount();">
                                            <div class="ui fluid search selection dropdown form-control position-absolute end-0 top-0 w-auto ps-2 pe-4 dropdown-money" id="DiscountAmount" onchange="return ItemDetail_OnChangeDiscount();">
                                                <input type="hidden" name="name" value="2">
                                                <i class="dropdown icon opacity-0"></i>
                                                <input class="search" autocomplete="off" tabindex="0"><div class="text">VND</div>
                                                <div id="cbbDiscountAmountPer" class="menu transition hidden" tabindex="-1">
                                                    <div class="item" data-value="1">%</div>
                                                    <div class="item" data-value="2">VND</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field col-12 px-1 mt-2 col-md-12 col-lg-3 ">
                                        <label>@Local["Thành tiền"]</label>
                                        <input id="Pro_DiscountedAmount" type="text" readonly="readonly" disabled="disabled" class="form-control" placeholder="eg .@Local["Thành tiền"]" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="field col-12 mt-2 px-1 ">
                                        <label>@Local["Ghi chú"]</label>
                                        <textarea id="noteProduct" name="note" type="text" class="form-control" rows="3" placeholder="eg .@Local["Ghi chú"]"></textarea>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="field col-12 mt-2 px-1">
                                        <div class="d-flex">
                                            <div class="d-flex ms-auto align-items-center">
                                                <div class="mt-1 me-1 text-danger text-gradient text-sm font-weight-bold" id="textShowMessage"></div>
                                                <button type="button" class="btn btn-sm bg-gradient-primary mt-2 me-0 mb-0" onclick="event.preventDefault();return ItemDetail_Save();">@Local["Thêm mới"]</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="DetailInfo">
            <div class="row px-2" >
                <div class="col-12 col-xl-4 col-md-5 px-1">
                    <div id="StockInfo" class="card">
                        <div class="card-header pb-0">
                            <div class="d-lg-flex">
                                <div class="col-auto my-auto flex-grow-1">
                                    <div class="h-100 ">
                                        <h6 class="mb-0">@Local["Chi tiết phiếu"]</h6>
                                    </div>
                                    <div>
                                        <div class="d-none">
                                            <span class="pt-2 text-sm">@Local["Chứng từ nhập kho"]</span>
                                            <span id="txtDetailCodeReceipt" class="text-sm ps-2 text-primary fw-bold"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body pt-2">
                            <div class="row px-2">
                                <div class="field col-12 col-md-12 px-1 mt-2">
                                    <label class="title title_collapse" data-tab=""><span >@Local["Kho"]</span></label>
                                    <div class="ui fluid search selection dropdown form-control" id="DetailWareID" onchange="WareDetail_UpdateLastLock()">
                                        <input type="hidden" name="ware" />
                                        <i class="dropdown icon"></i>
                                        <input class="search" autocomplete="off" tabindex="0" />
                                        <div class="default text">eg .@Local["Kho"]</div>
                                        <div id="cbbDetailWareID" class="menu" tabindex="-1">
                                        </div>
                                    </div>
                                </div>
                                <div class="field col-12 col-md-12 px-1 mt-2">
                                    <label>@Local["Ngày chốt gần nhất"]</label>
                                    <input id="lock_date_detail" readonly="readonly" disabled="disabled" class="form-control">
                                </div>
                            </div>
                            <div class="row px-2 form3">
                                <div class="field col-12 col-md-12 px-1 mt-2 ">
                                    <div id="import_amount" class="field">
                                        <label>@Local["Tổng tiền"]</label>
                                        <input id="txtWare_Amount" readonly="readonly" class="form-control" disabled="disabled">
                                    </div>

                                </div>
                                <div class="field col-12 col-md-12 px-1 mt-2 ">
                                    <label>@Local["Ngày thao tác"]</label>
                                    <input id="Detail_Date" class="flatpickr detail form-control" type="text" placeholder="eg .@Local["Ngày thao tác"]" />
                                </div>
                            </div>
                            <div class="row px-2">
                                <div class="field col-12 col-sm-12 col-md-6 px-1 mt-2 ">
                                    <label>@Local["Số hóa đơn"]</label>
                                    <input id="numberInvoice" class="form-control" autocomplete="off">
                                </div>
                                <div class="field col-12 col-md-6 px-1 mt-2 ">
                                    <label>@Local["Số hợp đồng"]</label>
                                    <input id="numberContract" class="form-control" autocomplete="off">
                                </div>
                            </div>
                            <div class="row px-2">
                                <div class="field col-12 col-md-12 px-1 mt-2 ">
                                    <label>@Local["Ghi chú"]</label>
                                    <textarea id="txtWare_Content" name="content" rows="3" type="text" class="form-control"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="StockProductList" class="col-12 col-xl-8 col-md-7 px-1">
                    <div class="card">
                        <div class="card-header pb-0">
                            <div class="d-lg-flex">
                                <div class="col-auto my-auto">
                                    <div class="h-100 ">
                                        <h6 class="mb-0">@Local["Danh sách hàng"]</h6>
                                        <p id="headerStockExport" class="d-none text-sm mb-0">@Local["Phiếu xuất kho"] <span id="stockCodeExportHeader" class="text-primary fw-bold"></span></p>
                                        <p id="headerStockOrder" class="d-none text-sm mb-0 text-danger fw-bold">@Local["Không thể xoá chứng từ nhập kho được yêu cầu, phải xoá chứng từ yêu cầu"] <span id="stockCodeOrderHeader"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="TableStockProduct" class="card-body pt-2">
                            <div class="m-0 my-0 mobile-responsive h-100 pt-3">
                                <div id="" class="waitingdiv text-center" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                                <table class="table vt-table mb-0">
                                    <thead>
                                        <tr>
                                            <th class="d-none">ID</th>
                                            <th class="d-none">CusID</th>
                                            <th style="width:40px;">@Local["#"]</th>
                                            <th>@Local["Số lô"]</th>
                                            <th>@Local["Ngày hết hạn"]</th>
                                            <th style="min-width:150px;">@Local["Sản phẩm"]</th>
                                            <th>@Local["Đơn vị"]</th>
                                            <th>@Local["Số lượng"]</th>
                                            <th>@Local["Thành tiền"]</th>
                                            <th style="width:50px;" id="thRemoveProduct"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="StockProductBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <div class="fixed-botombutton mt-2">
            <div class="action_Save">
                <div class="text-danger text-gradient text-sm font-weight-bold" id="textShowMessageMaster"></div>
                <div class="action_Save-Content">
                    <button class="btn btn-secondary" form="form3" onclick="event.preventDefault();WareHouse_Close()">@Local["Đóng"]</button>
                    <button id="btnSaveDetail" style="display:none;" form="form3" type="button" class="btn bg-gradient-primary mt-2 me-2" onclick="return WareHouse_SaveDetail()">@Local["Lưu"]</button>
                    <button id="btnDeleteDetail" style="display:none;" form="form3" type="button" class="btn bg-gradient-danger mt-2 me-2" onclick="return WareHouse_DeleteDetail()">@Local["Xóa"]</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">

    //#region Declare & Initialize

    let ser_DetailID = "@Model._DetailCurrentID";
    let ser_WareID = "@Model._WareID";
    var product_selected = {};
    var data_TimerOnchange;
    let data_supplier;
    var data_product;
    let data_unit;
    let data_productunit;
    let EditButton = 1;
    var DataComboWare;
    let Flag_Ware = 0;
    let IsPackageNumber = 0;
    let stockCodeExport = '';
    let stockCodeReceipt = '';
    let stockCodeOrder = '';

    $(document).ready(function () {
        WareDetail_Setting(ser_DetailID);
        WareDetail_Initialize(ser_DetailID);
        WareDetail_Event();
    });

    //#region // Master


    function WareDetail_Setting(currentid) {

        $("#DetailImport").css("display", "flex");
        $("#ExpiredDay").flatpickr({
            dateFormat: 'd-m-Y',
            enableTime: false
        });

        $("#Detail_Date").flatpickr({
            dateFormat: 'd-m-Y H:i:s',
            enableTime: true,
            time_24hr: true,
            maxDate: new Date(),
            defaultDate: new Date()
        });

        $('#txtWare_Amount').divide();

        WareDetail_CalculatorView();
        let HeightProductItem = $("#ProductItem").outerHeight() - 55;
        $("#TableProduct").height(HeightProductItem);

        if (Number(currentid) != 0) {
            $('#btnPrintDetail').show();
        }
        ItemDetail_Refresh();
    }

    function WareDetail_CalculatorView(){
        let HeightListProduct = $("#StockInfo").outerHeight() - $("#StockProductList").find('.card-header').outerHeight();
        $("#TableStockProduct").height(HeightListProduct - 32);
    }

    function WareDetail_Event() {

        $('#StockProductBody').on('click', '.buttonDeleteClass', function (e) {
            let idProduct = Number($(this).closest('tr')[0].childNodes[0].innerHTML);
            if (ser_DetailID != "0") {
                WareHouse_CheckQuantityRealTime('delete', function () {
                    ItemDetail_DeleteRow(idProduct)
                }, 1, idProduct);
            }
            else {
                ItemDetail_DeleteRow(idProduct)
            }
            e.preventDefault();
        });

        $("#dtContentProductBody").on("click", '.itemProduct', function (e) {
            e.preventDefault();
            ItemDetail_Refresh();
            let id = $(this).attr("data-id");
            $("#productDetail").dropdown("refresh");
            $("#productDetail").dropdown("set selected", id.toString());
            WareDetail_FocusEditProduct();
        });

        $('.input-group .remove.icon').on('click', function (e) {
            $(this).parent().siblings().val("");
            e.stopPropagation();
        });

        $('#searchingProduct').keyup(function () {
            if ($(this).val().length > 0) $(".btn_clear").removeClass('opacity-1');
            $("#wareSearch .fa-search").hide();
            $("#wareSearch .spinner-border").show();
            clearTimeout(data_TimerOnchange);
            data_TimerOnchange = setTimeout(function (e) {
                WareDetail_Search(xoa_dau($('#searchingProduct').val().toLowerCase()).trim());
            }, 500);
        });

    }
    function WareDetail_Search(text) {
        let data;
        if (text == "") {
            data = data_product;

        }
        else {
            data = data_product.filter((word) => xoa_dau(word["Name"].toLowerCase()).includes(text)
                || xoa_dau(word["Code"].toLowerCase()).includes(text)
            );
        }
        fnRenderBlock(data, "dtContentProductBody"
            , blocknum = 100
            , fnrender = ItemDetail_RenderProductList
            , fnsuccess = function () {
                ColorSearchFilterText(text, "itemProduct");
            }
            , fnbegin = function () {
                $("#dtContentProductBody").empty();
            }
        );

        $("#wareSearch .fa-search").show();
        $("#wareSearch .spinner-border").hide();
    }

    function WareDetail_UpdateLastLock() {
        let WareIDChoose = Number($('#DetailWareID').dropdown('get value'));
        let dataWare = DataComboWare.filter(word => word["ID"] == WareIDChoose);
        let lastestLock = '';
        if (dataWare && dataWare.length > 0 && "01-01-1900 00:00" != dataWare[0].LastetLock) {
            lastestLock = dataWare[0].LastetLock;
        }
        else {
            lastestLock = '';
        }

        if (dataWare && dataWare.length > 0 && dataWare[0].IsPackageNumber == 1) {
            IsPackageNumber = 1;
            $("#PackageNumber").prop("disabled", false);
            $("#btn-remove-exprireday").hide();
        }
        else {
            IsPackageNumber = 0;
            $("#PackageNumber").prop("disabled", true);
            $("#PackageNumber").val("");
            $("#btn-remove-exprireday").show();
        }

        $("#lock_date_detail").val(lastestLock);

        $("#Detail_Date").flatpickr({
            dateFormat: 'd-m-Y H:i:s',
            enableTime: true,
            time_24hr: true,
            minDate: lastestLock,
            maxDate: new Date(),
            defaultDate: new Date()
        });

    }


    function WareDetail_Initialize(id) {
        AjaxLoad(url = "/WareHouse/Stock/StockInDetail/?handler=Initialize"
                , data = {'currentid': id }, async = true, error = null
                , success = function (result) {
                    if (result != "0") {
                        let data = JSON.parse(result);
                        data_product = data.Product;
                        data_productunit = data.UnitProduct;
                        data_unit = data.Unit;
                        data_supplier = data.Supplier;
                        Load_Combo(data_product, "cbbproductDetail", true);
                        fnRenderBlock(data_product, "dtContentProductBody"
                            , blocknum = 100
                            , fnrender = ItemDetail_RenderProductList
                            , fnsuccess = function () {
                            }
                            , fnbegin = function () {
                                $("#dtContentProductBody").empty();
                            }
                        );
                        Load_Combo(data_supplier, "cbbsupplierDetail", true);
                        DataComboWare = data.Warehouse;
                        Load_Combo(DataComboWare, "cbbDetailWareID", true);
                        if (DataComboWare && DataComboWare.length > 0) {
                            let wareID = ser_WareID != "0" ? ser_WareID : DataComboWare[0].ID
                            $("#DetailWareID").dropdown("refresh");
                            $("#DetailWareID").dropdown("set selected", wareID);
                            WareDetail_UpdateLastLock();
                        }
                        if (Number(id) != 0) {
                            WareDetail_RenderData(data.Info, data.Items);
                        }
                        else {
                            $('#btnSaveDetail').show()
                            $("#DetailImport").css("display", "flex");
                            $('#detail_Item').show();
                        };
                        $("#StockInMain").removeClass("opacity-0")
                        Flag_Ware = 1;
                    }
                }
            );

    }

    function WareDetail_RenderData(DataMaster, DataDetail) {
        if (DataMaster.length != 0) {
            stockCodeExport = DataMaster[0].CodeExport;
            stockCodeOrder = DataMaster[0].CodeOrder;
            stockCodeReceipt = DataMaster[0].CodeReciept;
            $('#txtDetailCodeReceipt').html(stockCodeReceipt);
            $('#txtDetailCodeReceipt').parent().removeClass('d-none');
            if(stockCodeExport != ''){
                $("#headerStockExport").removeClass("d-none")
                $('#stockCodeExportHeader').html(stockCodeExport);
            }
            if(stockCodeOrder != ''){
                $("#headerStockOrder").removeClass("d-none")
                $('#stockCodeOrderHeader').html(stockCodeOrder);
            }

            $('#txtWare_Content').val((DataMaster[0].Content));
            $('#numberContract').val((DataMaster[0].ContractNumber));
            $('#numberInvoice').val((DataMaster[0].InvoiceNumber));
            $("#DetailWareID").dropdown("refresh");
            $("#DetailWareID").dropdown("set selected", DataMaster[0].WareID);
            $('#Detail_Date').val(GetDateTime_String_DMYHMSS(DataMaster[0].DateExecute));
            let perlock = Number(DataMaster[0].PerLock);
            let perPassing = Number(DataMaster[0].PerPassing);
            let perdate = Number(DataMaster[0].PerDate);
            let peruser = Number(DataMaster[0].PerUser);
            let transferID = Number(DataMaster[0].TransferID);
            let OrderIDMaster = Number(DataMaster[0].OrderID_Master);
            if (transferID != 0 || OrderIDMaster != 0) {
                $("#DetailImport").hide();
                $('#btnSaveDetail').remove();
            }
            else {
                $("#DetailImport").css("display", "flex");
            }
            if ((perPassing == 1 || (perdate == 1 && peruser == 1)) && perlock == 1 ) {
                EditButton = 1;
            } else EditButton = 0;
            if (EditButton == 0) {
                $('#detail_Item').hide();
                $('#DetailInfo').find('input, textarea, button, select').attr('disabled', 'disabled');
                $('#DetailWareID').addClass("disabled");
                $('#btnSaveDetail').remove();
                $('#btnDeleteDetail').remove();
                $("#DetailImport").hide();
                $("#Detail_Date").flatpickr({
                    dateFormat: 'd-m-Y H:i:s',
                    enableTime: true,
                    time_24hr: true,
                    maxDate: new Date(),
                    defaultDate: new Date()
                });
                $('#Detail_Date').val(GetDateTime_String_DMYHMSS(DataMaster[0].DateExecute));
            } else {
                $('#btnSaveDetail').show();
                $('#detail_Item').show();
                $('#btnDeleteDetail').show();
            }
            WareDetail_CalculatorView();
        }
        for (let i = 0; i < DataDetail.length; i++) {
            let item = DataDetail[i];
            var element = {};
            let indexPackNum = item.packageNumber.indexOf("-");
            let packNum = indexPackNum != -1 ? (item.packageNumber).substring(0, indexPackNum) : item.packageNumber;
            element.id = item.idProduct;
            element.packageNumber = packNum;
            element.idProduct = item.idProduct;
            element.SupplierID = (item.SupplierID);
            element.UnitCountID = item.UnitCountID;
            element.NameProduct = item.NameProduct;
            element.NameSupplier = item.NameSupplier;
            element.NameUnit = item.NameUnit;
            element.Number = Number(item.Number).toString();
            element.Amount =  item.Amount ;
            element.Note = item.Note;
            element.Unit_Standard = item.Unit_Standard;
            element.state = item.state.toString();
            element.idDetail = item.idDetail;
            element.ExpiredDay = item.ExpiredDay;
            element.IniAmount = item.IniAmount;
            element.DiscountAmount = item.DiscountAmount;
            element.DiscountPer = item.DiscountPer;
            element.UnitPrice = item.UnitPrice;
            product_selected[item.idProduct] = element;
            ItemDetail_Render(item.idProduct, element, "StockProductBody");

        }
        WareHouse_UpdateInfo();
    }

    function WareHouse_UpdateInfo() {
        let data = [];
        let TotalAmount = 0;
        for ([key, value] of Object.entries(product_selected)) {
            data.push(value);
            TotalAmount = TotalAmount + Number(value.Amount);
        }
        $('#DetailWareID').addClass("disabled");
        $('#txtWare_Amount').val(TotalAmount);
    }

    //#region // EXECUTE

    function WareHouse_SaveDetail() {
        WareHouse_SaveBefore();
        var DateExecute = $('#Detail_Date').val() ? $('#Detail_Date').val() : "";
        let ware = Number($('#DetailWareID').dropdown('get value')) ? Number($('#DetailWareID').dropdown('get value')) : 0;
        let note = $('#txtWare_Content').val() ? $('#txtWare_Content').val() : '';
        let numberContract = $('#numberContract').val() ? $('#numberContract').val() : '';
        let numberInvoice = $('#numberInvoice').val() ? $('#numberInvoice').val() : '';
        let supplierID = (product_selected && Object.values(product_selected).length != 0) ? Object.values(product_selected)[0].SupplierID : 0;
        let dataObj = Object.values(product_selected);
        //for ([key, value] of Object.entries(product_selected)) {
        //    value.packageNumber = ((IsPackageNumber == 1) ? value.packageNumber + '-' + value.idProduct : value.packageNumber);
        //    dataObj.push(value);
        //}
        document.getElementById("textShowMessageMaster").innerHTML = "";
        let error = 0;
        if (ware == 0) {
            $('#DetailWareID').closest('.field').addClass('error');
            $("#textShowMessageMaster").html('@Local["Chưa chọn kho cần nhập"]');
            error = 1;
        }
        else {
            $('#DetailWareID').closest('.field').removeClass('error');
        }
        if (dataObj == undefined || dataObj == null || dataObj.length == 0) {
            error = 1; $("#textShowMessageMaster").html('@Local["Không có mặt hàng nhập kho"]');
        }
        if (error == 0) {
            if (ser_DetailID != "0") {
                WareHouse_CheckQuantityRealTime('save', function () {
                    WareHouse_SaveDetail_Next(ser_DetailID, ware, supplierID, note, numberContract, numberInvoice, DateExecute, dataObj);
                });
            }
            else {
                WareHouse_SaveDetail_Next(ser_DetailID, ware, supplierID, note, numberContract, numberInvoice, DateExecute, dataObj);
            }
        }
        else WareHouse_SaveComplete();
    }

    function WareHouse_CheckQuantityRealTime(type, fcSuccess, IsDeleteItem = 0, idProduct = 0) {
        let ware = Number($('#DetailWareID').dropdown('get value')) ? Number($('#DetailWareID').dropdown('get value')) : 0;
        let DateExecute = $('#Detail_Date').val() ? $('#Detail_Date').val() : "";
        let dataProduct = [];

        for ([key, value] of Object.entries(product_selected)) {
            let _e = {};
            _e.packageNumber = value.packageNumber != "" ? value.packageNumber : "";
            _e.idProduct = value.idProduct;
            if (type == 'save') {
                _e.number = ItemDetail_CheckStockQuantity(value.idProduct, value.UnitCountID, value.Number)
            } 
            else {
                if (IsDeleteItem == 0) {
                    _e.number = 0
                } 
                else {
                    if (idProduct == key) {
                        _e.number = 0
                    }
                }
            }
            dataProduct.push(_e);
        }
        AjaxLoad(url = "/WareHouse/Stock/StockInDetail/?handler=CheckQuantityRealTime"
            , data = {
                'data': JSON.stringify(dataProduct)
                , 'ware': ware
                , 'DateExecute': DateExecute
                , 'CurrentID': ser_DetailID
            }
            , async = true, error = null
            , success = function (result) {
                if (result != "0") {
                    let dataResult = JSON.parse(result);
                    let dataNext = dataResult.Table;
                    let dataProductExist = dataResult.Table1;
                    if (dataNext && dataNext.length != 0 && dataNext[0].RESULT != 1) {
                        $("#textShowMessageMaster").html('@Local["Ngày xử lý phải lớn hơn ngày chốt kho gần nhất"]');
                    }
                    else {
                        if (WareHouse_StockQuantityError(dataProductExist) == 1) {
                            if (fcSuccess && typeof fcSuccess == 'function') {
                                fcSuccess();
                            }
                        }
                        else {
                            if (type == 'save')
                                $("#textShowMessageMaster").html('@Local["Số lượng nhập kho phải lớn hơn số lượng đã xuất"]');
                            else $("#textShowMessageMaster").html('@Local["Không thể xóa. Số lượng nhập kho phải lớn hơn số lượng đã xuất"]');
                        }
                    }
                }
                else {
                    notiError("@Local["Ngày xử lý phải lớn hơn ngày chốt kho gần nhất"]");
                }
            }
            , sender = $("#btnSaveDetail")
        );
    }

    function WareHouse_SaveDetail_Next(id, ware, supplier, note, numberContract, numberInvoice, date, data) {
        AjaxLoad(url = "/WareHouse/Stock/StockInDetail/?handler=ExcuteData"
            , data = {
                'data': JSON.stringify(data)
                , 'ware': ware
                , 'supplierID': supplier
                , 'note': note
                , 'numberContract': numberContract
                , 'numberInvoice': numberInvoice
                , 'DateExecute': date
                , 'CurrentID': id
                , 'IsPackageNumber': IsPackageNumber
            }
            , async = true
            , error = null
            , success = function (result) {
                if (result != "0") {
                    let data = JSON.parse(result);
                    if (data && data.length != 0) {
                        let IDComplete = Number(data[0].RESULT);
                        let Code = data[0].CODE;
                        if (IDComplete != 0) {
                            notiSuccess();
                            WareHouse_Close();
                            if (Number(ser_DetailID) == 0) StockList_Load(0, 0, 0);
                            else StockList_Load(0, IDComplete, 1);
                            if (typeof StockStatusMin_Load === 'function') StockStatusMin_Load();
                            syslog_whr((ser_DetailID != '0' ? 'u' : 'i'), Code);
                        }
                        else {
                            notiError("@Local["Ngày xử lý phải lớn hơn ngày chốt kho gần nhất"]");
                        }
                    }
                    else {
                        notiError_SW();
                    }
                }
                else {
                    notiError("@Local["Ngày xử lý phải lớn hơn ngày chốt kho gần nhất"]");
                }
            }
            , sender = null
            , before = function (e) {

            },
            complete = function (e) {
                 WareHouse_SaveComplete();
            }
        );
    }

    function WareHouse_StockQuantityError(data) {
        let isNext = 1;
        if (data && data.length != 0) {
            for (let i = 0; i < data.length; i++) {
                let item = data[i];
                let _id = "row_" + item.ProductID;
                let _finalNum = Number(item.FinalNum) ? Number(item.FinalNum) : 0;
                if (_finalNum < 0) {
                    isNext = 0;
                    $("#" + _id).addClass("error")
                }
                else {
                    $("#" + _id).removeClass("error")
                }
            }
        }
        return isNext;
    }

    function ItemDetail_CheckStockQuantity(productID, unitID, number) {
        try {
            let numberExport = 0;
            if (productID != 0 && unitID != 0 && number != 0 ) {
                let dtProduct = data_product.filter(word => word["ID"] == productID);
                if (dtProduct && dtProduct.length != 0) {
                    let unitStandard = dtProduct[0].UnitID;
                    if (unitID != unitStandard) {
                        let dtUnit = data_productunit.filter(word => word["UnitChange"] == unitID && word["ProductID"] == productID)
                        let numberChange = 1;
                        if (dtUnit && dtUnit.length > 0) {
                            numberChange = dtUnit[0]["Number"];
                        };
                        numberExport = numberChange * number;
                    }
                    else {
                        numberExport = number;
                    }
                }
            }
            return numberExport;
        }
        catch (ex) {
            return 1;
        }
    }
    function WareHouse_SaveBefore() {
        $("#btnSaveDetail").prop("disabled", true);
    }
    function WareHouse_SaveComplete() {
        $("#btnSaveDetail").prop("disabled", false);
    }
    //#endregion

    function WareHouse_DeleteDetail() {
        WareHouse_CheckQuantityRealTime('delete' , function () {
            const promise = notiConfirm();
            promise.then(function () {
                let ware = Number($('#DetailWareID').dropdown('get value')) ? Number($('#DetailWareID').dropdown('get value')) : 0;
                WareHouse_DeleteExecute(ser_DetailID, ware);
            }, function () { });
        })
    }

    function WareHouse_DeleteExecute(id, ware) {
        AjaxLoad(url = "/WareHouse/Stock/StockInDetail/?handler=DeleteItem"
            , data = {
                'id': id,
                'typeid': 1,
                'ware': ware,
            }
            , async = true
            , error = null
            , success = function (result) {
                if (result != "0") {
                    WareHouse_Close();
                    notiSuccess();
                    if ($('#stdetail_' + id + '-1').length) $('#stdetail_' + id + '-1').remove();
                    if (typeof StockStatusMin_Load === 'function') StockStatusMin_Load();
                    if (typeof ViewForm_Close === 'function') ViewForm_Close();
                    syslog_whr('d', result);

                } else {
                    notiError_SW();
                }
            }
        );

    }

    function WareDetail_FocusEditProduct() {
        $('#BodyMain').scrollTo($("#ProductItem").offset().top - 50);
        $("#ProductItem").addClass("border-active");
        setTimeout(function () {
            $("#ProductItem").removeClass("border-active");
        }, 2000)
    }

    //#endregion

    //#region // Add New Supplier

    function WareHouse_NewSupplier() {
        $("#DetailModal_Content").html('');
        $("#DetailModal_Content").load("/WareHouse/Setting/SupplierDetail?ver=" + versionofWebApplication);
        $('#DetailModal').modal('show');
        return false;
    }

    function WareHouse_LoadSupplier(id) {
        AjaxLoad(url = "/WareHouse/Stock/StockInDetail/?handler=LoadSupplier"
            , data = {}, async = true, error = null
            , success = function (result) {
                if (result != "0") {
                    let data = JSON.parse(result);
                    data_supplier = data;
                    let product = Number($('#productDetail').dropdown('get value')) ? Number($('#productDetail').dropdown('get value')) : 0;
                    if (product == 0) {
                        Load_Combo(data_supplier, "cbbsupplierDetail", true);

                    } else {
                        ItemDetail_LoadSup(product);
                    }
                    $("#supplierDetail").dropdown("refresh");
                    $("#supplierDetail").dropdown("set selected", id );
                }
            });
    }

    function ItemDetail_AddSupplier(id) {
        if (id && id != 0) {
            WareHouse_LoadSupplier(id);
        }
    }

    //#endregion

    //#region // Add New Product

    function WareHouse_NewProduct() {
        $("#DetailModal_Content").html('');
        $("#DetailModal_Content").load("/WareHouse/Material/MaterialDetail" + "?ver=" + versionofWebApplication);
        $('#DetailModal').modal('show');
        return false;
    }

    async function WareHouse_LoadProduct(id) {
        return new Promise((resolve) => {
            AjaxLoad(url = "/WareHouse/Stock/StockInDetail/?handler=LoadProduct"
                , data = {}, async = true, error = null
                , success = function (result) {
                    if (result != "0") {
                        let data = JSON.parse(result);
                        data_product = data.Product;
                        data_productunit = data.UnitProduct;
                        Load_Combo(data_product, "cbbproductDetail", true);
                        fnRenderBlock(data_product, "dtContentProductBody"
                            , blocknum = 100
                            , fnrender = ItemDetail_RenderProductList
                            , fnsuccess = function () { }
                            , fnbegin = function () {
                                $("#dtContentProductBody").empty();
                            }
                        );
                        if (id != 0) {
                            $("#productDetail").dropdown("refresh");
                            $("#productDetail").dropdown("set selected", id);
                        }

                    }
                });
        })
    }

    function ItemDetail_AddProduct(id) {
        if (id && id != 0) {
            WareHouse_LoadProduct(id);
        }
    }

    //#endregion


    //#region // Item

    function ItemDetail_Refresh() {
        $('#productDetail').dropdown('clear');
        $('#productUnit').dropdown('clear');
        $('#supplierDetail').dropdown('clear');
        $('#PackageNumber').val('');
        $('#ExpiredDay').val('');
        $("#ExpiredDay").closest('.input-group').removeClass("pe-none");
        $('#noteProduct').val('');

        $('#Pro_DiscountedAmount').divide();
        $('#Pro_DiscountedAmount').val(0);
        $('#Pro_ItemAmount').divide();
        $('#Pro_ItemAmount').val(0);
        $('#Pro_IniAmount').divide();
        $('#Pro_IniAmount').val(0);
        $('#Pro_Discount').val(0);

        $('#DiscountAmount').dropdown('refresh');
        $('#DiscountAmount').dropdown('set value', 1);
        $('#numberProduct').val(0);

    }

    function ItemDetail_DeleteRow (idProduct) {
        delete product_selected[idProduct];
        $('#row_' + idProduct).remove();
        WareHouse_UpdateInfo();
    }

    function ItemDetail_Save() {
        document.getElementById("textShowMessage").innerHTML = "";
        let packageNumber = $('#PackageNumber').val() ? ($('#PackageNumber').val()).replace(/[^a-zA-Z0-9]/g, '').trim() : "";
        let product = Number($('#productDetail').dropdown('get value')) ? Number($('#productDetail').dropdown('get value')) : 0;
        let supplier = Number($('#supplierDetail').dropdown('get value')) ? Number($('#supplierDetail').dropdown('get value')) : 0;
        let productDetailUnit = Number($('#productUnit').dropdown('get value')) ? Number($('#productUnit').dropdown('get value')) : 0;
        let numberProduct = $('#numberProduct').val() ? $('#numberProduct').val() : 0;
        let Pro_ItemAmount = $('#Pro_ItemAmount').val() ? $('#Pro_ItemAmount').val() : 0;
        let Pro_IniAmount = $('#Pro_IniAmount').val() ? $('#Pro_IniAmount').val() : 0;
        let Pro_Discount = $('#Pro_Discount').val() ? $('#Pro_Discount').val() : 0;
        let DiscountType = Number($('#DiscountAmount').dropdown('get value')) ? Number($('#DiscountAmount').dropdown('get value')) : 0;

        let Pro_DiscountedAmount = $('#Pro_DiscountedAmount').val() ? $('#Pro_DiscountedAmount').val() : 0;
        let noteProduct = $('#noteProduct').val() ? $('#noteProduct').val() : '';
        let expiredDay = $('#ExpiredDay').val() ? $('#ExpiredDay').val() : '01-01-1900';
        let standardUnit = 0;
        //let standardNumber = 0;

        //#region //Validate
        let isError = 0;
        if (!$.isNumeric(numberProduct) || Number(numberProduct) < vtth_range_min || Number(numberProduct) > vtth_range_max) {
            $('#numberProduct').closest('.field').addClass('error')
            isError = 1;
        }
        else $('#numberProduct').closest('.field').removeClass('error')
        if (product == 0) {
            $('#productDetail').closest('.field').addClass('error')
            isError = 1;
        }
        else $('#productDetail').closest('.field').removeClass('error')
        if (IsPackageNumber == 1 && packageNumber == "") {
            $('#PackageNumber').closest('.field').addClass('error')
            isError = 1;
        }
        else $('#PackageNumber').closest('.field').removeClass('error')
        if (productDetailUnit == 0) {
            $('#productUnit').closest('.field').addClass('error')
            isError = 1;
        }
        else $('#productUnit').closest('.field').removeClass('error')
        let isProductExist = 0;
        let keyProductExist = 0;
        for ([key, value] of Object.entries(product_selected)) {
            if (value.idProduct == product) {
                isProductExist = 1;
                keyProductExist = [key];
                //delete product_selected[key];
                break;
            }
        }
        //#endregion

        if (isError == 0 && isProductExist == 0) {
            document.getElementById("textShowMessage").innerHTML = "";
            document.getElementById("textShowMessageMaster").innerHTML = ""
            var element = {};
            element.id = product;
            element.packageNumber = packageNumber;
            element.idProduct = product;
            element.SupplierID = supplier ;
            element.UnitCountID = productDetailUnit;
            element.NameProduct = $('#productDetail').dropdown('get text');
            element.NameSupplier = $('#supplierDetail').dropdown('get value') != "" ? $('#supplierDetail').dropdown('get text') : "";
            element.NameUnit = $('#productUnit').dropdown('get text');
            element.Number = Number(numberProduct).toString();
            element.Amount = Pro_DiscountedAmount ;
            element.Note = noteProduct;
            element.state = "1";
            element.Unit_Standard = standardUnit.toString();
            element.idDetail = "0";
            element.ExpiredDay = expiredDay;
            element.IniAmount = Pro_IniAmount;
            element.DiscountAmount = (DiscountType == 1) ? (Math.round((Pro_Discount * Pro_IniAmount / 100) * 100) / 100) : Pro_Discount;
            element.DiscountPer = (DiscountType == 1) ? Pro_Discount : 0;
            element.UnitPrice = Pro_ItemAmount;
            product_selected[product] = element;

            ItemDetail_Render(product, element, "StockProductBody");
            WareHouse_UpdateInfo();
            ItemDetail_Refresh();
        }
        else if (isProductExist == 1) {
            document.getElementById("textShowMessage").innerHTML = "@Local["Hàng nhập kho đã được chọn"]";
            $('#row_' + keyProductExist).addClass("border-active");
        }
        else {
            document.getElementById("textShowMessage").innerHTML = "@Local["Kiểm tra dữ liệu"]";
        }
        return false;
    }
    function ItemDetail_DetectUnit() {
        ItemDetail_LoadUnit();
        return false;
    }
    function ItemDetail_LoadUnit() {
        let product = Number($('#productDetail').dropdown('get value')) ? Number($('#productDetail').dropdown('get value')) : 0;
        let data = ItemDetail_LoadUnitAction(product, data_product, data_productunit)
        if (data != undefined && data != null && data.length != 0) {
            Load_Combo(data, "cbbproductUnit", true);

            $("#productUnit").dropdown("refresh");
            $("#productUnit").dropdown("set selected", Number(data[0].ID));
        }
        ItemDetail_LoadSup(product);
        return false;
    }

    function ItemDetail_LoadUnitAction(idProduct, products, unitproduct) {
        let _data = [];
        let pro = products.filter(word => word["ID"] == idProduct);
        if (pro && pro.length > 0) {
            _data.push({ "ID": pro[0].UnitID, "Name": pro[0].UnitName });
            let unit = unitproduct.filter(word => word["ProductID"] == idProduct);
            if (unit != undefined && unit.length > 0) {
                for (let i = 0; i < unit.length; i++) {
                    _data.push({
                        "ID": unit[i].UnitChange,
                        "Name": unit[i].UnitChangeName
                            + '<a class="btn-link  mb-0 ms-2 p-0 px-1 pe-2">'
                            + ' x' + unit[i].Number + ' '
                            + pro[0].UnitName
                            + '</a>'
                    });
                }
            }
        }
        return _data;
    }

    function ItemDetail_LoadSup(ProductID) {
        if (product_selected && Object.values(product_selected).length != 0) {
            let supplierID = Object.values(product_selected)[0].SupplierID ? Object.values(product_selected)[0].SupplierID : 0;
            $("#supplierDetail").addClass("disabled");
            $("#supplierDetail").dropdown("refresh");
            $("#supplierDetail").dropdown("set selected", supplierID);
        }
        else {
            ///supplier
            let isSupplier = 0;
            data_supplier.sort(function (a, b) {
                if (a.TokenMaterial.includes(ProductID.toString())) {
                    a.Name = '<span style="color: #0288d1;">' + a.NameString + '</span>';
                    isSupplier = 1;
                    return -1;
                } else {
                    a.Name = a.NameString;
                }
                if (b.TokenMaterial.includes(ProductID.toString())) {
                    b.Name = '<span style="color: #0288d1;">' + b.NameString + '</span>';
                    isSupplier = 1;
                    return 1;
                } else {
                    b.Name = b.NameString;
                }
                return 0;
            });

            if (data_supplier.length > 0) {
                Load_Combo(data_supplier, "cbbsupplierDetail", true);
                //if (isSupplier == 1) {
                $("#supplierDetail").dropdown("refresh");
                $("#supplierDetail").dropdown("set selected", Number(data_supplier[0].ID));
                //}
            }
            $("#supplierDetail").removeClass("disabled");
        }
    }

    function ItemDetail_OnChangeDiscount() {
        if (Flag_Ware == 1) {
            Flag_Ware = 0;
            let IniAmount = $('#Pro_IniAmount').val() ? $('#Pro_IniAmount').val() : 0;
            let type = Number($('#DiscountAmount').dropdown('get value')) ? Number($('#DiscountAmount').dropdown('get value')) : 0;
            if (!isNaN($('#Pro_Discount').val()) || $('#Pro_Discount').val() == '') {
                let value = Number($('#Pro_Discount').val() ? $('#Pro_Discount').val() : 0);
                if (type == 1 && (value > 100 || value < 0)) {
                    $('#Pro_Discount').val(0);
                }
                if (type == 2 && (value > IniAmount || value < 0)) {
                    $('#Pro_Discount').val(0);
                }
            }
            else {
                $('#Pro_Discount').val(0);
            }
            Flag_Ware = 1;
            ItemDetail_UpdateAmount();
        }
    }

    function ItemDetail_OnChangeUnit() {
        if (Flag_Ware == 1) {
            Flag_Ware = 0;
            let item_price = 0
            let unitID = Number($('#productUnit').dropdown('get value')) ? Number($('#productUnit').dropdown('get value')) : 0;
            let productID = Number($('#productDetail').dropdown('get value')) ? Number($('#productDetail').dropdown('get value')) : 0;
            let data_p = data_product.filter(word => word["ID"] == productID)
            if (data_p && data_p.length > 0) {
                let numberChange = 1;
                let unitstandard = Number(data_p[0]["UnitID"])
                if (unitstandard != unitID) {
                    let unit_p = data_productunit.filter(word => word["UnitChange"] == unitID && word["ProductID"] == productID)
                    if (unit_p && unit_p.length > 0) {
                        numberChange = unit_p[0]["Number"];
                        item_price = data_p[0]["Cost_Price"] * numberChange;
                    }
                }
                else item_price = data_p[0]["Cost_Price"];
            }
            $('#Pro_ItemAmount').val(Math.round(item_price * 100) / 100);
            Flag_Ware = 1;
            ItemDetail_UpdateAmount();
        }
    }

    function ItemDetail_UpdateAmount() {
        if (Flag_Ware == 1) {
            Flag_Ware = 0;
            let pridisconted = 0;
            let total_price = 0; number_discount = 0;

            let numberProduct = $('#numberProduct').val() ? $('#numberProduct').val() : 0;
            let item_price = $('#Pro_ItemAmount').val() ? $('#Pro_ItemAmount').val() : 0;
            total_price = item_price * numberProduct;
            let discountValue = $('#Pro_Discount').val() ? $('#Pro_Discount').val() : 0;
            let discountType = Number($('#DiscountAmount').dropdown('get value')) ? Number($('#DiscountAmount').dropdown('get value')) : 0;
            let discountAmount = 0;

            if (discountType == 1) {
                discountAmount = (total_price * discountValue) / 100;
            }
            else {
                discountAmount = discountValue;
            }
            pridisconted = total_price - discountAmount;
            $('#Pro_IniAmount').val(Math.round(total_price * 100) / 100);
            $('#Pro_DiscountedAmount').val(Math.round(pridisconted * 100) / 100);
            Flag_Ware = 1;
        }
    }

    async function ItemDetail_Render(key, item, id) {
        return new Promise((resolve) => {
            setTimeout(() => {
                var myNode = document.getElementById(id);
                if (myNode != null) {
                    let tr = '<td class="d-none">' + key + '</td>'
                        + '<td class="vt-number-order text-center"></td>'
                        + '<td >'
                        + ((item.packageNumber != "") ? '<h6 class="fw-bold mb-0 text-sm  text-uppercase ellipsis_one_line">' + item.packageNumber + '</h6>' : "")
                        + '</td>'
                        + '<td>' + item.ExpiredDay + '</td>'
                        + '<td>'
                        + '<h6 class="mb-0 text-sm ellipsis_one_line text-primary">' + item.NameProduct + '</h6>'
                        + ((item.NameSupplier != '') ? '<p class="text-dark text-xs mb-0 mt-0">' + item.NameSupplier + '</p>' : '')
                        + '</td>'
                        + '<td >' + item.NameUnit + '</td>'
                        + '<td class="text-center">' + formatNumber(item.Number) + '</td>'
                        + '<td >' + formatNumber(item.Amount) + '</td>'
                        + (((EditButton == 1))
                            ? '<td><button title="@Local["Xóa"]" class="buttonGrid"><i class="buttonDeleteClass vtt-icon vttech-icon-cancel-01 text-danger"></i></button></td>'
                            : '<td></td>')
                    tr = '<tr id="row_' + key + '" class="productRow vt-number">' + tr + '</tr>'
                    myNode.insertAdjacentHTML('beforeend', tr);
                }
            }, 10)
        })
    }

    async function ItemDetail_RenderProductList(data, id) {
        return new Promise((resolve) => {
            setTimeout(() => {
                var myNode = document.getElementById(id);
                if (myNode != null) {
                    if (data && data.length > 0) {
                        for (var i = 0; i < data.length; i++) {
                            let item = data[i];
                            let tr = `
                            <td class="d-none">${item.ID}</td>
                            <td class="vt-number-order"></td>
                            <td>
                                <a class="text-dark fw-bold buttonEditClass cursor-pointer d-block">${item.Code}</a>
                                <div class="ellipsis_one_line">${item.Name}</div>
                            </td>`
                            tr = `<tr class="itemProduct vt-number cursor-pointer" role="row" data-id="${item.ID}" data-name="${item.Name}">${tr}</tr>`;
                            myNode.insertAdjacentHTML('beforeend', tr);
                        }
                    }
                    resolve();
                }
            }, 10)
        })

    }

    //#endregion


    //#region //  Onchange Package

    function WareHouse_OnchangePackage() {
        let packName = $("#PackageNumber").val() ? $("#PackageNumber").val() : '';
        let productID = Number($('#productDetail').dropdown('get value')) ? Number($('#productDetail').dropdown('get value')) : 0;
        if (packName && productID && packName != '' && productID != 0) {
            WareHouse_GetExpiredDate(productID, packName);
        }
    }

    function WareHouse_GetExpiredDate(productid, packagenumber) {
        AjaxLoad(url = "/WareHouse/Stock/StockInDetail/?handler=GetExpiredDate"
            , data = {
                'productid': productid
                , 'packagenumber': packagenumber

            }
            , async = true, error = null
            , success = function (result) {
                let isexp = 0;
                if (result != "0") {
                    let dte = JSON.parse(result);
                    if (dte != undefined && dte.length != 0) {
                        let dexp = dte[0].Expired;
                        if (!dexp.includes('1900')) {
                            isexp = 1;
                            $("#ExpiredDay").val(ConvertDateTimeUTC_DMY(dexp));
                            $("#ExpiredDay").closest('.input-group').addClass("pe-none");
                        }
                    }
                }
                if (isexp == 0) {
                    $("#ExpiredDay").flatpickr({
                        dateFormat: 'd-m-Y',
                        enableTime: false,
                        defaultDate: new Date(),
                    });
                    $("#ExpiredDay").closest('.input-group').removeClass("pe-none");
                }

            }
        );
    }

    //#endregion


</script>

<script src="/js/main.js" async></script>
<script src="/js/customjs/custom-validation.js"></script>



<style>
    .productRow.error {
        background-color: #ff9898 !important;
    }

    .promotion {
        font-size: 10px;
        color: red;
    }

    #ProductItem.border-active {
        animation: spin 1s linear infinite alternate;
    }

    .itemProduct {
        transition: 0.2s all;
    }

        .itemProduct:hover {
            background-color: var(--bs-blue);
        }

    @@media only screen and (max-width:767px) {
        #StockProductList {
            order: 2;
        }
    }

    @@keyframes spin {
        from {
            background-color: white;
        }

        to {
            background-color: #ffe9e9;
        }
    }
</style>