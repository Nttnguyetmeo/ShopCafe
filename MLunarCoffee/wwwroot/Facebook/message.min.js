function FBM_Load(n,t=0){try{fcd_XhrLoadMess&&fcd_XhrLoadMess.readyState!=4&&fcd_XhrLoadMess.abort();let i=t==0?fl_messlist.replace("{conid}",n):fcd_UrlMessNext;if(t==0&&$("#fbm_content").html(""),i=="")return;fcd_XhrLoadMess=$.ajax({url:i,dataType:"json",type:"GET",data:JSON.stringify({}),contentType:"application/json; charset=utf-8","async":!0,error:function(n){n.responseJSON.error.code==100&&($("#fbc_profileinfo").addClass("nonexist"),$("#fbc_chatting").addClass("nonexist"));FBM_LoadComplete(t)},success:function(n){let i=n?.messages||n;i&&i?.data&&i?.data!=""&&FBM_Render(i?.data,"fbm_content",t);FBM_GetUrlMess(i)},beforeSend:function(){$("#fbc_chatting").removeClass("nonexist");$("#fbc_profileinfo").removeClass("nonexist");FBM_LoadBefore(t)},complete:function(){}})}catch(i){FBM_LoadComplete(t)}}function FBM_GetUrlMess(n){try{let t=n?.paging;fcd_UrlMessNext=t?t?.next||"":""}catch(t){fcd_UrlMessNext=""}}function FBM_LoadBefore(n){($("#fbm_wait").removeClass("d-none"),n!=1)&&$("#fbm_content").addClass("opacity-0")}function FBM_LoadComplete(n=0){(n==0&&FBM_Scroll("bottom"),$("#fbm_wait").addClass("d-none"),n!=1)&&setTimeout(()=>{$("#fbm_content").removeClass("opacity-0")},100)}async function FBM_Render(n,t,i=0){return new Promise(()=>{var u=document.getElementById(t),r;if(u!=null){let t=0,e="",f="";if(n&&n.length>0)for(r=0;r<n.length;r++){t++;f=ConvertDateTimeToString_DOW(n[r].created_time);(t>10||r==0||e!=f)&&(u.insertAdjacentHTML("afterbegin",` <div class="d-flex my-2 text-dark align-items-center text-sm justify-content-center">
                                <div class="date text-xs">${ConvertDateTimeToString_DOW(n[r].created_time)} , ${ConvertDateTimeUTC_Time(n[r].created_time)}</div>
                            </div>`),t=0,e=f);let i=n[r],o=FBM_RenderEach(i,temp=0);u.insertAdjacentHTML("afterbegin",o)}FBM_MarkReponse();FBM_LoadComplete(i);FBM_Event()}})}function FBM_RenderEach(n,t){try{let u="",r="",f="",e="",i="usersend";if(t==0){let t=n.from;if(t.id==fb_pageid)i="pagesend";else if(n.message!=undefined){let t=n.message.replaceAll(" ","").trim();!isNaN(t)&&/\d{10}/.test(t)&&(e=`<i   data-phone="${t}" class="addprofile cursor-pointer fas fa-copy text-sm text-secondary opacity-1 text-primary position-absolute top-0 end-0"></i>`)}}else u="temp",i="pagesend";new Date((new Date).getTime()-6e5)<new Date(n.created_time)&&i=="pagesend"&&(t==0?r=`<i class="senticon far fa-check-circle"></i>`:(r=`<div class="spinner-border senticon wait text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>`,f=`<i class="fas fa-exclamation fail senticon text-danger opacity-0"></i>`));let o=FBM_RenderEachAttach(n,t);return`<div id="${n.id}" class="row blocksend ${i} ${u}" >
                    <div class="col-auto">
                        <div class="card card-plain">
                            <div class="card-body py-2 px-0 position-relative">
                                <div data-bs-toggle="tooltip" data-time="${ConvertDateTimeToTimeSpan(n.created_time)}" title="${ConvertDateTimeUTC_Time(n.created_time)}" class="con_itemsend text-dark mb-1">
                                    ${o}
                                    ${e}
                                    ${r}
                                    ${f}
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>`}catch(i){return""}}function FBM_RenderEachAttach(n,t){if(t==0){if(n.message!=undefined&&n.message!="")return`<div class="content">${n.message}</div>`;if(n.sticker!=undefined&&n.sticker!="")return`<img onerror="Master_OnLoad_Error_Image(this)" src="${n.sticker}" class="sticker"/>`;if(n.attachments!=undefined&&n.attachments.data.length>0){let t=n.attachments.data,i=[],r="",u="",f="",e="";for(let n=0;n<t.length;n++){let r=t[n].name!=undefined?t[n].name:"";t[n].mime_type.includes("image")?i.push(t[n]):t[n].mime_type.includes("audio")?u=u+`<div class="audio">
                                    <audio controls
                                        <source src="${t[n].file_url}" type="${t[n].mime_type}">
                                    </audio>
                                </div>`:t[n].mime_type.includes("video")?f=f+`<div class="video">
                                    <div class="position-relative">
                                        <img id="matfeat${t[n].id}" onerror="Master_OnLoad_Error_Image(this)" class="videofeature cursor-pointer" src="${t[n].video_data.preview_url}"/>
                                        <i data-id="${t[n].id}" class="play cursor-pointer position-absolute top-50 start-50 translate-middle fs-1 p-5 text-white far fa-play-circle"></i>
                                        <video id="matvideo${t[n].id}" controls>
                                              <source src="${t[n].video_data.url}" type="${t[n].mime_type}">
                                        </video>
                                    </div>
                                </div>`:e=e+`<div class="file">
                                    <div class="d-flex align-items-center">
                                    <i class="fas fa-arrow-circle-down pe-2 "></i>
                                        <a class="cursor-pointer text-sm" href="${t[n].file_url}">${r}</a>
                                   </div>
                                </div>`}if(i.length>0){for(let n=0;n<i.length;n++)r=r+`<div class="col-auto p-2"><img onerror="Master_OnLoad_Error_Image(this)" class="imgsend cursor-pointer" data-src="${i[n].image_data.url}" src="${i[n].image_data.url}"/></div>`;r=`<div class="image row">`+r+`</div>`}return`<div  class="media">${r}${u}${f}${e} </div>`}}else return n.message!=undefined&&n.message!=""?`<div class="content">${n.message}</div>`:`<img onerror="Master_OnLoad_Error_Image(this)" src="${n.linktemp}" class="sticker"/>`;return""}function FBM_Event(){$("#fbm_content .play").unbind("click").click(function(){let n=$(this).attr("data-id");$(this).remove();$(`#matfeat${n}`).remove();$(`#matvideo${n}`).addClass("show");$(`#matvideo${n}`).trigger("play")});$("#fbm_content .imgsend").unbind("click").click(function(){let n=$(this).attr("data-src");window.open(n)});$("#fbm_content .addprofile").unbind("click").click(function(){let n=$(this).attr("data-phone");fbm_coppied=n;$("#fbm_content .addprofile").removeClass("copied");$(this).addClass("copied")});ToolPopper()}function FBM_MarkReponse(){return new Promise(n=>{$("#fbm_content .senticonavatar").length==0&&(AjaxJWT(url="/api/FacebookBridge/MarkResponse",data=JSON.stringify({converid:fbm_conid,keypage:fb_pageid}),async=!0,success=function(n){let t=JSON.parse(n);if(t&&t.length!=0){let i=ConvertDateTimeToTimeSpan(t[0].uread_time),n=$(".blocksend.pagesend .con_itemsend");if(n)for(let t=n.length-1;t>=0;t--){let r=Number($(n[t]).attr("data-time"));if(r<=i){$(n[t]).append(`<div class="senticonavatar" style="background-image: url(${fcd_MessAvatar})"></div>`);break}}}},before=function(){}),n())})}function FBM_LoadParticulr(n,t,i,r){$.ajax({url:fl_messdetail.replace("{messid}",n),dataType:"json",type:"GET",data:JSON.stringify({}),contentType:"application/json; charset=utf-8","async":!0,error:function(){i(t)},success:function(n){n.message!=undefined?r(t,n):i(t)}})}function FBM_GetAttachmentExt(n){let t=["image","video","audio","file","template"],i=t.indexOf(n.type.split("/")[0]);return i!=-1?t[i]:"file"}function FBM_AttachmentUpload(n,t,i){return new Promise(r=>{if(!n){r({attachment_id:0,type:""});return}let f={attachment:{type:t,payload:{is_reusable:!0}}};const u=new FormData;u.append("message",JSON.stringify(f));u.append("filedata",n);$.ajax({url:fl_attachupload,data:u,cache:!1,processData:!1,contentType:!1,type:"POST",success:function(n){r({...n,type:t})},erorr:function(){FBM_SendFail(i);r({attachment_id:0,type:""})}})})}async function FBM_SendMesssage(n,t,i,r,u="RESPONSE"){FBM_SendPrepare(r,n);let e=i!=undefined&&i!=""?await FBM_AttachmentUpload(i,t,r):undefined,f={recipient:{id:fb_userid},message:{},messaging_type:u,access_token:fb_pagetoken};n!=""&&(f.message.text=n);e&&e.attachment_id!=0&&(f.message.attachment={type:t,payload:{attachment_id:e.attachment_id}});u!="RESPONSE"&&u=="MESSAGE_TAG"&&(f.tag="ACCOUNT_UPDATE");$.ajax({url:fl_sendmess,data:f,type:"POST",success:function(i){i.message_id!=undefined?FBM_SendSuccess(i.message_id,r,n,t):FBM_SendFail(r)},error:function(){FBM_SendFail(r)},beforeSend:function(){}})}function FBM_Send(){try{let t=FBM_Randomid(),n=$("#fcd_message").val().trim();if(n&&n!=""&&FBM_SendMesssage(n,type="",formdata="",t),fcd_FormFiles!=null)for(let[,n]of fcd_FormFiles.entries()){let i=FBM_GetAttachmentExt(n);FBM_SendMesssage(mess="",i,n,t)}FBM_ResetFieldInput()}catch(n){FBM_ResetFieldInput()}}function FBM_ResetFieldInput(){$("#fcd_message").val("");$("#fcd_message").height("unset");$("#fcd_fileview").html("");fcd_FormFiles=new FormData}function FBM_Randomid(){return Math.floor(Math.random()*100001).toString()+"-"+(new Date).getTime().toString()}async function FBM_SendFail(n){return new Promise(t=>{setTimeout(()=>{$("#"+n).addClass("error"),t()},10)})}async function FBM_SendSuccess(n,t,i,r){return new Promise(u=>{setTimeout(()=>{FBM_LoadParticulr(n,t,failurefunc=function(n){FBM_SendFail(n)},successfunc=function(n,t){$("#"+n).replaceWith(FBM_RenderEach(t,temp=0));FBC_Movetotop(fbm_conid);FBC_ChangeContent(fbm_conid,i,r,fb_pageid);FBM_Event();FBM_PlayTing()}),u()})})}async function FBM_PlayTing(){await new Promise(n=>{setTimeout(()=>{try{if(!document.hidden){let n=new Audio("/ting.mp3");n.play()}}catch(t){}n()})})}function FBM_SendPrepare(n,t){let i={};i.id=n;i.created_time=new Date;i.message=t;i.linktemp="/default.png";document.getElementById("fbm_content").insertAdjacentHTML("beforeEnd",FBM_RenderEach(i,temp=1));FBM_Scroll("bottom")}async function FBM_Scroll(n){return new Promise(()=>{setTimeout(()=>{var t=document.getElementById("fbm_content");switch(n){case"bottom":t.scrollIntoView({behavior:"auto",block:"end"});break;case"top":t.scrollIntoView({behavior:"auto",block:"start"})}},10)})}function FBM_FillChating(n,t){$("#fbm_staruser").attr("data-star",n);n==1?$("#fbm_staruser .fa-star").addClass("text-warning"):$("#fbm_staruser .fa-star").removeClass("text-warning");$("#fbm_hideuser").attr("data-hide",t);t==1?$("#fbm_hideuser .fa-eye").addClass("text-danger"):$("#fbm_hideuser .fa-eye").removeClass("text-danger")}function FBM_BlockAndUn(){$("#fbm_blockuser").attr("data-block")=="block"?FBM_UnBlock():FBM_Block()}async function FBM_Block(){return new Promise(n=>{$.ajax({url:fl_block,dataType:"json",type:"POST",contentType:"application/json",data:JSON.stringify({psid:fb_userid,access_token:fb_pagetoken}),contentType:"application/json; charset=utf-8","async":!0,error:function(n){n.responseJSON.error.message!=undefined&&notiError(n.responseJSON.error.message)},success:function(n){JSON.stringify(n).includes("true")?($("#fbm_blockuser").addClass("blocked"),$("#fbm_blockuser").attr("data-block","block")):notiError("Có lỗi xảy ra")},beforeSend:function(){$("#fbm_blockuser").addClass("executing")},complete:function(){$("#fbm_blockuser").removeClass("executing")}}),n()})}async function FBM_UnBlock(){return new Promise(n=>{$.ajax({url:fl_block,dataType:"json",type:"DELETE",contentType:"application/json",data:JSON.stringify({psid:fb_userid,access_token:fb_pagetoken}),contentType:"application/json; charset=utf-8","async":!0,error:function(n){n.responseJSON.error.code==100&&notiError("Không thể thao tác trên người này")},success:function(n){JSON.stringify(n).includes("true")?($("#fbm_blockuser").removeClass("blocked"),$("#fbm_blockuser").attr("data-block","")):notiError("Có lỗi xảy ra")},beforeSend:function(){$("#fbm_blockuser").addClass("executing")},complete:function(){$("#fbm_blockuser").removeClass("executing")}}),n()})}async function FBM_CheckBlock(){return new Promise(n=>{$.ajax({url:fl_checkblock.replace("{uid}",fb_userid),dataType:"json",type:"GET",data:JSON.stringify({}),contentType:"application/json; charset=utf-8","async":!0,error:function(){notiError()},success:function(n){n.data!=undefined&&n.data!=""&&n.data.length==1?($("#fbm_blockuser").addClass("blocked"),$("#fbm_blockuser").attr("data-block","block")):($("#fbm_blockuser").removeClass("blocked"),$("#fbm_blockuser").attr("data-block",""))},beforeSend:function(){$("#fbm_blockuser").addClass("executing")},complete:function(){$("#fbm_blockuser").removeClass("executing")}}),n()})}async function FBM_Typingon(){return new Promise(n=>{setTimeout(()=>{var t={recipient:{id:fb_userid.toString()},sender_action:"typing_on"};$.ajax({url:fl_actionmess,data:t,type:"POST",success:function(){},error:function(){},beforeSend:function(){}});n()},10)})}async function FBM_Markseen(){return new Promise(n=>{setTimeout(()=>{var t={recipient:{id:fb_userid.toString()},sender_action:"mark_seen"};$.ajax({url:fl_actionmess,data:t,type:"POST",success:function(){},error:function(){},beforeSend:function(){}});n()},10)})}async function FBM_Markread(n){return new Promise(t=>{AjaxJWT(url="/api/FacebookBridge/Markread",data=JSON.stringify({converid:fbm_conid,keypage:fb_pageid,status:n,content:""}),async=!0,success=function(){},before=function(){n==0?$("#con"+fbm_conid).addClass("unread"):$("#con"+fbm_conid).removeClass("unread")}),t()})}function FBM_MarkStar(){let n=0;n=$("#fbm_staruser").attr("data-star")==1?0:1;n==1?($("#star"+fbm_conid).addClass("isstar"),$("#fbm_staruser .fa-star").addClass("text-warning")):($("#star"+fbm_conid).removeClass("isstar"),$("#fbm_staruser .fa-star").removeClass("text-warning"));$("#con"+fbm_conid).attr("data-star",n);$("#fbm_staruser").attr("data-star",n);FBM_MarkStarExe(n)}async function FBM_MarkStarExe(n){return new Promise(t=>{AjaxJWT(url="/api/FacebookBridge/Star",data=JSON.stringify({converid:fbm_conid,keypage:fb_pageid,status:n,content:""}),async=!0,success=function(){}),t()})}async function MarkSent(n){return new Promise(t=>{AjaxJWT(url="/api/FacebookBridge/MarkSent",data=JSON.stringify({converid:fbm_conid,keypage:fb_pageid,status:0,content:n}),async=!0,success=function(){}),t()})}function FBM_MarkHide(){let n=0;n=$("#fbm_hideuser").attr("data-hide")==1?1:0;n==0?($("#hide"+fbm_conid).addClass("ishide"),$("#fbm_hideuser .fa-eye").addClass("text-danger"),$("#fbm_hideuser").attr("data-hide",1),$("#con"+fbm_conid).attr("data-hide",1),FBM_MarkHideExe(1)):($("#hide"+fbm_conid).removeClass("ishide"),$("#fbm_hideuser .fa-eye").removeClass("text-danger"),$("#fbm_hideuser").attr("data-hide",0),$("#con"+fbm_conid).attr("data-hide",0),FBM_MarkHideExe(0))}async function FBM_MarkHideExe(n){return new Promise(t=>{AjaxJWT(url="/api/FacebookBridge/Hide",data=JSON.stringify({converid:fbm_conid,keypage:fb_pageid,status:n,content:""}),async=!0,success=function(){}),t()})}function FBM_Exteninfo(){$("#fbc_profileinfo").hasClass("active")?($("#fbc_profileinfo").removeClass("active"),$("#fbm_userextent").html("Xem thêm")):($("#fbc_profileinfo").addClass("active"),$("#fbm_userextent").html("Thu gọn"))}function FBM_ExtenInfoAction(){$("#fbm_btncontent").toggleClass("active")}