function FBC_GetLink(n,t,i,r){fl_conver=flr_conver.replace("{version}",n).replace("{pageid}",t).replace("{action}",r!=""?`&folder=${r}`:``)+"&access_token="+i;fl_profile=flr_profile.replace("{version}",n)+"&access_token="+i;fl_avatar=flr_avatar+"&access_token="+i;fl_messlist=flr_messlist.replace("{version}",n)+"&access_token="+i;fl_messdetail=flr_messdetail.replace("{version}",n)+"&access_token="+i;fl_sendmess=flr_sendmess.replace("{version}",n).replace("{pageid}",t);fl_attachupload=flr_attachupload.replace("{version}",n)+"?access_token="+i;fl_block=flr_block.replace("{version}",n).replace("{pageid}",t);fl_checkblock=flr_checkblock.replace("{version}",n).replace("{pageid}",t)+"&access_token="+i;fl_actionmess=flr_actionmess.replace("{version}",n)+"?access_token="+i}function FBC_LoadReset(){fbl_flag=0;$("#fbf_shohide").prop("checked",!1);$("#fbf_follow").prop("checked",!1);$("#fbf_read").prop("checked",!1);$("#fbf_taglist .filter ").removeClass("active");fbl_flag=1;FBC_Load()}function FBC_Load(n=0,t=0,i="",r=0){if(fbl_flag==1){t==0&&n==0&&(fb_begindate=0,$("#fbc_list").html(""),$("#fbc_begin").removeClass("d-none"),$("#fbc_chatting").addClass("d-none"));let u=$("#fbf_shohide").is(":checked")?1:0,f=$("#fbf_follow").is(":checked")?1:0,e=$("#fbf_read").is(":checked")?1:0;fb_xhrloadconver&&fb_xhrloadconver.readyState!=4&&fb_xhrloadconver.abort();fb_xhrloadconver=AjaxJWT(url="/Api/FacebookBridge/LoadConversation",data=JSON.stringify({converid:n,pageID:fb_pageid,numBeginDate:fb_begindate,limit:fb_limit,search:i,read:e,star:f,hide:u,tagid:r}),async=!0,success=function(i){let r=JSON.parse(i);if(n!=0){if(r&&r.length!=0){let t=$("#con"+n),i=FBC_RenderEach(r[0]);t.length!=0?(t.parent().replaceWith(i),$("#con"+n).parent().slideToggle(10,function(){$(this).prependTo("#fbc_list").slideToggle(300)})):$("#fbc_list").prepend(i);FBC_Event()}}else r&&r.length!=0?(FBC_Render(r,"fbc_list"),fb_begindate=r[r.length-1]?.numUpdateTime||fb_begindate,fb_scrollstop=0):t==1?fb_scrollstop=1:($("#fbc_listemp").removeClass("d-none"),$("#fbc_list").addClass("d-none"));$("#fbc_wait").addClass("d-none");$("#fb_seachmess .fa-search").show();$("#fb_seachmess .spinner-border").hide()},before=function(){$("#fbc_wait").removeClass("d-none");$("#fbc_listemp").addClass("d-none");$("#fbc_list").removeClass("d-none")})}}function FBC_ConverReload(n=0){n&&n!=0&&FBC_Load(n,0,"",0)}function fbf_FilterExe(){FBC_Load(0,0,"",0)}async function fbf_RenderTag(n,t){new Promise(i=>{var r=document.getElementById(t),f,u;if(r!=null)for([f,u]of Object.entries(n)){let n=u,t=`
                    <li data-id="${n.ID}" class="nav-item p-2 rounded-2 filter text-start cursor-pointer w-100 my-1 ">
                          <a class="text-sm px-3  py-1 rounded-2" style="background: ${n.Color}2b; color: ${n.Color};">${n.Name}</a>
                    </li>
 
                        `;r.insertAdjacentHTML("beforeend",t)}fbf_EventTag();i()})}function fbf_FilterClose(){$("#fbc_filter").removeClass("show")}function fbf_EventTag(){$("#fbf_taglist .filter ").unbind("click").on("click",function(){let n=0;$(this).hasClass("active")?(n=0,$("#fbf_taglist .filter ").removeClass("active")):($("#fbf_taglist .filter ").removeClass("active"),$(this).addClass("active"),n=$(this).attr("data-id"));FBC_Load(0,0,"",n)})}async function FBC_Render(n,t){return new Promise(()=>{var i=document.getElementById(t);if(i!=null){if(n&&n.length>0)for(let t=0;t<n.length;t++){let r=n[t],u=FBC_RenderEach(r);i.insertAdjacentHTML("beforeend",u);FBC_TagRender(r.conserid,r.Tag)}FBC_Event()}})}function FBC_RenderEach(n){try{if($("#con"+n.conserid).length!=0)return"";let t="",i="",r="";(n.isunread==1||fb_pageid!=n.lastsender&&n.pread_time<=n.update_time)&&(t="unread");n.isstar==1&&(i=`isstar`);n.Ishide==1&&(r=`ishide`);let u=n.frompicture!=""?n.frompicture:"/default.png";return`
                 <li class="nav-item position-relative" role="presentation">
                    <a id="con${n.conserid}" data-id="${n.conserid}"
                        data-star="${n.isstar}"
                        data-tag="${n.Tag}"
                        data-hide="${n.Ishide}"
                        data-toid="${fb_pageid}"
                        data-fromid="${n.fromid}" data-name="${n.fromname}"
                        data-url="${u}" class="${t} from${n.fromid} itemmes text-sm nav-link cursor-pointer px-2">
                        <div class="d-flex conitem">
                            <div class="position-relative">
                                <i id="hide${n.conserid}" class="fas ms-n2 fa-eye fs-6 position-absolute opacity-0 text-danger ${r}"></i>
                                 <img data-fromid="${n.fromid}" data-id="${n.conserid}" class="proavatar   border border-1  " onerror="Master_OnLoad_Error_Image(this)" src="${u}" alt="label-image" />
                            </div>
                            <div  class="ms-2">
                                <h6 class="name text-sm mb-0 ellipsis_one_line">${n.fromname}</h6>
                                <div class="mt-0 d-flex text-secondary align-items-center">
                                    ${fb_pageid==n.lastsender?`<span id="psend${n.conserid}" class="psend${n.fromid} pe-1">Bạn:</span>`:``}
                                    <div id="snip${n.conserid}" class="snip${n.fromid} content twoline">${n.snippet}</div>
                                   
                                </div>
                                <div id="tag${n.conserid}" class="d-flex mt-1">
                                    
                                </div>
                            </div>
                            <div class="ms-auto ps-0 width-48-px text-end">
                                <span class="text-xs fst-italic time">${ConvertDateTimeUTC_NoYear(n.update_time)}</span>
                                <div class="d-flex align-items-center position-relative mt-2">
                                    <i id="star${n.conserid}" class="fas fa-star fs-6 ms-auto opacity-0 text-warning ${i}"></i>
                                    <div class="circle badge badge-xs badge-circle bg-gradient-success p-0 d-none ms-auto"><span></span></div>
                                </div>
                                 
                                
                            </div>
                        </div>
                    </a>
                    <hr class="horizontal dark my-0 opacity-2">
                </li>
            `}catch(t){return""}}function FBC_RenderEachAttach(n){if(n.message!=undefined&&n.message!="")return`<span class="twoline">${n.message}</span>`;if(n.sticker!=undefined&&n.sticker!="")return`<img src="${n.sticker}" class="avatar avatar-xs"/>`;if(n.attachments!=undefined&&n.attachments.data[0]!=undefined){let t=n.attachments.data[0],i=t.name!=undefined?t.name:"";return t.mime_type.includes("image")?`<i class="text-primary fas fa-image pe-1"></i> Gửi hình ảnh`:t.mime_type.includes("audio")?`<i class="text-primary fas fa-volume-up pe-1"></i>${i}`:t.mime_type.includes("video")?`<i class="text-primary fas fa-video pe-1"></i>${i}`:`<i class="far fa-file-alt pe-2"></i>${i}`}return""}async function FBC_TagRender(n,t){return new Promise(()=>{let i=document.getElementById("tag"+n);if(i!=null){i.innerHTML="";let e=t.split("t"),r=[],o=2,f=0,u="";for(let n=0;n<e.length;n++)e[n]!=""&&r.push(e[n]);for(ii=0;ii<r.length;ii++)if(f=f+1,f<=o){let n=fb_fbtag[r[ii]];n!=undefined&&n!=""&&(u=u+`<div class="contag text-sm me-1 rounded-2" title="${n.Name}"  style="background: ${n.Color}2b; color: ${n.Color};">
                        ${n.Name}
                    </div>`)}else{let t="";for(k=o;k<r.length;k++){let n=fb_fbtag[r[k]];t=t+`<div class="contag text-sm me-1 rounded-2" title="${n.Name}"  style="background: ${n.Color}2b; color: ${n.Color};">
                                ${n.Name} </div>`}u=u+`<div class="position-relative d-inline ps-0">
                            <a class="contag my-1"  data-bs-toggle="collapse" href="#tagmore${n}" role="button" aria-expanded="false" aria-controls="collapseExample" style="background: #bdbdbd29;color: #000000;" >
                                + ${r.length-f+1} tags
                            </a>
                            <div class="collapse position-absolute z-index-4 end-1 more top-100 mt-2" id="tagmore${n}" style="min-width: 250px; z-index: 1000;">
                                <div class="card card-body shadow-lg">
                                    ${t}
                                </div>
                            </div>
                        </div>`;break}i.innerHTML=u}})}async function FBC_GetAvatar(){return new Promise(()=>{$("#fbc_list .proavatar").each(function(){let t=$(this).attr("data-id"),i=$(this).attr("data-fromid"),n=fl_avatar.replace("{uid}",i);$(this).attr("src",n);$("#con"+t).attr("data-url",n)})})}function FBC_Event(){$("#fbc_list .itemmes").unbind("click").click(function(){$("#fbc_list .itemmes").removeClass("active");$(this).addClass("active");fbm_conid=$(this).attr("data-id");let n=$(this).attr("data-fromid"),t=$(this).attr("data-toid");fb_userid=n==fb_pageid?t:n;FMB_Ini(fbm_conid,$(this).attr("data-name"),$(this).attr("data-url"));$("#fbc_begin").addClass("d-none");$("#fbc_chatting").removeClass("d-none");$("#fbc_chatlistmaster").removeClass("active");let i=$(this).attr("data-star"),r=$(this).attr("data-hide");fb_currentag=$(this).attr("data-tag");PInfo_Ini();typeof FBM_FillChating=="function"&&FBM_FillChating(i,r);typeof FBM_Markseen=="function"&&FBM_Markseen();typeof FBM_Markread=="function"&&FBM_Markread(isread=1);typeof FBM_ResetFieldInput=="function"&&FBM_ResetFieldInput()})}async function FBC_Movetotop(n){return new Promise(()=>{$("#con"+n).prependTo("#fbc_list")})}async function FBC_ChangeContent(n,t,i,r){return new Promise(()=>{switch(i){case"":$("#snip"+n).html(t);break;default:$("#snip"+n).html("Gửi file")}r==fb_pageid?$("#psend"+n).removeClass("d-none"):$("#psend"+n).addClass("d-none")})}